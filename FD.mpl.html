<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>Finite Difference Toolkit in Maple</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="maple">
<meta name="settings" content="use_css,pre_wrap,no_foldcolumn,expand_tabs,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; border-style:dashed; border-width:1px; padding:6px }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
.Comment { color: #5050cf;}
.Constant { color: #bf3030; }
.Special { color: #ff40ff; }
.Statement { color: #009900; }
.Type { color: #00ff00; }
-->
</style>

<script type='text/javascript'>
<!--

-->
</script>
</head>
<body>
<pre id='vimCodeElement'>
<span class="Comment">#------------------------------------------------------------------------------</span>
<span class="Comment"># A Finite Difference Toolkit in Maple</span>
<span class="Comment">#</span>
<span class="Comment"># See: <a href="http://laplace.physics.ubc.ca/People/arman/FD_doc/">http://laplace.physics.ubc.ca/People/arman/FD_doc/</a> </span>
<span class="Comment"># for the documentation of the project</span>
<span class="Comment">#</span>
<span class="Comment"># &copy; Arman Akbarian &lt;arman@phas.ubc.ca&gt;</span>
<span class="Comment">#</span>
<span class="Comment"># Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</span>
<span class="Comment"># <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">http://creativecommons.org/licenses/by-nc-sa/3.0/</a></span>
<span class="Comment">#-----------------------------------------------------------------------------</span>

<span class="Comment">###################################################################</span>
<span class="Comment"># Applies a single stencil operation (equivalent to a derivative)</span>
<span class="Comment"># to a given function</span>
<span class="Comment"># Example:</span>
<span class="Comment">#        INPUT: expr     = f(t,x,z)</span>
<span class="Comment">#               var_name = x</span>
<span class="Comment">#               var_index = 2</span>
<span class="Comment">#               stencil_coeff = [-1/hx,1/hx]</span>
<span class="Comment">#               points = [0,1]</span>
<span class="Comment">#               stepsize = hx</span>
<span class="Comment">#        OUTPUT:</span>
<span class="Comment">#                -1/hx*f(t,x,y,z) + 1/hx*f(t,x+hx,y,z)  </span>
<span class="Comment">#             (equivalent to first forward derivative of x)</span>
<span class="Comment">#</span>
<span class="Comment">###################################################################</span>

Apply_Stencil_Single <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>expr<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var_name<span class="Special">::</span>symbol<span class="Special">,</span>var_index<span class="Special">::</span>integer<span class="Special">,</span>stencil_coeff<span class="Special">::</span>list<span class="Special">,</span>points<span class="Special">::</span>list<span class="Special">,</span>stepsize<span class="Special">::</span>symbol<span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">)</span>

   <span class="Statement">local</span> deriv_FD<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">;</span>

   <span class="Statement">if</span> discretized <span class="Statement">then</span>
      <span class="Statement">return</span> Apply_Stencil_Single_D<span class="Special">(</span>expr<span class="Special">,</span>var_name<span class="Special">,</span>var_index<span class="Special">,</span>stencil_coeff<span class="Special">,</span>points<span class="Special">,</span>stepsize<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>expr<span class="Special">,</span>var_name<span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">return</span> expr<span class="Special">;</span>
   <span class="Statement">else</span>
      deriv_FD<span class="Special">:=</span><span class="Constant">0</span><span class="Special">;</span>

      <span class="Statement">if</span> <span class="Special">(</span><span class="Statement">nops</span><span class="Special">(</span>stencil_coeff<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>points<span class="Special">)</span> <span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Stencil Coefficient do not match to points!&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

      deriv_FD <span class="Special">:=</span> <span class="Statement">add</span><span class="Special">(</span>stencil_coeff<span class="Special">[</span>ii<span class="Special">]</span>*<span class="Statement">subsop</span><span class="Special">(</span>var_index<span class="Statement">=</span>var_name+points<span class="Special">[</span>ii<span class="Special">]</span>*stepsize<span class="Special">,</span>expr<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>points<span class="Special">))</span><span class="Special">;</span>
      <span class="Statement">return</span> <span class="Statement">simplify</span><span class="Special">(</span>deriv_FD<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


Apply_Stencil_Single_D<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>expr<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var_name<span class="Special">::</span>symbol<span class="Special">,</span>var_index<span class="Special">::</span>integer<span class="Special">,</span>stencil_coeff<span class="Special">::</span>list<span class="Special">,</span> points<span class="Special">::</span>list<span class="Special">(</span>integer<span class="Special">)</span><span class="Special">,</span>stepsize<span class="Special">::</span>symbol<span class="Special">)</span>

   <span class="Statement">local</span> deriv_FD<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">;</span>
   <span class="Statement">global</span> index_table<span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">assigned</span><span class="Special">(</span>index_table<span class="Special">[</span>var_name<span class="Special">]))</span> <span class="Statement">then</span>
       <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Index table is not assigned for var %a, call Make_FD()\n&quot;</span><span class="Special">,</span>var_name<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid initialization&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>expr<span class="Special">,</span>var_name<span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">return</span> expr<span class="Special">;</span>
   <span class="Statement">else</span>
      deriv_FD<span class="Special">:=</span><span class="Constant">0</span><span class="Special">;</span>

      <span class="Statement">if</span> <span class="Special">(</span><span class="Statement">nops</span><span class="Special">(</span>stencil_coeff<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>points<span class="Special">)</span> <span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Stencil Coefficient do not match to points!&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      deriv_FD <span class="Special">:=</span> <span class="Statement">add</span><span class="Special">(</span>stencil_coeff<span class="Special">[</span>ii<span class="Special">]</span>*<span class="Statement">subsop</span><span class="Special">(</span>var_index<span class="Statement">=</span>index_table<span class="Special">[</span>var_name<span class="Special">]</span>+points<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>expr<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>points<span class="Special">))</span><span class="Special">;</span>
      <span class="Statement">return</span> <span class="Statement">simplify</span><span class="Special">(</span>deriv_FD<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">############################################################################################</span>
<span class="Comment"># Applies an stencil operator equivalent to a differential operator</span>
<span class="Comment"># of one variable, to a function name.</span>
<span class="Comment">#</span>
<span class="Comment">#  EXAMPLE:  differential operator = d/dx(d/dx(f)) </span>
<span class="Comment">#</span>
<span class="Comment">#   INPUT: expr = f(t,x,y,z)                     // function name</span>
<span class="Comment">#          var_name=x                            // differential variable</span>
<span class="Comment">#          var_index=2                           // index of x</span>
<span class="Comment">#          points = [-1,0,1]                     // points which are used to to the FD</span>
<span class="Comment">#          stencil_coeff = [1/h^2,-2/h^2,1/h^2]  //the coefficinet of the stencil in the FD</span>
<span class="Comment">#          stepsize= h                           //size of grid</span>
<span class="Comment">#</span>
<span class="Comment">#   OUTPUT: ( f(t,x-h,y,z)-2*f(t,x,y,z)+f(t,x+h,y,z) ) / h^2</span>
<span class="Comment">############################################################################################</span>

Apply_Stencil <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>expr<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var_name<span class="Special">::</span>symbol<span class="Special">,</span>var_index<span class="Special">::</span>integer<span class="Special">,</span> stencil_coeff<span class="Special">::</span>list<span class="Special">,</span>points<span class="Special">::</span>list<span class="Special">,</span>stepsize<span class="Special">::</span>symbol<span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">)</span>

   <span class="Statement">local</span> deriv_FD<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">;</span>
   <span class="Statement">if</span> <span class="Special">(</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>expr<span class="Special">)</span> <span class="Statement">=</span><span class="Constant">`+`</span> <span class="Special">)</span> <span class="Statement">then</span>

     deriv_FD<span class="Special">:=</span><span class="Constant">0</span><span class="Special">;</span>
     <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>expr<span class="Special">)</span> <span class="Statement">do</span>
        deriv_FD<span class="Special">:=</span> deriv_FD + Apply_Stencil<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>expr<span class="Special">)</span><span class="Special">,</span>var_name<span class="Special">,</span>var_index<span class="Special">,</span>stencil_coeff<span class="Special">,</span>points<span class="Special">,</span>stepsize<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
     <span class="Statement">return</span> <span class="Statement">simplify</span><span class="Special">(</span>deriv_FD<span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">elif</span> <span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>expr<span class="Special">)</span> <span class="Statement">=</span> <span class="Constant">`*`</span><span class="Special">)</span> <span class="Statement">then</span>

     deriv_FD <span class="Special">:=</span> <span class="Constant">1</span><span class="Special">;</span>
     <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>expr<span class="Special">)</span> <span class="Statement">do</span>
        deriv_FD <span class="Special">:=</span> deriv_FD*Apply_Stencil<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>expr<span class="Special">)</span><span class="Special">,</span>var_name<span class="Special">,</span>var_index<span class="Special">,</span>stencil_coeff<span class="Special">,</span>points<span class="Special">,</span>stepsize<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

     <span class="Statement">return</span> <span class="Statement">simplify</span><span class="Special">(</span>deriv_FD<span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">elif</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>expr<span class="Special">,</span>var_name<span class="Special">))</span> <span class="Statement">then</span>

      <span class="Statement">return</span> expr<span class="Special">;</span>

   <span class="Statement">else</span>

      <span class="Statement">return</span> Apply_Stencil_Single<span class="Special">(</span>expr<span class="Special">,</span>var_name<span class="Special">,</span>var_index<span class="Special">,</span>stencil_coeff<span class="Special">,</span>points<span class="Special">,</span>stepsize<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">#########################################################</span>
<span class="Comment"># Does not calculate stencils that have been calculated</span>
<span class="Comment"># before, uses all_stencils table to find that. </span>
<span class="Comment"># for optimization purposes.</span>
<span class="Comment"># #######################################################</span>

Calc_Stencil <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>diff_order<span class="Special">,</span>stepsize<span class="Special">,</span>points<span class="Special">,</span>usetable<span class="Special">)</span>


  <span class="Statement">global</span> all_stencils<span class="Special">;</span>
  <span class="Statement">local</span> new_sten<span class="Special">;</span>
  <span class="Statement">local</span> tmp_sten<span class="Special">;</span>
  <span class="Statement">global</span> h<span class="Special">;</span>
  <span class="Statement">local</span> ii<span class="Special">;</span>

  <span class="Statement">if</span> <span class="Special">(</span>usetable<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>all_stencils<span class="Special">[[</span>diff_order<span class="Special">,</span>points<span class="Special">]])</span> <span class="Statement">then</span>
           tmp_sten<span class="Special">:=</span>all_stencils<span class="Special">[[</span>diff_order<span class="Special">,</span>points<span class="Special">]]</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Special">[[</span><span class="Statement">seq</span><span class="Special">(</span> <span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>tmp_sten<span class="Special">[</span><span class="Constant">1</span><span class="Special">]))</span><span class="Special">,</span><span class="Statement">eval</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>tmp_sten<span class="Special">[</span><span class="Constant">1</span><span class="Special">]))</span><span class="Special">,</span>h<span class="Statement">=</span>stepsize<span class="Special">)]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>tmp_sten<span class="Special">[</span><span class="Constant">1</span><span class="Special">]))</span> <span class="Special">]</span><span class="Special">,</span>tmp_sten<span class="Special">[</span><span class="Constant">2</span><span class="Special">]]</span><span class="Special">;</span>
        <span class="Statement">else</span>
          new_sten<span class="Special">:=</span>Calc_Stencil_L<span class="Special">(</span>diff_order<span class="Special">,</span>h<span class="Special">,</span>points<span class="Special">)</span><span class="Special">;</span>
          all_stencils<span class="Special">[[</span>diff_order<span class="Special">,</span>points<span class="Special">]]</span><span class="Special">:=</span>new_sten<span class="Special">;</span>
          <span class="Statement">return</span> <span class="Special">[[</span> <span class="Statement">seq</span><span class="Special">(</span> <span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>new_sten<span class="Special">[</span><span class="Constant">1</span><span class="Special">]))</span><span class="Special">,</span><span class="Statement">eval</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>new_sten<span class="Special">[</span><span class="Constant">1</span><span class="Special">]))</span><span class="Special">,</span>h<span class="Statement">=</span>stepsize<span class="Special">)]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>new_sten<span class="Special">[</span><span class="Constant">1</span><span class="Special">]))]</span><span class="Special">,</span>new_sten<span class="Special">[</span><span class="Constant">2</span><span class="Special">]]</span> <span class="Special">;</span>

        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
  <span class="Statement">else</span>
    <span class="Statement">return</span> Calc_Stencil_L<span class="Special">(</span>diff_order<span class="Special">,</span>stepsize<span class="Special">,</span>points<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#####################################################################</span>
<span class="Comment"># Generate a finite differencing expression for a single</span>
<span class="Comment"># differential expression using given points.</span>
<span class="Comment">#</span>
<span class="Comment">#   Example:  d^2f/dx^2</span>
<span class="Comment">#</span>
<span class="Comment">#     INPUT:</span>
<span class="Comment">#         diff_ord = 2 </span>
<span class="Comment">#         points:=[-1,0,1]</span>
<span class="Comment">#         stepsize:=h</span>
<span class="Comment">#</span>
<span class="Comment">#     Result:</span>
<span class="Comment">#        ( f(x-h,x) - 2*f(t,x) + f(t+h,x) )  / h^2</span>
<span class="Comment">#</span>
<span class="Comment">#     OUTPUT: (as table)</span>
<span class="Comment">#        [ [-1,1/h^2] , [0,-2/h^2], [1,1/h^2] ] </span>
<span class="Comment">######################################################################</span>


Calc_Stencil_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>diff_order<span class="Special">,</span>stepsize<span class="Special">,</span>points<span class="Special">,</span><span class="Special">{</span>showorder<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>showerror<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

   <span class="Statement">local</span> f_expr<span class="Special">,</span>func<span class="Special">,</span>r<span class="Special">,</span>var<span class="Special">,</span>N<span class="Special">,</span>a<span class="Special">,</span>ans<span class="Special">,</span>stencil<span class="Special">,</span>Error<span class="Special">,</span>params<span class="Special">,</span>terms<span class="Special">,</span>Degree<span class="Special">,</span>ii<span class="Special">,</span>b<span class="Special">,</span>stencil_table<span class="Special">;</span>
   var <span class="Special">:=</span> <span class="Statement">'x'</span><span class="Special">;</span>
   func <span class="Special">:=</span><span class="Statement">'f'</span><span class="Special">;</span>
   f_expr <span class="Special">:=</span> func<span class="Special">(</span>var<span class="Special">)</span><span class="Special">;</span>
   N <span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>points<span class="Special">)</span><span class="Special">;</span>
   r<span class="Special">:=</span> <span class="Constant">1</span><span class="Special">;</span>
   stencil<span class="Special">:=</span><span class="Statement">add</span><span class="Special">(</span>a<span class="Special">[</span>points<span class="Special">[</span>ii<span class="Special">]]</span>*<span class="Statement">subsop</span><span class="Special">(</span>r<span class="Statement">=</span>var+points<span class="Special">[</span>ii<span class="Special">]</span>*stepsize<span class="Special">,</span>f_expr<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)</span><span class="Special">;</span>
   Error<span class="Special">:=</span><span class="Statement">D</span><span class="Special">[</span>r$diff_order<span class="Special">](</span>func<span class="Special">)(</span>var<span class="Special">)</span>-stencil<span class="Special">;</span>
   Error<span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span><span class="Statement">series</span><span class="Special">(</span>Error<span class="Special">,</span>stepsize<span class="Special">,</span>N<span class="Special">)</span><span class="Special">,</span><span class="Statement">polynom</span><span class="Special">)</span><span class="Special">;</span>
   params<span class="Special">:=</span><span class="Special">{</span><span class="Statement">seq</span><span class="Special">(</span>a<span class="Special">[</span>points<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)}</span><span class="Special">;</span>
   terms<span class="Special">:=</span><span class="Statement">indets</span><span class="Special">(</span>Error<span class="Special">)</span> <span class="Statement">minus</span> <span class="Special">{</span>var<span class="Special">}</span> <span class="Statement">minus</span> params <span class="Statement">minus</span><span class="Special">{</span>stepsize<span class="Special">}</span><span class="Special">;</span>
   Error <span class="Special">:=</span> <span class="Statement">collect</span><span class="Special">(</span>Error<span class="Special">,</span> terms<span class="Special">,</span> distributed<span class="Special">)</span><span class="Special">;</span>
   ans <span class="Special">:=</span> <span class="Statement">solve</span><span class="Special">({</span><span class="Statement">coeffs</span><span class="Special">(</span>Error<span class="Special">,</span> terms<span class="Special">)}</span><span class="Special">,</span> params<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">if</span> <span class="Special">(</span>ans <span class="Statement">=</span><span class="Special">NULL</span><span class="Special">)</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Failed to find FDA coefficients, check FD_table content!&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   stencil <span class="Special">:=</span> <span class="Statement">subs</span><span class="Special">(</span>ans<span class="Special">,</span>stencil<span class="Special">)</span><span class="Special">;</span>

   Error<span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span><span class="Statement">series</span><span class="Special">(</span><span class="Statement">leadterm</span><span class="Special">(</span><span class="Statement">D</span><span class="Special">[</span>r$diff_order<span class="Special">](</span>func<span class="Special">)(</span>var<span class="Special">)</span>-stencil<span class="Special">)</span><span class="Special">,</span>stepsize<span class="Special">,</span>N<span class="Constant">+20</span><span class="Special">)</span><span class="Special">,</span><span class="Statement">polynom</span><span class="Special">)</span><span class="Special">;</span>

   Degree<span class="Special">:=</span><span class="Statement">degree</span><span class="Special">(</span>Error<span class="Special">,</span>stepsize<span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Special">(</span>showorder<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;This stencil is of order: %a\n&quot;</span><span class="Special">,</span>Degree<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Special">(</span>showerror<span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;The leading order term in the error is:\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">print</span><span class="Special">(</span>Error<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   b<span class="Special">:=</span> <span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>a<span class="Special">[</span>points<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)]</span><span class="Special">;</span>
   b<span class="Special">:=</span><span class="Statement">subs</span><span class="Special">(</span>ans<span class="Special">,</span>b<span class="Special">)</span><span class="Special">;</span>
   stencil_table<span class="Special">:=</span><span class="Special">[</span><span class="Statement">seq</span><span class="Special">([</span>points<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>b<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)]</span><span class="Special">;</span>
   <span class="Statement">return</span> <span class="Special">[</span>stencil_table<span class="Special">,</span>Degree<span class="Special">]</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">################################################################</span>
<span class="Comment"># A way of creating differential table</span>
<span class="Comment"># for given mixed derivative differential operator</span>
<span class="Comment">#  EXAMPLE:</span>
<span class="Comment">#   </span>
<span class="Comment">#   INPUT: diff(g[1,2](t,x,y,z),x,x,z);</span>
<span class="Comment">#</span>
<span class="Comment">#   OUTPUT:</span>
<span class="Comment">#       f = g[1,2]</span>
<span class="Comment">#       vars = [t,x,y,z]</span>
<span class="Comment">#       difftable = [[2,2],[4,1]] </span>
<span class="Comment">#   (reads from FD_table &amp; stepsize_table)</span>
<span class="Comment">#       points_table =  [[-1,0,1],[0,1]]</span>
<span class="Comment">#       stepsizes =  [hx,hz]        </span>
<span class="Comment">#    if notable enabled, ignores the FD_table and stepsize_table</span>
<span class="Comment">################################################################</span>

Extract_FD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>F<span class="Special">,</span><span class="Special">{</span>notable<span class="Special">:=</span><span class="Constant">true</span><span class="Special">})</span>

   <span class="Statement">global</span> FD_table<span class="Special">;</span>
   <span class="Statement">global</span> variable_set<span class="Special">;</span>
   <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
   <span class="Statement">local</span> diff_eqn<span class="Special">,</span>varseq<span class="Special">,</span>vars<span class="Special">,</span>varset<span class="Special">,</span>nvars<span class="Special">,</span>n<span class="Special">,</span>f<span class="Special">,</span>ii<span class="Special">;</span>
   <span class="Statement">local</span> pt_tbl<span class="Special">,</span>stp_tbl<span class="Special">;</span>
   <span class="Statement">local</span> ewk<span class="Special">,</span>jj<span class="Special">;</span>
   <span class="Statement">local</span> D_ind_var_set<span class="Special">,</span>D_var<span class="Special">,</span>D_var_name<span class="Special">,</span>D_var_ord<span class="Special">,</span>tot_D_var_num<span class="Special">,</span>diff_table<span class="Special">;</span>
   <span class="Statement">local</span> tmp_tbls<span class="Special">,</span>tmp_indx<span class="Special">;</span>



   <span class="Statement">if</span> <span class="Special">(</span> <span class="Statement">type</span><span class="Special">(</span>F<span class="Special">,</span>symbol<span class="Special">)</span> <span class="Statement">or</span> <span class="Statement">type</span><span class="Special">(</span>F<span class="Special">,</span>numeric<span class="Special">)</span> <span class="Special">)</span> <span class="Statement">then</span>
      <span class="Statement">if</span> notable <span class="Statement">then</span>
         <span class="Statement">return</span>  F<span class="Special">,</span> <span class="Special">[]</span><span class="Special">,</span><span class="Constant">0</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">;</span>
      <span class="Statement">else</span>
         <span class="Statement">return</span> F<span class="Special">,</span> <span class="Special">[]</span><span class="Special">,</span><span class="Constant">0</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Type">PDEtools</span><span class="Special">[</span>difforder<span class="Special">](</span>F<span class="Special">)</span> <span class="Statement">=</span> <span class="Constant">0</span> <span class="Statement">then</span>

      <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;***WARNING*** Extract_FD is called for %a\n&quot;</span><span class="Special">,</span>F<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">if</span> notable <span class="Statement">then</span>
         <span class="Statement">return</span>  <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>F<span class="Special">)</span><span class="Special">,</span> <span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>F<span class="Special">)]</span><span class="Special">,</span><span class="Constant">0</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">;</span>
      <span class="Statement">else</span>
         <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>F<span class="Special">)</span><span class="Special">,</span> <span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>F<span class="Special">)]</span><span class="Special">,</span><span class="Constant">0</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">,</span><span class="Special">[]</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span><span class="Statement">convert</span><span class="Special">(</span>F<span class="Special">,</span><span class="Statement">diff</span><span class="Special">))</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">`diff`</span><span class="Special">)</span> <span class="Statement">then</span>

      <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Extract_FD cannot identify this differential expression:\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">print</span><span class="Special">(</span>F<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid argument&quot;</span><span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   diff_eqn <span class="Special">:=</span> <span class="Statement">convert</span><span class="Special">(</span>F<span class="Special">,</span><span class="Statement">D</span><span class="Special">)</span><span class="Special">;</span>
   varseq <span class="Special">:=</span> <span class="Statement">op</span><span class="Special">(</span>diff_eqn<span class="Special">)</span><span class="Special">;</span>


   vars <span class="Special">:=</span> <span class="Special">[</span>varseq<span class="Special">]</span><span class="Special">;</span>
   nvars <span class="Special">:=</span> <span class="Statement">nops</span><span class="Special">(</span>vars<span class="Special">)</span><span class="Special">;</span>

   varset<span class="Special">:=</span><span class="Special">{</span>varseq<span class="Special">}</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>notable<span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">assigned</span><span class="Special">(</span>variable_set<span class="Special">))</span> <span class="Statement">then</span>
             <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;variable set is not defined, call Make_FD()&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

         <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>varset <span class="Statement">subset</span> variable_set<span class="Special">)</span> <span class="Statement">then</span>
            <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Warning, in expression:\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">print</span><span class="Special">(</span>F<span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Variables are not same as defined variables\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   n<span class="Special">:=</span><span class="Type">PDEtools</span><span class="Special">[</span>difforder<span class="Special">](</span>diff_eqn<span class="Special">)</span><span class="Special">;</span>

   f<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>diff_eqn<span class="Special">))</span><span class="Special">;</span>

   D_ind_var_set<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>
   jj<span class="Special">:=</span><span class="Constant">0</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>vars<span class="Special">)</span> <span class="Statement">do</span>
     ewk<span class="Special">:=</span><span class="Type">PDEtools</span><span class="Special">[</span>difforder<span class="Special">](</span>diff_eqn<span class="Special">,</span>vars<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
     <span class="Statement">if</span> ewk <span class="Statement">&lt;&gt;</span> <span class="Constant">0</span> <span class="Statement">then</span>
        jj<span class="Special">:=</span>jj<span class="Constant">+1</span><span class="Special">;</span>
        D_ind_var_set<span class="Special">:=</span>D_ind_var_set<span class="Special">,</span>ii<span class="Special">;</span>
        D_var<span class="Special">[</span>jj<span class="Special">]</span><span class="Special">:=</span>ii<span class="Special">;</span>
        D_var_name<span class="Special">[</span>jj<span class="Special">]</span><span class="Special">:=</span>vars<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
        D_var_ord<span class="Special">[</span>jj<span class="Special">]</span><span class="Special">:=</span>ewk<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   D_ind_var_set<span class="Special">:=</span><span class="Special">{</span>D_ind_var_set<span class="Special">}</span><span class="Special">;</span>

   tot_D_var_num<span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>D_ind_var_set<span class="Special">)</span><span class="Special">;</span>


  diff_table<span class="Special">:=</span><span class="Special">[</span><span class="Statement">seq</span><span class="Special">([</span>D_var<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>D_var_ord<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>tot_D_var_num<span class="Special">)]</span><span class="Special">;</span>

  <span class="Statement">if</span> <span class="Special">(</span> notable <span class="Special">)</span> <span class="Statement">then</span>
    <span class="Statement">return</span> f<span class="Special">,</span>vars<span class="Special">,</span>n<span class="Special">,</span>diff_table<span class="Special">;</span>
  <span class="Statement">else</span>

  pt_tbl <span class="Special">:=</span> <span class="Special">NULL</span><span class="Special">;</span>
  stp_tbl <span class="Special">:=</span> <span class="Special">NULL</span><span class="Special">;</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>diff_table<span class="Special">)</span> <span class="Statement">do</span>
    <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>FD_table<span class="Special">[</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]]])</span> <span class="Statement">then</span>
      tmp_tbls<span class="Special">:=</span>FD_table<span class="Special">[</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]]]</span><span class="Special">;</span>
      tmp_indx<span class="Special">:=</span><span class="Constant">1</span>+diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
      <span class="Statement">if</span> <span class="Special">(</span><span class="Statement">nops</span><span class="Special">(</span>tmp_tbls<span class="Special">)</span> <span class="Statement">&lt;</span> tmp_indx <span class="Special">)</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;cannot find points from FD_table for a derivative&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      pt_tbl<span class="Special">:=</span>pt_tbl <span class="Special">,</span> FD_table<span class="Special">[</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]]][</span><span class="Constant">1</span>+diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">2</span><span class="Special">]]</span><span class="Special">;</span>
    <span class="Statement">else</span>
      <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Cannot find points for variable:\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">print</span><span class="Special">(</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]])</span><span class="Special">;</span>
      <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Check the content of FD_table[%a]&quot;</span><span class="Special">,</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]])</span><span class="Special">;</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Aborting!&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>stepsize_table<span class="Special">[</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]]])</span> <span class="Statement">then</span>
      stp_tbl<span class="Special">:=</span>stp_tbl <span class="Special">,</span> stepsize_table<span class="Special">[</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]]]</span> <span class="Special">;</span>
    <span class="Statement">else</span>
      <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Cannot find stepsize for variable:\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">print</span><span class="Special">(</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]])</span><span class="Special">;</span>
      <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Check the content of stepsize_table[%a]\n&quot;</span><span class="Special">,</span>vars<span class="Special">[</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]])</span><span class="Special">;</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Aborting!&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

  <span class="Statement">return</span> f<span class="Special">,</span>vars<span class="Special">,</span>n<span class="Special">,</span>diff_table<span class="Special">,</span><span class="Special">[</span>pt_tbl<span class="Special">]</span><span class="Special">,</span><span class="Special">[</span>stp_tbl<span class="Special">]</span><span class="Special">;</span>

  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>
<span class="Comment">#########################################</span>
<span class="Comment"># Special case of Stencil, stepsize is h</span>
<span class="Comment">#########################################</span>

Sten <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>F<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>points<span class="Special">::</span>list<span class="Special">(</span>numeric<span class="Special">))</span>

    <span class="Statement">global</span> h<span class="Special">;</span>
    <span class="Statement">return</span> Stencil<span class="Special">(</span>F<span class="Special">,</span><span class="Special">[</span>points<span class="Special">]</span><span class="Special">,</span><span class="Special">[</span>h<span class="Special">])</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###############################################################</span>
<span class="Comment"># Special case of Gen_Sten_Multi_Var, does not use FD_table</span>
<span class="Comment"># returns stencil using the given argument points and stepsize</span>
<span class="Comment"># works only for single expresson</span>
<span class="Comment"># #############################################################</span>

Stencil <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>F<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span> points_table<span class="Special">::</span>list<span class="Special">(</span>list<span class="Special">(</span>numeric<span class="Special">))</span><span class="Special">,</span> stepsize_table<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span><span class="Special">{</span>discretized<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

     <span class="Statement">if</span> <span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span><span class="Statement">convert</span><span class="Special">(</span>F<span class="Special">,</span><span class="Statement">diff</span><span class="Special">))</span><span class="Statement">&lt;&gt;</span><span class="Constant">`diff`</span><span class="Special">)</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid differential argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">return</span> Gen_Sten_Multi_Var<span class="Special">(</span>Extract_FD<span class="Special">(</span>F<span class="Special">)</span><span class="Special">,</span>points_table<span class="Special">,</span>stepsize_table<span class="Special">,</span>discretized<span class="Special">)[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">##################################################################</span>
<span class="Comment"># Generates the FDA for multivariable</span>
<span class="Comment"># mixed derivative single expression</span>
<span class="Comment"># Example: </span>
<span class="Comment">#         INPUT: F = diff(f(t,x,y),x,x,y) </span>
<span class="Comment">#                points_table = [ [-1,0,1], [-1,1] ]</span>
<span class="Comment">#                stepsize_table = [hx,hy]</span>
<span class="Comment">#          </span>
<span class="Comment">#         OUTPUT:</span>
<span class="Comment">#           1/2 (-f(x - hx, y - hy) + f(x - hx, y + hy) </span>
<span class="Comment">#                + 2 f(x, y - hy)   - 2 f(x, y + hy) </span>
<span class="Comment">#                - f(x + hx, y - hy)+ f(x + hx, y + hy)</span>
<span class="Comment">#                )/(hy hx )</span>
<span class="Comment">##################################################################</span>

Gen_Sten_Multi_Var <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>f<span class="Special">::</span>name<span class="Special">,</span>vars<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>n<span class="Special">::</span>integer<span class="Special">,</span>diff_table<span class="Special">::</span>list<span class="Special">(</span>list<span class="Special">(</span>integer<span class="Special">))</span><span class="Special">,</span>points_table<span class="Special">::</span>list<span class="Special">(</span>list<span class="Special">(</span>numeric<span class="Special">))</span><span class="Special">,</span>stepsize_table<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span><span class="Special">{</span>usetable<span class="Special">:=</span><span class="Constant">false</span><span class="Special">}</span><span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">)</span>

    <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">,</span>var_index<span class="Special">,</span>var_name<span class="Special">,</span>stepsize<span class="Special">,</span>points<span class="Special">,</span>sten_coeff<span class="Special">;</span>
    <span class="Statement">local</span> varseq<span class="Special">,</span>stencil<span class="Special">,</span>stencil_table<span class="Special">;</span>
    <span class="Statement">local</span> diff_order<span class="Special">;</span>
    <span class="Statement">local</span> all_deriv_vars<span class="Special">;</span>
    <span class="Statement">local</span> rest_vars<span class="Special">,</span> trs<span class="Special">,</span> sten_order<span class="Special">;</span>
    <span class="Statement">local</span> tot_sten_order<span class="Special">;</span>

    <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>diff_table<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>points_table<span class="Special">)</span>  <span class="Statement">then</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid argument, points_table doesn't match to the derivative&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>diff_table<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>stepsize_table<span class="Special">)</span>  <span class="Statement">then</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid argument, stepsize_table doesn't match to derivative&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


    varseq<span class="Special">:=</span><span class="Statement">seq</span><span class="Special">(</span>vars<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>vars<span class="Special">))</span><span class="Special">;</span>
    stencil<span class="Special">:=</span>f<span class="Special">(</span>varseq<span class="Special">)</span><span class="Special">;</span>

    all_deriv_vars<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>
    tot_sten_order<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>diff_table<span class="Special">)</span> <span class="Statement">do</span>
       var_index<span class="Special">:=</span>diff_table<span class="Special">[</span>ii<span class="Special">,</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
       var_name <span class="Special">:=</span> vars<span class="Special">[</span>var_index<span class="Special">]</span><span class="Special">;</span>
       all_deriv_vars <span class="Special">:=</span> all_deriv_vars <span class="Special">,</span> var_name<span class="Special">;</span>
       diff_order <span class="Special">:=</span> diff_table<span class="Special">[</span>ii<span class="Special">,</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
       stepsize<span class="Special">:=</span>stepsize_table<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
       points<span class="Special">:=</span>points_table<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
       trs <span class="Special">:=</span> Calc_Stencil<span class="Special">(</span>diff_order<span class="Special">,</span>stepsize<span class="Special">,</span>points<span class="Special">,</span>usetable<span class="Special">)</span><span class="Special">;</span>
       stencil_table <span class="Special">:=</span> trs<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
       sten_order<span class="Special">:=</span>trs<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
       tot_sten_order<span class="Special">:=</span>tot_sten_order<span class="Special">,</span> <span class="Special">[</span>var_name<span class="Special">,</span>sten_order<span class="Special">]</span><span class="Special">;</span>
       points<span class="Special">:=</span><span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>stencil_table<span class="Special">[</span>jj<span class="Special">,</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>stencil_table<span class="Special">))]</span><span class="Special">;</span>
       sten_coeff<span class="Special">:=</span><span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>stencil_table<span class="Special">[</span>jj<span class="Special">,</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>stencil_table<span class="Special">))]</span><span class="Special">;</span>
       stencil<span class="Special">:=</span>Apply_Stencil<span class="Special">(</span>stencil<span class="Special">,</span>var_name<span class="Special">,</span>var_index<span class="Special">,</span>sten_coeff<span class="Special">,</span>points<span class="Special">,</span>stepsize<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>vars<span class="Special">)</span> <span class="Statement">do</span>
       var_index<span class="Special">:=</span> ii<span class="Special">;</span>
       var_name <span class="Special">:=</span> vars<span class="Special">[</span>var_index<span class="Special">]</span><span class="Special">;</span>
       <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>var_name <span class="Statement">in</span> <span class="Special">{</span>all_deriv_vars<span class="Special">})</span> <span class="Statement">then</span>
           points<span class="Special">:=</span><span class="Special">[</span><span class="Constant">0</span><span class="Special">]</span><span class="Special">;</span>
           sten_coeff<span class="Special">:=</span><span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
           tot_sten_order<span class="Special">:=</span>tot_sten_order<span class="Special">,</span><span class="Special">[</span>var_name<span class="Special">,</span><span class="Constant">-1</span><span class="Special">]</span><span class="Special">;</span>
           stencil<span class="Special">:=</span>Apply_Stencil<span class="Special">(</span>stencil<span class="Special">,</span>var_name<span class="Special">,</span>var_index<span class="Special">,</span>sten_coeff<span class="Special">,</span>points<span class="Special">,</span>stepsize<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

    <span class="Statement">return</span> <span class="Special">[</span>stencil<span class="Special">,</span><span class="Special">[</span>tot_sten_order<span class="Special">]]</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###############################</span>
<span class="Comment"># Cleans all global variables</span>
<span class="Comment">###############################</span>

CFD<span class="Special">:=</span>Clean_FD<span class="Special">;</span>

Clean_FD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

  <span class="Statement">global</span> FD_on<span class="Special">,</span>FD_results<span class="Special">,</span>FD_symbolics<span class="Special">,</span>variable_sequence<span class="Special">,</span>variable_set<span class="Special">,</span>FD_table<span class="Special">;</span>
  <span class="Statement">global</span> stepsize_table<span class="Special">,</span>all_stencils<span class="Special">,</span>grid_functions<span class="Special">,</span>explicit_functions<span class="Special">;</span>
  <span class="Statement">global</span> index_table<span class="Special">,</span> index_table_r<span class="Special">,</span>all_protected_vars<span class="Special">,</span>grid_func_table<span class="Special">;</span>
  <span class="Statement">global</span> shape_table<span class="Special">,</span> time_var_name<span class="Special">,</span>time_var_index<span class="Special">,</span>var_order_table<span class="Special">;</span>
  <span class="Statement">global</span> var_order_table_r<span class="Special">,</span>MAX_DERIVATIVE_NUMBER<span class="Special">;</span>
  <span class="Statement">global</span> sweep_order_table<span class="Special">;</span>
  <span class="Statement">local</span> ii<span class="Special">;</span>

  FD_results<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  FD_symbolics<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>variable_sequence<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>variable_set<span class="Special">)</span><span class="Special">;</span>
  variable_sequence<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>
  variable_set<span class="Special">:=</span><span class="Special">{}</span><span class="Special">;</span>
  FD_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>stepsize_table<span class="Special">)</span><span class="Special">;</span>
  stepsize_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  all_stencils<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Comment">#grid_functions:={};</span>
  <span class="Comment">#explicit_functions:={};  </span>
  <span class="Statement">unprotect</span><span class="Special">(</span>index_table<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>index_table_r<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>shape_table<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>all_protected_vars<span class="Special">)</span> <span class="Statement">do</span> <span class="Statement">unprotect</span><span class="Special">(</span>all_protected_vars<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  index_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  index_table_r<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  shape_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  grid_func_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>time_var_name<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>time_var_index<span class="Special">)</span><span class="Special">;</span>
  time_var_name<span class="Special">:=</span> <span class="Statement">'time_var_name'</span><span class="Special">;</span>
  time_var_index <span class="Special">:=</span> <span class="Statement">'time_var_index'</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>var_order_table<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>var_order_table_r<span class="Special">)</span><span class="Special">;</span>
  var_order_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  var_order_table_r<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">unprotect</span><span class="Special">(</span>sweep_order_table<span class="Special">)</span><span class="Special">;</span>
  sweep_order_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

  FD_on<span class="Special">:=</span><span class="Constant">0</span><span class="Special">;</span>
  <span class="Statement">return</span> <span class="Statement">'FD_on'</span><span class="Statement">=</span>FD_on<span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#########################</span>
<span class="Comment"># initializer</span>
<span class="Comment">#########################</span>

MFD<span class="Special">:=</span>Make_FD<span class="Special">;</span>

Make_FD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

    <span class="Statement">global</span> variable_sequence<span class="Special">,</span> variable_set<span class="Special">,</span> FD_table<span class="Special">;</span>
    <span class="Statement">global</span> grid_functions<span class="Special">;</span>
    <span class="Statement">global</span> explicit_functions<span class="Special">;</span>
    <span class="Statement">global</span> FD_results<span class="Special">,</span>FD_symbolics<span class="Special">,</span>FD_on<span class="Special">;</span>
    <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
    <span class="Statement">global</span> h<span class="Special">;</span>
    <span class="Statement">global</span> all_stencils<span class="Special">;</span>
    <span class="Statement">global</span> index_table<span class="Special">,</span>index_table_r<span class="Special">;</span>
    <span class="Statement">global</span> n<span class="Special">,</span>i<span class="Special">,</span>j<span class="Special">,</span>k<span class="Special">;</span>
    <span class="Statement">global</span> t<span class="Special">,</span>x<span class="Special">,</span>y<span class="Special">,</span>z<span class="Special">;</span>
    <span class="Statement">global</span> hx<span class="Special">,</span>hy<span class="Special">,</span>hz<span class="Special">,</span>ht<span class="Special">;</span>
    <span class="Statement">global</span> strict<span class="Special">;</span>
    <span class="Statement">global</span> time_var_name<span class="Special">,</span>time_var_index<span class="Special">;</span>
    <span class="Statement">global</span> plus_sign<span class="Special">,</span>minus_sign<span class="Special">;</span>
    <span class="Statement">global</span> dim<span class="Special">;</span>
    <span class="Statement">global</span> all_protected_vars<span class="Special">;</span>
    <span class="Statement">global</span> mol_struct<span class="Special">;</span>
    <span class="Statement">global</span> grid_func_table<span class="Special">;</span>
    <span class="Statement">global</span> shape_table<span class="Special">;</span>
    <span class="Statement">global</span> known_functions<span class="Special">;</span>
    <span class="Statement">global</span> var_order_table<span class="Special">;</span>
    <span class="Statement">global</span> var_order_table_r<span class="Special">;</span>
    <span class="Statement">global</span> SGFS<span class="Special">;</span>
    <span class="Statement">global</span> MAX_DERIVATIVE_NUMBER<span class="Special">;</span>
    <span class="Statement">global</span> DEFAULT_DIFF_ORD<span class="Special">;</span>
    <span class="Statement">local</span> ii<span class="Special">;</span>
    <span class="Statement">local</span> bt<span class="Special">;</span>
    <span class="Statement">global</span> sweep_order_table<span class="Special">;</span>
    <span class="Statement">global</span> stni<span class="Special">,</span> bfi<span class="Special">,</span>pbf<span class="Special">;</span>
    <span class="Statement">global</span> phys_bdy_table<span class="Special">;</span>
    <span class="Statement">global</span> xmin<span class="Special">,</span>xmax<span class="Special">,</span>ymin<span class="Special">,</span>ymax<span class="Special">,</span>zmin<span class="Special">,</span>zmax<span class="Special">;</span>

    MAX_DERIVATIVE_NUMBER <span class="Special">:=</span> <span class="Constant">10</span><span class="Special">;</span>
    DEFAULT_DIFF_ORD<span class="Special">:=</span><span class="Constant">2</span><span class="Special">;</span>


    strict <span class="Special">:=</span> <span class="Constant">true</span><span class="Special">;</span>

    <span class="Statement">if</span> <span class="Special">(</span>FD_on <span class="Statement">=</span> <span class="Constant">1</span><span class="Special">)</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;FD is already assigned, to restart: call Clean_FD.\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    h<span class="Special">:=</span><span class="Statement">'h'</span><span class="Special">;</span>
    x<span class="Special">:=</span><span class="Statement">'x'</span><span class="Special">;</span>y<span class="Special">:=</span><span class="Statement">'y'</span><span class="Special">;</span>z<span class="Special">:=</span><span class="Statement">'z'</span><span class="Special">;</span>t<span class="Special">:=</span><span class="Statement">'t'</span><span class="Special">;</span>
    i<span class="Special">:=</span><span class="Statement">'i'</span><span class="Special">;</span>j<span class="Special">:=</span><span class="Statement">'j'</span><span class="Special">;</span>k<span class="Special">:=</span><span class="Statement">'k'</span><span class="Special">;</span>n<span class="Special">:=</span><span class="Statement">'n'</span><span class="Special">;</span>
    hx<span class="Special">:=</span><span class="Statement">'hx'</span><span class="Special">;</span> hy<span class="Special">:=</span><span class="Statement">'hy'</span><span class="Special">;</span> hz<span class="Special">:=</span><span class="Statement">'hz'</span><span class="Special">;</span> ht<span class="Special">:=</span><span class="Statement">'ht'</span><span class="Special">;</span>

    xmin<span class="Special">:=</span><span class="Statement">'xmin'</span><span class="Special">;</span>xmax<span class="Special">:=</span><span class="Statement">'xmax'</span><span class="Special">;</span>
    ymin<span class="Special">:=</span><span class="Statement">'ymin'</span><span class="Special">;</span>ymax<span class="Special">:=</span><span class="Statement">'ymax'</span><span class="Special">;</span>
    zmin<span class="Special">:=</span><span class="Statement">'zmin'</span><span class="Special">;</span>zmax<span class="Special">:=</span><span class="Statement">'zmax'</span><span class="Special">;</span>

    stni<span class="Special">:=</span><span class="Statement">'stni'</span><span class="Special">;</span>

    bfi<span class="Special">:=</span><span class="Statement">'b'</span><span class="Special">;</span>
    pbf <span class="Special">:=</span> <span class="Statement">'p'</span><span class="Special">;</span>



    all_protected_vars<span class="Special">:=</span><span class="Special">[</span>t<span class="Special">,</span>x<span class="Special">,</span>y<span class="Special">,</span>z<span class="Special">,</span>i<span class="Special">,</span>j<span class="Special">,</span>k<span class="Special">,</span>n<span class="Special">,</span>ht<span class="Special">,</span>hx<span class="Special">,</span>hy<span class="Special">,</span>hz<span class="Special">,</span>h<span class="Special">,</span>xmin<span class="Special">,</span>xmax<span class="Special">,</span>ymin<span class="Special">,</span>ymax<span class="Special">,</span>zmin<span class="Special">,</span>zmax<span class="Special">,</span>stni<span class="Special">,</span><span class="Statement">'bfi'</span><span class="Special">,</span><span class="Statement">'pbf'</span><span class="Special">,</span><span class="Statement">'b'</span><span class="Special">,</span><span class="Statement">'p'</span><span class="Special">]</span><span class="Special">;</span>

    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>all_protected_vars<span class="Special">)</span> <span class="Statement">do</span>
        <span class="Statement">protect</span><span class="Special">(</span>all_protected_vars<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>


    plus_sign<span class="Special">:=</span><span class="Statement">'p'</span><span class="Special">;</span>
    minus_sign<span class="Special">:=</span><span class="Statement">'m'</span><span class="Special">;</span>
    dim<span class="Special">:=</span><span class="Special">[</span><span class="Constant">3</span><span class="Special">,</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>


    variable_sequence<span class="Special">:=</span>t<span class="Special">,</span>x<span class="Special">,</span>y<span class="Special">,</span>z<span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>variable_sequence<span class="Special">)</span><span class="Special">;</span>
    variable_set<span class="Special">:=</span><span class="Special">{</span>variable_sequence<span class="Special">}</span><span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>variable_set<span class="Special">)</span><span class="Special">;</span>
    time_var_name<span class="Special">:=</span>t<span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>time_var_name<span class="Special">)</span><span class="Special">;</span>
    time_var_index<span class="Special">:=</span>n<span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>time_var_index<span class="Special">)</span><span class="Special">;</span>

    index_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">([</span>t<span class="Statement">=</span>n<span class="Special">,</span>x<span class="Statement">=</span>i<span class="Special">,</span>y<span class="Statement">=</span>j<span class="Special">,</span>z<span class="Statement">=</span>k<span class="Special">])</span><span class="Special">;</span>
    index_table_r<span class="Special">:=</span><span class="Statement">table</span><span class="Special">([</span>n<span class="Statement">=</span>t<span class="Special">,</span>i<span class="Statement">=</span>x<span class="Special">,</span>j<span class="Statement">=</span>y<span class="Special">,</span>k<span class="Statement">=</span>z<span class="Special">])</span><span class="Special">;</span>
    var_order_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">([</span><span class="Constant">1</span><span class="Statement">=</span>n<span class="Special">,</span><span class="Constant">2</span><span class="Statement">=</span>i<span class="Special">,</span><span class="Constant">3</span><span class="Statement">=</span>j<span class="Special">,</span><span class="Constant">4</span><span class="Statement">=</span>k<span class="Special">])</span><span class="Special">;</span>
    var_order_table_r<span class="Special">:=</span><span class="Statement">table</span><span class="Special">([</span>n<span class="Statement">=</span><span class="Constant">1</span><span class="Special">,</span>i<span class="Statement">=</span><span class="Constant">2</span><span class="Special">,</span>j<span class="Statement">=</span><span class="Constant">3</span><span class="Special">,</span>k<span class="Statement">=</span><span class="Constant">4</span><span class="Special">])</span><span class="Special">;</span>
    sweep_order_table <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">([</span>i<span class="Statement">=</span><span class="Constant">1</span><span class="Special">,</span>j<span class="Statement">=</span><span class="Constant">2</span><span class="Special">,</span>k<span class="Statement">=</span><span class="Constant">3</span><span class="Special">])</span><span class="Special">;</span>
    phys_bdy_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span> <span class="Special">[</span>  xmin<span class="Statement">=</span><span class="Constant">1</span><span class="Special">,</span> xmax<span class="Statement">=</span><span class="Constant">2</span><span class="Special">,</span> ymin<span class="Statement">=</span><span class="Constant">3</span><span class="Special">,</span> ymax<span class="Statement">=</span><span class="Constant">4</span> <span class="Special">,</span> zmin<span class="Statement">=</span><span class="Constant">5</span><span class="Special">,</span> zmax<span class="Statement">=</span><span class="Constant">6</span>    <span class="Special">]</span> <span class="Special">)</span><span class="Special">;</span>

    <span class="Statement">protect</span><span class="Special">(</span>sweep_order_table<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>var_order_table<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>var_order_table_r<span class="Special">)</span><span class="Special">;</span>
    shape_table <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">([</span>n<span class="Statement">=</span>Nt<span class="Special">,</span>i<span class="Statement">=</span>Nx<span class="Special">,</span>j<span class="Statement">=</span>Ny<span class="Special">,</span>k<span class="Statement">=</span>Nz<span class="Special">])</span><span class="Special">;</span>

    <span class="Statement">protect</span><span class="Special">(</span>index_table<span class="Special">)</span><span class="Special">;</span> <span class="Statement">protect</span><span class="Special">(</span>index_table_r<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>shape_table<span class="Special">)</span><span class="Special">;</span>

    bt<span class="Special">:=</span><span class="Statement">table</span><span class="Special">([</span>t<span class="Statement">=</span><span class="Special">[</span><span class="Constant">-1</span><span class="Special">,</span><span class="Constant">-1</span><span class="Special">]</span><span class="Special">,</span>x<span class="Statement">=</span><span class="Special">[</span><span class="Constant">-1</span><span class="Special">,</span><span class="Constant">-1</span><span class="Special">]</span><span class="Special">,</span>y<span class="Statement">=</span><span class="Special">[</span><span class="Constant">-1</span><span class="Special">,</span><span class="Constant">-1</span><span class="Special">]</span><span class="Special">,</span>z<span class="Statement">=</span><span class="Special">[</span><span class="Constant">-1</span><span class="Special">,</span><span class="Constant">-1</span><span class="Special">]])</span><span class="Special">;</span>


    stepsize_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">([</span>t<span class="Statement">=</span>ht<span class="Special">,</span>x<span class="Statement">=</span>hx<span class="Special">,</span>y<span class="Statement">=</span>hy<span class="Special">,</span>z<span class="Statement">=</span>hz<span class="Special">])</span><span class="Special">;</span>
    <span class="Statement">protect</span><span class="Special">(</span>stepsize_table<span class="Special">)</span><span class="Special">;</span>

    mol_struct<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>variable_set<span class="Special">)</span> <span class="Statement">do</span>
         mol_struct<span class="Special">[</span>index_table<span class="Special">[</span>variable_set<span class="Special">[</span>ii<span class="Special">]]]</span> <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

    <span class="Comment">#grid_functions:={};</span>
    <span class="Comment">#explicit_functions:={};</span>
    <span class="Comment">#SGFS := {};</span>
    FD_on<span class="Special">:=</span><span class="Constant">1</span><span class="Special">;</span>
    FD_results<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
    FD_symbolics<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
    all_stencils<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
    grid_func_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

    known_functions<span class="Special">:=</span><span class="Special">{</span><span class="Statement">ln</span><span class="Special">,</span><span class="Statement">log</span><span class="Special">,</span><span class="Statement">exp</span><span class="Special">,</span><span class="Statement">sin</span><span class="Special">,</span><span class="Statement">cos</span><span class="Special">,</span><span class="Statement">tan</span><span class="Special">,</span><span class="Statement">cot</span><span class="Special">,</span><span class="Statement">tanh</span><span class="Special">,</span><span class="Statement">coth</span><span class="Special">,</span><span class="Statement">sinh</span><span class="Special">,</span><span class="Statement">cosh</span><span class="Special">,</span><span class="Statement">exp</span><span class="Special">,</span><span class="Statement">sqrt</span><span class="Special">,</span><span class="Constant">`^`</span><span class="Special">,</span><span class="Constant">`*`</span><span class="Special">,</span><span class="Constant">`+`</span><span class="Special">}</span><span class="Special">;</span>
    Update_FD_Table<span class="Special">(</span>DEFAULT_DIFF_ORD<span class="Special">,</span>bt<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">return</span> <span class="Statement">'FD_on'</span><span class="Statement">=</span>FD_on<span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

FFDAAM<span class="Special">:=</span>Find_FDA_Accuracy_Matrix<span class="Special">;</span>

Find_FDA_Accuracy_Matrix<span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>bdy<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>

   <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">,</span>expr<span class="Special">,</span>a<span class="Special">,</span>r<span class="Special">;</span>
   <span class="Statement">global</span> grid_functions<span class="Special">;</span>

   <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Finding the FDA accuracy matrix, this can take a while...\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Constant">5</span> <span class="Statement">do</span>
   CFD<span class="Special">()</span><span class="Special">:</span>
   MFD<span class="Special">()</span><span class="Special">:</span>
   Update_FD_Table<span class="Special">(</span>jj<span class="Special">,</span>bdy<span class="Special">)</span><span class="Special">:</span>
   grid_functions<span class="Special">:=</span><span class="Special">{</span>f<span class="Special">}</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Constant">10</span> <span class="Statement">do</span>
     expr<span class="Special">:=</span><span class="Statement">D</span><span class="Special">[</span><span class="Constant">1</span>$ii<span class="Special">](</span>f<span class="Special">)(</span>x<span class="Special">)</span><span class="Special">:</span>
     Gen_Sten<span class="Special">(</span>expr<span class="Special">,</span>discretized<span class="Statement">=</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">:</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">:</span>
   a<span class="Special">:=</span>SFD<span class="Special">()</span><span class="Special">:</span>
   r<span class="Special">[</span>jj<span class="Special">]</span><span class="Special">:=</span><span class="Statement">seq</span><span class="Special">(</span> <span class="Statement">rhs</span><span class="Special">(</span>a<span class="Special">[</span>ii<span class="Special">])[</span><span class="Constant">2</span><span class="Special">][</span><span class="Constant">1</span><span class="Special">][</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>a<span class="Special">))</span><span class="Special">:</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">:</span>

   <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;This is the FDA accuracy matrix for the table:\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Constant">5</span> <span class="Statement">do</span>
      <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;%a\n&quot;</span><span class="Special">,</span><span class="Special">[</span>r<span class="Special">[</span>jj<span class="Special">]])</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#Scheme := proc(s::string,ord::integer)</span>
<span class="Comment">#  if s=&quot;allcentered&quot; then</span>
<span class="Comment">#      Update_FD_Table(ord,table([ t=[-1,-1],x=[-1,-1],y=[-1,-1],z=[-1,-1] ]));        </span>
<span class="Comment">#  else if s=&quot;allbackward&quot; then</span>
<span class="Comment">#      Update_FD_Table(ord,table([ t=[-1,0],x=[-1,0],y=[-1,0],z=[-1,0] ]));</span>
<span class="Comment">#  else if s=&quot;allforward&quot; then</span>
<span class="Comment">#      Update_FD_Table(ord,table([ t=[0,-1],x=[0,-1],y=[0,-1],z=[0,-1] ]));</span>
<span class="Comment">#  else</span>
<span class="Comment">#    error(&quot;Not supported!&quot;);</span>
<span class="Comment">#  end if;</span>
<span class="Comment">#</span>
<span class="Comment">#end proc;</span>

Update_FD_Table <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>ord<span class="Special">::</span>integer<span class="Special">,</span>boundary<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>

    <span class="Statement">global</span> FD_table<span class="Special">,</span>variable_set<span class="Special">;</span>
    <span class="Statement">global</span> MAX_DERIVATIVE_NUMBER<span class="Special">;</span>
    <span class="Statement">local</span> ii<span class="Special">;</span>

    check_FD<span class="Special">()</span><span class="Special">;</span>

    FD_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>variable_set<span class="Special">)</span> <span class="Statement">do</span>
        FD_table<span class="Special">[</span>variable_set<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> Gen_Point_Table<span class="Special">(</span>ord<span class="Special">,</span>MAX_DERIVATIVE_NUMBER<span class="Special">,</span>boundary<span class="Special">[</span>variable_set<span class="Special">[</span>ii<span class="Special">]])</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

    <span class="Comment"># EXAMPLE:</span>
    <span class="Comment">#pt:=[[0],[-1,0,1],[-1,0,1],[-2,-1,0,1,2],[-2,-1,0,1,2],[-3,-2,-1,0,1,2,3],[-3,-2,-1,0,1,2,3]];</span>
    <span class="Comment">#px:=[[0],[-1,0,1],[-1,0,1],[-2,-1,0,1,2],[-2,-1,0,1,2],[-3,-2,-1,0,1,2,3],[-3,-2,-1,0,1,2,3]];</span>
    <span class="Comment">#py:=[[0],[-1,0,1],[-1,0,1],[-2,-1,0,1,2],[-2,-1,0,1,2],[-3,-2,-1,0,1,2,3],[-3,-2,-1,0,1,2,3]];</span>
    <span class="Comment">#pz:=[[0],[-1,0,1],[-1,0,1],[-2,-1,0,1,2],[-2,-1,0,1,2],[-3,-2,-1,0,1,2,3],[-3,-2,-1,0,1,2,3]]; </span>

    <span class="Comment">#FD_table:=table([t=pt,x=px,y=py,z=pz]);</span>
   <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;FD table updated, see the content using SFDT() command\n&quot;</span><span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

Gen_Point_Table <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>ord<span class="Special">::</span>integer<span class="Special">,</span>mdn<span class="Special">::</span>integer<span class="Special">,</span>boundary<span class="Special">::</span>list<span class="Special">(</span>integer<span class="Special">))</span>

    <span class="Statement">local</span> ii<span class="Special">,</span>pt<span class="Special">;</span>
    <span class="Statement">local</span> tmp_l<span class="Special">;</span>

    pt <span class="Special">:=</span> <span class="Special">NULL</span><span class="Special">;</span>
    pt <span class="Special">:=</span> <span class="Special">[</span><span class="Constant">0</span><span class="Special">]</span><span class="Special">;</span>

    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> mdn <span class="Statement">do</span>
         tmp_l<span class="Special">:=</span> Gen_Single_Point_Table<span class="Special">(</span>ii<span class="Special">,</span>ord<span class="Special">,</span>boundary<span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>tmp_l<span class="Special">)</span> <span class="Statement">&lt;=</span> ii <span class="Statement">then</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Gen_Single_Point_Table algorithm is returning wrong number of points&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">else</span>
            pt<span class="Special">:=</span> pt <span class="Special">,</span> Gen_Single_Point_Table<span class="Special">(</span>ii<span class="Special">,</span>ord<span class="Special">,</span>boundary<span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    <span class="Statement">return</span> <span class="Special">[</span>pt<span class="Special">]</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

Gen_Single_Point_Table<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>deriv<span class="Special">::</span>integer<span class="Special">,</span>ord<span class="Special">::</span>integer<span class="Special">,</span>boundary<span class="Special">::</span>list<span class="Special">(</span>integer<span class="Special">))</span>

     <span class="Statement">local</span> tot_num_point<span class="Special">;</span>
     <span class="Statement">local</span> num_seq<span class="Special">,</span>ii<span class="Special">;</span>
     <span class="Statement">local</span> LL<span class="Special">;</span>

     num_seq<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Special">(</span>boundary<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">-1</span><span class="Special">)</span> <span class="Statement">and</span> <span class="Special">(</span>boundary<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">-1</span><span class="Special">)</span> <span class="Statement">then</span>
          tot_num_point<span class="Special">:=</span> deriv + <span class="Statement">iquo</span><span class="Special">(</span>ord<span class="Constant">+1</span><span class="Special">,</span><span class="Constant">2</span><span class="Special">)</span>*<span class="Constant">2</span> <span class="Constant">+1</span><span class="Special">;</span>
          LL<span class="Special">:=</span> <span class="Constant">-1</span>+<span class="Statement">iquo</span><span class="Special">(</span>tot_num_point<span class="Special">,</span><span class="Constant">2</span><span class="Special">)</span><span class="Special">;</span>
          num_seq <span class="Special">:=</span> <span class="Statement">seq</span><span class="Special">(</span>ii<span class="Special">,</span> ii<span class="Statement">=</span> -LL<span class="Statement">..</span>LL <span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">return</span> <span class="Special">[</span>num_seq<span class="Special">]</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Special">(</span>boundary<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">-1</span><span class="Special">)</span> <span class="Statement">and</span> <span class="Special">(</span>boundary<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span> <span class="Statement">&gt;=</span><span class="Constant">0</span><span class="Special">)</span> <span class="Statement">then</span>
          tot_num_point<span class="Special">:=</span> deriv + ord+ <span class="Constant">1</span><span class="Special">;</span>
          LL<span class="Special">:=</span><span class="Constant">-1</span>+<span class="Statement">iquo</span><span class="Special">(</span>tot_num_point<span class="Constant">+1</span><span class="Special">,</span><span class="Constant">2</span><span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">if</span> LL <span class="Statement">&gt;</span> boundary<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span> <span class="Statement">then</span>
             num_seq <span class="Special">:=</span> <span class="Statement">seq</span><span class="Special">(</span>ii<span class="Special">,</span> ii<span class="Statement">=</span> -LL-<span class="Special">(</span>LL-boundary<span class="Special">[</span><span class="Constant">2</span><span class="Special">])</span><span class="Statement">..</span>LL-<span class="Special">(</span>LL-boundary<span class="Special">[</span><span class="Constant">2</span><span class="Special">]))</span><span class="Special">;</span>
          <span class="Statement">else</span>
             num_seq <span class="Special">:=</span> <span class="Statement">seq</span><span class="Special">(</span>ii<span class="Special">,</span> ii<span class="Statement">=</span> -LL<span class="Statement">..</span>LL<span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
          <span class="Statement">return</span> <span class="Special">[</span>num_seq<span class="Special">]</span><span class="Special">;</span>

     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Special">(</span>boundary<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">-1</span><span class="Special">)</span> <span class="Statement">and</span> <span class="Special">(</span>boundary<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">&gt;=</span><span class="Constant">0</span><span class="Special">)</span> <span class="Statement">then</span>
          tot_num_point<span class="Special">:=</span> deriv + ord  <span class="Constant">+1</span> <span class="Special">;</span>
          LL<span class="Special">:=</span><span class="Constant">-1</span>+<span class="Statement">iquo</span><span class="Special">(</span>tot_num_point<span class="Constant">+1</span><span class="Special">,</span><span class="Constant">2</span><span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">if</span> LL <span class="Statement">&gt;</span> boundary<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
             num_seq <span class="Special">:=</span> <span class="Statement">seq</span><span class="Special">(</span>ii<span class="Special">,</span> ii<span class="Statement">=</span> -LL+<span class="Special">(</span>LL-boundary<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span><span class="Statement">..</span>LL+<span class="Special">(</span>LL-boundary<span class="Special">[</span><span class="Constant">1</span><span class="Special">]))</span><span class="Special">;</span>
          <span class="Statement">else</span>
             num_seq <span class="Special">:=</span> <span class="Statement">seq</span><span class="Special">(</span>ii<span class="Special">,</span> ii<span class="Statement">=</span> -LL<span class="Statement">..</span>LL<span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
          <span class="Statement">return</span> <span class="Special">[</span>num_seq<span class="Special">]</span><span class="Special">;</span>

     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid Boundary&quot;</span><span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#################################################################</span>
<span class="Comment">#    is_gf &amp; discretized [t,x,y,z] -&gt; n,i,j,k</span>
<span class="Comment">#    not(is_gf) &amp; discretized [t,x,y,z] -&gt; t(n), x(i), y(j), z(k)</span>
<span class="Comment">#    is_gf &amp; not(discretized) [x,y] -&gt; x , y (**warning!!**)</span>
<span class="Comment">#    not(is_gf) &amp; not(discretized) -&gt; x , y  </span>
<span class="Comment">#################################################################</span>


Discrete <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>v<span class="Special">::</span>list<span class="Special">,</span>is_gf<span class="Special">::</span>boolean<span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">)</span>
   <span class="Statement">global</span> variable_set<span class="Special">,</span>index_table<span class="Special">;</span>
   <span class="Statement">local</span> sq<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">;</span>

   sq<span class="Special">:=</span><span class="Statement">seq</span><span class="Special">(</span>v<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>v<span class="Special">))</span><span class="Special">;</span>

   <span class="Statement">if</span> is_gf <span class="Statement">then</span>

      check_validity_grid_func_arg<span class="Special">(</span>v<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>

      <span class="Statement">if</span> discretized <span class="Statement">then</span>
         <span class="Statement">return</span> <span class="Statement">seq</span><span class="Special">(</span>index_table<span class="Special">[</span>v<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>v<span class="Special">))</span><span class="Special">;</span>
      <span class="Statement">else</span>
         <span class="Statement">return</span> sq<span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">else</span>

     <span class="Statement">if</span> discretized <span class="Statement">then</span>
        <span class="Statement">return</span> <span class="Statement">seq</span><span class="Special">(</span>v<span class="Special">[</span>ii<span class="Special">](</span>index_table<span class="Special">[</span>v<span class="Special">[</span>ii<span class="Special">]])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>v<span class="Special">))</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">return</span> sq<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">#####################################################</span>
<span class="Comment"># Generates proper name for derivatives:</span>
<span class="Comment"># diff(f(t,y,x,z),z,z,t,y) -&gt; f1244(t,y,x,z)</span>
<span class="Comment">#####################################################</span>

Gen_Name_Multi_ <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>f<span class="Special">::</span>name<span class="Special">,</span>vars<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>n<span class="Special">::</span>integer<span class="Special">,</span>diff_table<span class="Special">::</span>list<span class="Special">(</span>list<span class="Special">(</span>integer<span class="Special">))</span><span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">)</span>

    <span class="Statement">local</span> varseq<span class="Special">,</span>ii<span class="Special">,</span>jj<span class="Special">;</span>
    <span class="Statement">local</span> fin_nm<span class="Special">;</span>
    <span class="Statement">local</span> dis_var_seq<span class="Special">;</span>
    <span class="Statement">global</span> index_table<span class="Special">;</span>
    varseq<span class="Special">:=</span><span class="Statement">seq</span><span class="Special">(</span>vars<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>vars<span class="Special">))</span><span class="Special">;</span>
    fin_nm <span class="Special">:=</span> f<span class="Special">;</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>diff_table<span class="Special">)</span> <span class="Statement">do</span>
      <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">2</span><span class="Special">]</span> <span class="Statement">do</span>
         fin_nm <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>fin_nm<span class="Special">,</span>diff_table<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    <span class="Statement">if</span> discretized <span class="Statement">then</span>
       dis_var_seq<span class="Special">:=</span><span class="Statement">seq</span><span class="Special">(</span>index_table<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>vars<span class="Special">))</span><span class="Special">;</span>
       <span class="Statement">return</span> <span class="Special">[</span>fin_nm<span class="Special">(</span>dis_var_seq<span class="Special">)</span><span class="Special">,</span>fin_nm<span class="Special">]</span><span class="Special">;</span>
    <span class="Statement">else</span>
       <span class="Statement">return</span> <span class="Special">[</span>fin_nm<span class="Special">(</span>varseq<span class="Special">)</span><span class="Special">,</span>fin_nm<span class="Special">]</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">########################################################</span>
<span class="Comment"># Front end for Gen_Sten_L</span>
<span class="Comment"># Returns FDA equivalent of an arbitrary expression</span>
<span class="Comment"># including functions and derivatives</span>
<span class="Comment">########################################################</span>

GS<span class="Special">:=</span>Gen_Sten<span class="Special">;</span>

Gen_Sten <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>discretized<span class="Special">:=</span><span class="Constant">true</span><span class="Special">,</span>sym<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>


 check_FD<span class="Special">()</span><span class="Special">;</span>
 check_GF<span class="Special">()</span><span class="Special">;</span>

  <span class="Statement">return</span> Gen_Sten_L<span class="Special">(</span><span class="Statement">convert</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Statement">diff</span><span class="Special">)</span><span class="Special">,</span>discretized<span class="Special">,</span>sym<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###################################################################</span>
<span class="Comment"># Returns the FDA expression for an arbitrary length expression</span>
<span class="Comment"># Uses the FD_table, stepsize_table, variable_set global variables</span>
<span class="Comment">###################################################################</span>

Gen_Sten_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">,</span>symbolic<span class="Special">::</span>boolean<span class="Special">)</span>

   <span class="Statement">global</span> variable_set<span class="Special">,</span>grid_functions<span class="Special">;</span>
   <span class="Statement">global</span> FD_results<span class="Special">,</span>FD_symbolics<span class="Special">;</span>
   <span class="Statement">local</span> stn<span class="Special">,</span>stm<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>variable_set<span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">return</span> EXPR<span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Type">PDEtools</span><span class="Special">[</span>difforder<span class="Special">](</span>EXPR<span class="Special">)</span><span class="Statement">=</span><span class="Constant">0</span> <span class="Statement">then</span>
      <span class="Statement">return</span> Gen_Expr_L<span class="Special">(</span>EXPR<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span> <span class="Special">(</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Statement">=</span><span class="Constant">`diff`</span>  <span class="Special">)</span> <span class="Statement">then</span>

       check_validity_op<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>

       <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Gen_Sten_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>discretized<span class="Special">,</span>symbolic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>

   <span class="Statement">else</span>

      <span class="Statement">if</span> Is_GF<span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">then</span>
         stn<span class="Special">:=</span>Gen_Sten_Multi_Var<span class="Special">(</span>Extract_FD<span class="Special">(</span>EXPR<span class="Special">,</span>notable<span class="Statement">=</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">,</span>usetable<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
         FD_results<span class="Special">[</span>EXPR<span class="Special">]</span><span class="Special">:=</span>stn<span class="Special">;</span>
         <span class="Statement">if</span> symbolic <span class="Statement">then</span>
            stm <span class="Special">:=</span> Gen_Name_Multi_<span class="Special">(</span>Extract_FD<span class="Special">(</span>EXPR<span class="Special">,</span>notable<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
            FD_symbolics<span class="Special">[</span>EXPR<span class="Special">]</span> <span class="Special">:=</span> stm<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
            grid_functions<span class="Special">:=</span> grid_functions <span class="Statement">union</span> <span class="Special">{</span>stm<span class="Special">[</span><span class="Constant">2</span><span class="Special">]}</span><span class="Special">;</span>
            <span class="Statement">return</span>  stm<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
        <span class="Statement">else</span>
            <span class="Statement">return</span> stn<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">else</span>
         WARNING<span class="Special">(</span><span class="Constant">&quot;Detected a derivative expression, while the function is not in grid functions, see:&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">print</span><span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
         stn<span class="Special">:=</span>Gen_Sten_Multi_Var<span class="Special">(</span>Extract_FD<span class="Special">(</span>EXPR<span class="Special">,</span>notable<span class="Statement">=</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">,</span>usetable<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">;</span>
         stn<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">:=</span>Gen_Expr_L<span class="Special">(</span>stn<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
         FD_results<span class="Special">[</span>EXPR<span class="Special">]</span><span class="Special">:=</span>stn<span class="Special">;</span>
         <span class="Statement">if</span> symbolic <span class="Statement">then</span>
             stm <span class="Special">:=</span> Gen_Name_Multi_<span class="Special">(</span>Extract_FD<span class="Special">(</span>EXPR<span class="Special">,</span>notable<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">;</span>
             stm<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Special">:=</span> Gen_Expr_L<span class="Special">(</span>stm<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
             FD_symbolics<span class="Special">[</span>EXPR<span class="Special">]</span> <span class="Special">:=</span> stm<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
             <span class="Statement">return</span> stm<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
         <span class="Statement">else</span>
             <span class="Statement">return</span> stn<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


Is_GF<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

       <span class="Statement">global</span> grid_functions<span class="Special">;</span>
       <span class="Statement">local</span> diff_eqn<span class="Special">,</span>f<span class="Special">;</span>

       diff_eqn <span class="Special">:=</span> <span class="Statement">convert</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Statement">D</span><span class="Special">)</span><span class="Special">;</span>
       f<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>diff_eqn<span class="Special">))</span><span class="Special">;</span>

       <span class="Statement">if</span> f <span class="Statement">in</span> grid_functions <span class="Statement">then</span>
         <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
       <span class="Statement">else</span>
         <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#####################################################################</span>
<span class="Comment"># Returns a FD equivalent of a non-differential expression</span>
<span class="Comment"># Uses grid_function list to distinguish functions.</span>
<span class="Comment">#  EXAMPLE:</span>
<span class="Comment">#       INPUT:</span>
<span class="Comment">#            grid_functions = {f,g}</span>
<span class="Comment">#            EXPR           = cos(x*y)+x*f(t,x,y)+r(t,x)+w(t)*g(t,x,y)+u(g(t,x,y))</span>
<span class="Comment">#       OUTPUT:</span>
<span class="Comment">#          cos(x(i) y(j)) + x(i) f(n, i, j) + r(t(n), x(i)) + w(t(n)) g(n, i, j) + u(g(n, i, j))</span>
<span class="Comment">#####################################################################</span>


Gen_Expr <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>discretized<span class="Special">:=</span><span class="Constant">true</span><span class="Special">})</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>

   <span class="Statement">if</span> check_validity_c_expr<span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">then</span>

     <span class="Statement">return</span> Gen_Expr_L<span class="Special">(</span>EXPR<span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">else</span>
     <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid continuous expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

Gen_Expr_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">)</span>

   <span class="Statement">global</span> variable_set<span class="Special">,</span>index_table<span class="Special">,</span>grid_functions<span class="Special">;</span>

   <span class="Statement">local</span> func<span class="Special">,</span>vars<span class="Special">,</span>ii<span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>variable_set<span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">return</span> EXPR<span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Type">PDEtools</span><span class="Special">[</span>difforder<span class="Special">](</span>EXPR<span class="Special">)</span><span class="Statement">&lt;&gt;</span><span class="Constant">0</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Differential expression is invalid argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> EXPR <span class="Statement">in</span> variable_set <span class="Statement">then</span>
      <span class="Statement">return</span> Discrete<span class="Special">([</span>EXPR<span class="Special">]</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span>  <span class="Statement">not</span> <span class="Special">(</span> <span class="Special">{</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)}</span> <span class="Statement">subset</span> variable_set <span class="Special">)</span> <span class="Statement">then</span>

    check_grid_func_arg<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>

    <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Gen_Expr_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>discretized<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>

   <span class="Statement">else</span>

         check_validity_func<span class="Special">(</span>EXPR<span class="Special">,</span>variable_set<span class="Special">)</span><span class="Special">;</span>
         func<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
         vars<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>

         <span class="Statement">if</span> func <span class="Statement">in</span> grid_functions <span class="Statement">then</span>
            <span class="Statement">return</span> func<span class="Special">(</span>Discrete<span class="Special">([</span>vars<span class="Special">]</span><span class="Special">,</span><span class="Constant">true</span><span class="Special">,</span>discretized<span class="Special">))</span><span class="Special">;</span>
         <span class="Statement">else</span>
            <span class="Statement">return</span> func<span class="Special">(</span>Discrete<span class="Special">([</span>vars<span class="Special">]</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span>discretized<span class="Special">))</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">#############################################################################################</span>
<span class="Comment"># converts a discrete FDA to a continuous</span>
<span class="Comment"># uses grid_function and other global variables</span>
<span class="Comment"># to identify the functions:</span>
<span class="Comment">#</span>
<span class="Comment"># EXAMPLE: </span>
<span class="Comment">#</span>
<span class="Comment">#    for        grid_functions = {f,g}</span>
<span class="Comment">#    INPUT = ( f(i+1,j)-f(i-1,j) )/(2*hx) + cos(x(i)*y(j)) + 2*g(n,i,j,k) + r(x(i),f(i))</span>
<span class="Comment">#    OUTPUT = (f(x+hx,y) - f(x-hx,y) /(2*hx) + cos(x*y) + 2*g(t,x,y,z) + r(x,f(x))</span>
<span class="Comment">#    EXAMPLES OF INVALID INPUTS:  </span>
<span class="Comment">#                  r(i) (r is not defined as grid function)</span>
<span class="Comment">#                  r(x(j)) invalind indexing</span>
<span class="Comment">#                  cos(i*j) invalid arguments</span>
<span class="Comment">#                  k -&gt; index should come through either grid functions or grid position z(k)</span>
<span class="Comment">#</span>
<span class="Comment">#    EXAMPLES OF NON PROPER INPUTS THAT WOULD BE HANDLED POTENTIALLY WITH WARNINGS:</span>
<span class="Comment">#                f(x(i),y(j)) -&gt; f(x,y) </span>
<span class="Comment">#    </span>
<span class="Comment">##############################################################################################</span>

Discrete_To_Continuous<span class="Special">:=</span>DtoC<span class="Special">;</span>

DtoC <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

    check_FD<span class="Special">()</span><span class="Special">;</span>

    <span class="Statement">if</span> check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span> <span class="Statement">then</span>
       <span class="Statement">return</span> DtoC_L<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">else</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

DtoC_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">,</span>grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
           pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span>+<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)</span>-pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">][</span><span class="Constant">1</span><span class="Special">])</span>*stepsize_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)]</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>DtoC_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>convert_arg<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>DtoC_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">########################################</span>
<span class="Comment">#  f(i-1,j+2,k) -&gt; true , {i,j,k}</span>
<span class="Comment">#  f(i,1) -&gt; false</span>
<span class="Comment">#  a+b -&gt; false</span>
<span class="Comment">#  f(x,i,j) -&gt; false</span>
<span class="Comment">#  i+j -&gt; true ( it is +(i,j) so it is true!) </span>
<span class="Comment">#  i*(j+k) -&gt; false ( it is *(i,+(j,k)) (second argument of * is not properly indexed) </span>
<span class="Comment">#  if is_gf_periodic enabled:</span>
<span class="Comment">#  f(i-3+Nx,j+2-Ny) -&gt; true</span>
<span class="Comment">########################################</span>

proper_grid_func <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>return_index<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>is_gf_periodic<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

      <span class="Statement">global</span> index_table<span class="Special">;</span>
      <span class="Statement">local</span> ii<span class="Special">,</span>var<span class="Special">;</span>
      <span class="Statement">local</span> is_prop<span class="Special">,</span>indexes<span class="Special">;</span>
      var<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)]</span><span class="Special">;</span>
      is_prop<span class="Special">:=</span><span class="Constant">true</span><span class="Special">;</span>
      indexes<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>

      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>is_gf_periodic<span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">)</span> <span class="Statement">do</span>
             <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Statement">=</span><span class="Constant">`+`</span> <span class="Statement">then</span>

                <span class="Statement">if</span>  <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">2</span> <span class="Statement">then</span>
                     is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

                <span class="Statement">if</span>  <span class="Statement">not</span> <span class="Special">(</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">or</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
                     is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

                <span class="Statement">if</span>  <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
                    indexes<span class="Special">:=</span>indexes <span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                <span class="Statement">elif</span>  <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)</span> <span class="Special">}</span>   <span class="Statement">then</span>
                     indexes<span class="Special">:=</span>indexes <span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">:</span>
                <span class="Statement">else</span>
                     is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

             <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Statement">=</span><span class="Constant">`symbol`</span> <span class="Statement">then</span>
                <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span> var<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})</span> <span class="Statement">then</span>
                   is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                <span class="Statement">else</span>
                   indexes<span class="Special">:=</span>indexes <span class="Special">,</span> var<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
                <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
             <span class="Statement">else</span>
               is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
             <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
         <span class="Statement">if</span> return_index <span class="Statement">then</span>
              <span class="Statement">if</span> is_prop <span class="Statement">then</span>
                 <span class="Statement">return</span> is_prop<span class="Special">,</span> <span class="Special">[</span>indexes<span class="Special">]</span><span class="Special">;</span>
              <span class="Statement">else</span>
                 <span class="Statement">return</span> is_prop<span class="Special">,</span> <span class="Special">[</span><span class="Constant">0</span><span class="Special">]</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
         <span class="Statement">else</span>
              <span class="Statement">return</span> is_prop
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">else</span> <span class="Comment">#gf_is_periodic</span>

       <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">)</span> <span class="Statement">do</span>

           <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">=</span> <span class="Constant">`+`</span> <span class="Statement">then</span>

               <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">=</span> <span class="Constant">2</span> <span class="Statement">then</span>
                  <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
                     <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">or</span> <span class="Special">(</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])])</span> <span class="Special">)</span> <span class="Statement">then</span>
                       indexes <span class="Special">:=</span> indexes <span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                     <span class="Statement">else</span>
                       is_prop <span class="Special">:=</span> <span class="Constant">false</span><span class="Special">;</span>
                     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                  <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
                     <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">or</span> <span class="Special">(</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])]</span> <span class="Special">))</span> <span class="Statement">then</span>
                       indexes <span class="Special">:=</span> indexes<span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                     <span class="Statement">else</span>
                        is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                  <span class="Statement">else</span>
                       is_prop <span class="Special">:=</span> <span class="Constant">false</span><span class="Special">;</span>
                  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

               <span class="Statement">elif</span> <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">=</span> <span class="Constant">3</span> <span class="Statement">then</span>

                  <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
                      <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                          <span class="Statement">if</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])])</span> <span class="Statement">then</span>
                             indexes <span class="Special">:=</span> indexes <span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                          <span class="Statement">else</span>
                             is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                      <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                           <span class="Statement">if</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])])</span> <span class="Statement">then</span>
                               indexes <span class="Special">:=</span> indexes<span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                           <span class="Statement">else</span>
                               is_prop <span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                      <span class="Statement">else</span>
                         is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

                  <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>

                      <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                          <span class="Statement">if</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])])</span> <span class="Statement">then</span>
                             indexes <span class="Special">:=</span> indexes <span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                          <span class="Statement">else</span>
                             is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                      <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                           <span class="Statement">if</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])])</span> <span class="Statement">then</span>
                               indexes <span class="Special">:=</span> indexes<span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                           <span class="Statement">else</span>
                               is_prop <span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                      <span class="Statement">else</span>
                         is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


                  <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>

                      <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                          <span class="Statement">if</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])])</span> <span class="Statement">then</span>
                             indexes <span class="Special">:=</span> indexes <span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                          <span class="Statement">else</span>
                             is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                      <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                           <span class="Statement">if</span> <span class="Statement">abs</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">]))</span> <span class="Statement">=</span> <span class="Statement">abs</span><span class="Special">(</span>shape_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])])</span> <span class="Statement">then</span>
                               indexes <span class="Special">:=</span> indexes<span class="Special">,</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">3</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
                           <span class="Statement">else</span>
                               is_prop <span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
                      <span class="Statement">else</span>
                         is_prop<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
                      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


                  <span class="Statement">else</span>
                     is_prop <span class="Special">:=</span> <span class="Constant">false</span><span class="Special">;</span>
                  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

               <span class="Statement">else</span>
                  is_prop <span class="Special">:=</span> <span class="Constant">false</span><span class="Special">;</span>
               <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

           <span class="Statement">elif</span> var<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">in</span> <span class="Special">{</span> <span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
              indexes <span class="Special">:=</span> indexes<span class="Special">,</span> var<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
           <span class="Statement">else</span>
              is_prop <span class="Special">:=</span> <span class="Constant">false</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

       <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

      <span class="Statement">if</span> return_index <span class="Statement">then</span>
              <span class="Statement">if</span> is_prop <span class="Statement">then</span>
                 <span class="Statement">return</span> is_prop<span class="Special">,</span> <span class="Special">[</span>indexes<span class="Special">]</span><span class="Special">;</span>
              <span class="Statement">else</span>
                 <span class="Statement">return</span> is_prop<span class="Special">,</span> <span class="Special">[</span><span class="Constant">0</span><span class="Special">]</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
         <span class="Statement">else</span>
              <span class="Statement">return</span> is_prop
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">###################</span>
<span class="Comment">#  i+2 -&gt; x+2*hx</span>
<span class="Comment">#  j -&gt; y</span>
<span class="Comment">#  n-1 -&gt; t-ht</span>
<span class="Comment">##################</span>

convert_arg <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>
     <span class="Statement">global</span> index_table_r<span class="Special">;</span>
     <span class="Statement">local</span> var<span class="Special">,</span>num<span class="Special">;</span>
     <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>EXPR<span class="Special">,</span>symbol<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>index_table_r<span class="Special">[</span>EXPR<span class="Special">])</span> <span class="Statement">then</span>
           <span class="Statement">return</span> index_table_r<span class="Special">[</span>EXPR<span class="Special">]</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;undefined index&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">=</span><span class="Constant">`+`</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">2</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to conver the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
          <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>

            <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>symbol<span class="Special">)</span> <span class="Statement">then</span>
               var<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span> num<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
               <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>index_table_r<span class="Special">[</span>var<span class="Special">])</span> <span class="Statement">then</span>
                  <span class="Statement">return</span> index_table_r<span class="Special">[</span>var<span class="Special">]</span>+num*stepsize_table<span class="Special">[</span>index_table_r<span class="Special">[</span>var<span class="Special">]]</span><span class="Special">;</span>
               <span class="Statement">else</span>
                  <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;undefined index&quot;</span><span class="Special">)</span><span class="Special">;</span>
               <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
            <span class="Statement">else</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

           <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>symbol<span class="Special">)</span> <span class="Statement">then</span>
              <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                 var<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span> num<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
                 <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>index_table_r<span class="Special">[</span>var<span class="Special">])</span> <span class="Statement">then</span>
                   <span class="Statement">return</span> index_table_r<span class="Special">[</span>var<span class="Special">]</span>+num*stepsize_table<span class="Special">[</span>index_table_r<span class="Special">[</span>var<span class="Special">]]</span><span class="Special">;</span>
                 <span class="Statement">else</span>
                   <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;undefined index&quot;</span><span class="Special">)</span><span class="Special">;</span>
                 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
              <span class="Statement">else</span>
                 <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">##################################################################</span>
<span class="Comment"># Inverse of DtoC, converts a continuous expression to discrete</span>
<span class="Comment"># (See DtoC for more details)</span>
<span class="Comment">#</span>
<span class="Comment">#     EXAMPLE:   for grid_function = {f,g}</span>
<span class="Comment">#             f(x)*g(y,z)  -&gt; f(i)*g(j,k)</span>
<span class="Comment">#             cos(y)*r(x)*(f(t-ht,x+hx)-f(t+ht,x-hx)/(ht*hx)  -&gt; </span>
<span class="Comment">#             cos(y(j))*r(x(i))*(f(n-1,i+1)-f(n+1,i-1)/(ht*hx)</span>
<span class="Comment">#</span>
<span class="Comment">#         INVALID INPUTS:</span>
<span class="Comment">#              f(i) , x(i)*f(x) , g(x(i)) </span>
<span class="Comment">#</span>
<span class="Comment">##################################################################</span>

Continuous_To_Discrete<span class="Special">:=</span>CtoD<span class="Special">;</span>

CtoD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>
   <span class="Statement">if</span> check_validity_c_expr<span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">then</span>
       <span class="Statement">return</span> CtoD_L<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">else</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid continuous expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

CtoD_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">,</span>grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>variable_set<span class="Special">))</span> <span class="Statement">then</span>
        <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> variable_set <span class="Statement">then</span>
           <span class="Statement">return</span> EXPR<span class="Special">(</span>index_table<span class="Special">[</span>EXPR<span class="Special">])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>CtoD_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">if</span> proper_cont_grid_func<span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>convert_arg_rev<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>CtoD_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">##########################</span>
<span class="Comment"># f(t+ht,x-2*hx) -&gt; true</span>
<span class="Comment"># f(i,x) -&gt; false</span>
<span class="Comment">##########################</span>

proper_cont_grid_func <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

      <span class="Statement">global</span> index_table<span class="Special">;</span>
      <span class="Statement">local</span> ii<span class="Special">,</span>var<span class="Special">;</span>
      var<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)]</span><span class="Special">;</span>

      <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">)</span> <span class="Statement">do</span>
          <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Statement">=</span><span class="Constant">`+`</span> <span class="Statement">then</span>

             <span class="Statement">if</span>  <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">2</span> <span class="Statement">then</span>
                  <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
             <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

             <span class="Statement">if</span>  <span class="Statement">not</span> <span class="Special">(</span> <span class="Special">(</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> variable_set <span class="Special">)</span> <span class="Statement">or</span> <span class="Special">(</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> variable_set<span class="Special">)</span>  <span class="Special">)</span> <span class="Statement">then</span>
                  <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
             <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

             <span class="Statement">if</span> <span class="Statement">not</span> <span class="Special">(</span> <span class="Statement">type</span><span class="Special">(</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span>/stepsize_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])]</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">or</span>  <span class="Statement">type</span><span class="Special">(</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span>/stepsize_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])]</span><span class="Special">,</span>integer<span class="Special">)</span>    <span class="Special">)</span>  <span class="Statement">then</span>
                  <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
             <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

          <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Statement">=</span><span class="Constant">`symbol`</span> <span class="Statement">then</span>
             <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span> var<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">in</span> variable_set<span class="Special">)</span> <span class="Statement">then</span>
                <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
             <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
          <span class="Statement">else</span>
            <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
      <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###################</span>
<span class="Comment">#  x+2*hx -&gt; i+2</span>
<span class="Comment">#  y -&gt; j</span>
<span class="Comment">#  z-hz -&gt; k-1</span>
<span class="Comment">##################</span>

convert_arg_rev <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>stepsize_table<span class="Special">;</span>
     <span class="Statement">local</span> var<span class="Special">,</span>num<span class="Special">;</span>
     <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>EXPR<span class="Special">,</span>symbol<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>index_table<span class="Special">[</span>EXPR<span class="Special">])</span> <span class="Statement">then</span>
           <span class="Statement">return</span> index_table<span class="Special">[</span>EXPR<span class="Special">]</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;undefined variable&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">=</span><span class="Constant">`+`</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">2</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to conver the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
          <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
            <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span>/stepsize_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)]</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
               num<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span>/stepsize_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)]</span><span class="Special">;</span> var<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
               <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>index_table<span class="Special">[</span>var<span class="Special">])</span> <span class="Statement">then</span>
                  <span class="Statement">return</span> index_table<span class="Special">[</span>var<span class="Special">]</span>+num<span class="Special">;</span>
               <span class="Statement">else</span>
                  <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;undefined variable&quot;</span><span class="Special">)</span><span class="Special">;</span>
               <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
            <span class="Statement">else</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

           <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
              <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span>/stepsize_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)]</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                 var<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span> num<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>EXPR<span class="Special">)</span>/stepsize_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>EXPR<span class="Special">)]</span><span class="Special">;</span>
                 <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>index_table<span class="Special">[</span>var<span class="Special">])</span> <span class="Statement">then</span>
                   <span class="Statement">return</span> index_table<span class="Special">[</span>var<span class="Special">]</span>+num<span class="Special">;</span>
                 <span class="Statement">else</span>
                   <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;undefined variable&quot;</span><span class="Special">)</span><span class="Special">;</span>
                 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
              <span class="Statement">else</span>
                 <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to convert the argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>



<span class="Comment">#####################################################################</span>
<span class="Comment"># Reduces time levels to functions for a given discrete FDA</span>
<span class="Comment"># Uses RNPL Standard notation f(n+3) -&gt; f_np3  f(n-2) -&gt; f_nm2</span>
<span class="Comment">#</span>
<span class="Comment">#   EXAMPLE:    grid_functions:={f,g}</span>
<span class="Comment">#               INPUT: ( f(n+1,i,j) - f(n-1,i,j) ) / (2*ht) </span>
<span class="Comment">#                        + g(n,i,j) + tan(y(j)/x(i))  + (f(n,i+1,j) - f(n,i-1,j) )/(2*hx)</span>
<span class="Comment">#</span>
<span class="Comment">#               OUTPUT: (f_np1(i,j) - f_nm1(i,j) )/(2*ht) + g_n(i,j) + ... + (f_n(i+1,j) - f_n(i-1,j)/...</span>
<span class="Comment">#</span>
<span class="Comment">#</span>
<span class="Comment">####################################################################</span>

Reduce_Time_Level<span class="Special">:=</span>RTL<span class="Special">;</span>

RTL <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>is_periodic<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>
    check_FD<span class="Special">()</span><span class="Special">;</span>

    <span class="Statement">if</span> check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span>is_periodic<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">return</span> RTL_L<span class="Special">(</span>EXPR<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">else</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


RTL_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>is_p<span class="Special">::</span>boolean<span class="Special">)</span>
     <span class="Statement">global</span> index_table_r<span class="Special">,</span>index_table<span class="Special">,</span>variable_set<span class="Special">,</span>grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
     <span class="Statement">global</span> plus_sign<span class="Special">,</span> minus_sign<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">,</span>pgfr<span class="Special">,</span>num<span class="Special">,</span>nn<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}))</span> <span class="Statement">then</span>
       <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">=</span> time_var_name <span class="Statement">then</span>
            <span class="Statement">return</span> gen_reduced_grid_func<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">else</span>
            <span class="Statement">return</span> EXPR<span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>RTL_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>is_p<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_p<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">return</span> gen_reduced_grid_func<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>RTL_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>is_p<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">##############################</span>
<span class="Comment"># f(n+2,i,j) -&gt; np12_f(i,j)</span>
<span class="Comment"># f(n-1,j) -&gt; nm1_f1(j)</span>
<span class="Comment"># f(n,i) -&gt; n_f(i)</span>
<span class="Comment"># f(n) -&gt; fn</span>
<span class="Comment"># t(n) -&gt; tn</span>
<span class="Comment"># t(n+1) -&gt; tnp1</span>
<span class="Comment"># f(i,j) -&gt; f(i,j)</span>
<span class="Comment">##############################</span>

gen_reduced_grid_func<span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>func<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>
   <span class="Statement">global</span> time_var_name<span class="Special">,</span>time_var_index<span class="Special">;</span>
   <span class="Statement">global</span> plus_sign<span class="Special">,</span>minus_sign<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">,</span>fname<span class="Special">,</span>varseq<span class="Special">,</span>vars<span class="Special">,</span>newvarseq<span class="Special">,</span>ti<span class="Special">,</span>tv<span class="Special">,</span>nf<span class="Special">,</span>num<span class="Special">;</span>

   fname<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>func<span class="Special">)</span><span class="Special">;</span>
   varseq<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span>func<span class="Special">)</span><span class="Special">;</span>
   vars<span class="Special">:=</span><span class="Special">[</span>varseq<span class="Special">]</span><span class="Special">;</span>
   newvarseq<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>

   ti<span class="Special">:=</span><span class="Constant">0</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>vars<span class="Special">)</span> <span class="Statement">do</span>
      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>vars<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>time_var_index<span class="Special">))</span> <span class="Statement">then</span>
        newvarseq<span class="Special">:=</span>newvarseq <span class="Special">,</span> vars<span class="Special">[</span>ii<span class="Special">]</span>
      <span class="Statement">else</span>
        ti<span class="Special">:=</span>ii<span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>


   <span class="Statement">if</span> ti <span class="Statement">=</span> <span class="Constant">0</span> <span class="Statement">then</span>
      <span class="Statement">return</span> func<span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   tv<span class="Special">:=</span>vars<span class="Special">[</span>ti<span class="Special">]</span><span class="Special">;</span>

   <span class="Statement">if</span> tv <span class="Statement">=</span> time_var_index <span class="Statement">then</span>
       nf<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tv<span class="Special">,</span>_<span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">if</span> <span class="Special">(</span> newvarseq <span class="Statement">&lt;&gt;</span> <span class="Special">NULL</span><span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">return</span> nf<span class="Special">(</span>newvarseq<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">else</span>
         <span class="Statement">return</span> <span class="Statement">cat</span><span class="Special">(</span>tv<span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>tv<span class="Special">)</span> <span class="Statement">=</span> time_var_index <span class="Statement">then</span>
      num<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>tv<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">else</span>
      num<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>tv<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> num <span class="Statement">&gt;</span> <span class="Constant">0</span> <span class="Statement">then</span>
      fname<span class="Special">;</span>
      time_var_index<span class="Special">;</span>
      plus_sign<span class="Special">;</span>
      num<span class="Special">;</span>
      newvarseq<span class="Special">;</span>
      nf<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>time_var_index<span class="Special">,</span>plus_sign<span class="Special">,</span>num<span class="Special">,</span>_<span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">if</span> <span class="Special">(</span> newvarseq <span class="Statement">&lt;&gt;</span> <span class="Special">NULL</span><span class="Special">)</span> <span class="Statement">then</span>
          <span class="Statement">return</span> nf<span class="Special">(</span>newvarseq<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">else</span>
          <span class="Statement">return</span> <span class="Statement">cat</span><span class="Special">(</span>time_var_index<span class="Special">,</span>plus_sign<span class="Special">,</span>num<span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">else</span>
      nf<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>time_var_index<span class="Special">,</span>minus_sign<span class="Special">,</span>-num<span class="Special">,</span>_<span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">if</span> <span class="Special">(</span> newvarseq <span class="Statement">&lt;&gt;</span> <span class="Special">NULL</span><span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">return</span> nf<span class="Special">(</span>newvarseq<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">else</span>
        <span class="Statement">return</span> <span class="Statement">cat</span><span class="Special">(</span>time_var_index<span class="Special">,</span>minus_sign<span class="Special">,</span>-num<span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###########################################################################</span>
<span class="Comment"># Adds index to SGFS using table: (to be used in FD)</span>
<span class="Comment"># global SGFS = table([g = [n], f = [i, j, k], q = [i, n], r = [j, k]])</span>
<span class="Comment">#</span>
<span class="Comment">#      x+y+z^2/x+f*g+cos(r)+f^2+g^(1/2)+f/g+rho(r,g)</span>
<span class="Comment">#</span>
<span class="Comment">#         -&gt; </span>
<span class="Comment">#     </span>
<span class="Comment">#      x(i)+y(j)+z(k)^2/x(i)+f(i,j,k)*g(n)+cos(r(j,k))</span>
<span class="Comment">#          +f(i,j,k)^2+g(n)^(1/2)+f(i,j,k)/g(n)</span>
<span class="Comment">#          +rho(r(j,k),g(n))</span>
<span class="Comment">###########################################################################</span>

Add_Index_to_SGFS <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span> <span class="Statement">algebraic</span><span class="Special">)</span>
     <span class="Statement">global</span> SGFS<span class="Special">,</span>ii<span class="Special">;</span>
     <span class="Statement">local</span> sgf<span class="Special">;</span>
     <span class="Statement">local</span> sgfl<span class="Special">;</span>

      check_FD<span class="Special">()</span><span class="Special">;</span>

     sgf<span class="Special">:=</span> apply_grid_func_to_index_in_table<span class="Special">(</span>SGFS<span class="Special">)</span><span class="Special">;</span>
     show_table<span class="Special">(</span>sgf<span class="Special">)</span><span class="Special">;</span>
     sgfl<span class="Special">:=</span><span class="Special">[</span><span class="Statement">indices</span><span class="Special">(</span>sgf<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)]</span><span class="Special">;</span>

     <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>sgfl<span class="Special">)</span> <span class="Statement">do</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>proper_grid_func<span class="Special">(</span>sgf<span class="Special">[</span>sgfl<span class="Special">[</span>ii<span class="Special">]]))</span> <span class="Statement">then</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;SGFS is not indexed properly&quot;</span><span class="Special">)</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid expression, contains index&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">return</span> Add_Index_to_SGFS_L<span class="Special">(</span>EXPR<span class="Special">,</span>sgf<span class="Special">)</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>



Add_Index_to_SGFS_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span> <span class="Statement">algebraic</span><span class="Special">,</span>sgf<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>

     <span class="Statement">global</span> index_table<span class="Special">,</span> variable_set<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span> <span class="Special">{</span><span class="Statement">indices</span><span class="Special">(</span>sgf<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">union</span> variable_set <span class="Special">))</span> <span class="Statement">then</span>
       <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> variable_set <span class="Statement">then</span>
           <span class="Statement">return</span> EXPR<span class="Special">(</span>index_table<span class="Special">[</span>EXPR<span class="Special">])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">indices</span><span class="Special">(</span>sgf<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
         <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>sgf<span class="Special">[</span>EXPR<span class="Special">])</span> <span class="Statement">then</span>
             <span class="Statement">return</span> sgf<span class="Special">[</span>EXPR<span class="Special">]</span><span class="Special">;</span>
         <span class="Statement">else</span>
             <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
         <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Add_Index_to_SGFS_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>sgf<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">else</span>

         <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">indices</span><span class="Special">(</span>sgf<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid use of SGFS in the expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

         <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Add_Index_to_SGFS_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>sgf<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>

     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#######################################################</span>
<span class="Comment"># A Finite Differencing Generic &quot;derivative&quot; operator</span>
<span class="Comment"># Using FD procedure</span>
<span class="Comment">#######################################################</span>

<span class="Comment"># Come back here!</span>


<span class="Comment">###################################################################################</span>
<span class="Comment"># SGFS = table([f=[n,i,k] , g=[i,j])</span>
<span class="Comment"># FD( f + g*y + x^2/z + rho(f,g)  , [[1],[1,2,0]] ) </span>
<span class="Comment">#       -&gt;</span>
<span class="Comment">#       f(n+1,i+1,k)+g(i+1,j+2)*y(j+2)+x(i+1)^2/z(k)+rho(f(n+1,i+1,k),g(i+1,j+2))</span>
<span class="Comment">#</span>
<span class="Comment">#</span>
<span class="Comment">###################################################################################</span>

FD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>stp<span class="Special">::</span>list<span class="Special">,</span><span class="Special">{</span>is_sgf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

      <span class="Statement">if</span> is_sgf <span class="Statement">then</span>
         <span class="Statement">return</span> FD_L<span class="Special">(</span>Add_Index_to_SGFS<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">,</span>stp<span class="Special">)</span> <span class="Special">;</span>
      <span class="Statement">else</span>
         <span class="Statement">return</span> FD_L<span class="Special">(</span>EXPR<span class="Special">,</span>stp<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">##############################################</span>
<span class="Comment"># Front end to Shift_FD</span>
<span class="Comment"># FD_L(f(n,i+1,j),[[1],[2,-1]]) = f(n+1,i+3,j-1)</span>
<span class="Comment">##############################################</span>


FD_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span> stp<span class="Special">::</span>list<span class="Special">)</span>

  <span class="Statement">local</span> st<span class="Special">,</span>ii<span class="Special">;</span>
  <span class="Statement">global</span> time_var_index<span class="Special">,</span>var_order_table<span class="Special">;</span>
  <span class="Statement">local</span> GFS<span class="Special">;</span>

  check_FD<span class="Special">()</span><span class="Special">;</span>

  <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">true</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


  st<span class="Special">:=</span>gen_shift_table<span class="Special">(</span>stp<span class="Special">)</span><span class="Special">;</span>


  GFS<span class="Special">:=</span>create_grid_func_expr_from_table<span class="Special">(</span>FGF<span class="Special">(</span>EXPR<span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">))</span><span class="Special">;</span>


  <span class="Comment"># Testing each &quot;grid&quot; function</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>GFS<span class="Special">)</span> <span class="Statement">do</span>
     Shift_FD<span class="Special">(</span>GFS<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>st<span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">:</span>
  <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

  <span class="Statement">return</span> Shift_FD<span class="Special">(</span>EXPR<span class="Special">,</span>st<span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#####################################</span>
<span class="Comment"># table([f=[i,j,k] , g=[i,j] , y=[j])</span>
<span class="Comment"># -&gt; {f(i,j,k),g(i,j),y(j)}</span>
<span class="Comment">#####################################</span>

create_grid_func_expr_from_table<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>g<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>
  <span class="Statement">local</span> gs<span class="Special">,</span>g_set<span class="Special">,</span>ii<span class="Special">,</span>jj<span class="Special">,</span>argss<span class="Special">;</span>
  gs<span class="Special">:=</span><span class="Special">[</span><span class="Statement">indices</span><span class="Special">(</span>g<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)]</span><span class="Special">;</span>
  g_set<span class="Special">:=</span><span class="Special">{}</span><span class="Special">;</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>gs<span class="Special">)</span> <span class="Statement">do</span>
    argss<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">:=</span> <span class="Statement">seq</span><span class="Special">(</span>g<span class="Special">[</span>gs<span class="Special">[</span>ii<span class="Special">]][</span>jj<span class="Special">]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>g<span class="Special">[</span>gs<span class="Special">[</span>ii<span class="Special">]]))</span><span class="Special">;</span>
    g_set<span class="Special">:=</span> g_set <span class="Statement">union</span> <span class="Special">{</span>gs<span class="Special">[</span>ii<span class="Special">](</span>argss<span class="Special">[</span>ii<span class="Special">])}</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  <span class="Statement">return</span> g_set<span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">##########################################</span>
<span class="Comment"># table([f=[i,j,k] , g=[i,j] , y=[j])</span>
<span class="Comment"># -&gt; table([f=f(i,j,k),g=g(i,j),y=y(j)]);</span>
<span class="Comment">##########################################</span>

apply_grid_func_to_index_in_table<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>g<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>
  <span class="Statement">local</span> gs<span class="Special">,</span>g_set<span class="Special">,</span>ii<span class="Special">,</span>jj<span class="Special">,</span>argss<span class="Special">;</span>
  gs<span class="Special">:=</span><span class="Special">[</span><span class="Statement">indices</span><span class="Special">(</span>g<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)]</span><span class="Special">;</span>
  g_set<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>gs<span class="Special">)</span> <span class="Statement">do</span>
    argss<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">:=</span> <span class="Statement">seq</span><span class="Special">(</span>g<span class="Special">[</span>gs<span class="Special">[</span>ii<span class="Special">]][</span>jj<span class="Special">]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>g<span class="Special">[</span>gs<span class="Special">[</span>ii<span class="Special">]]))</span><span class="Special">;</span>
    g_set<span class="Special">[</span>gs<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">:=</span> gs<span class="Special">[</span>ii<span class="Special">](</span>argss<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  <span class="Statement">return</span> g_set<span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">#################################################</span>
<span class="Comment"># [[2],[1,-1,2]] -&gt; table([n=2,i=1,j=-1,k=2])</span>
<span class="Comment"># [1,-1,2] -&gt; table([i=1,j=-1,k=2])</span>
<span class="Comment"># [1,-1] -&gt; table([i=1,j=-1])</span>
<span class="Comment"># [[3]] -&gt; table([n=3])</span>
<span class="Comment"># [[2,3]] -&gt; invalid</span>
<span class="Comment"># [1,2,3,4] -&gt; invalid</span>
<span class="Comment"># [[2],1,2,3,1] -&gt; invalid</span>
<span class="Comment">#################################################</span>
gen_shift_table <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>stp<span class="Special">::</span>list<span class="Special">)</span>
   <span class="Statement">local</span> st<span class="Special">,</span>ii<span class="Special">;</span>
   <span class="Statement">global</span> time_var_index<span class="Special">,</span>var_order_table<span class="Special">;</span>
   st <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>stp<span class="Special">,</span>list<span class="Special">(</span>list<span class="Special">(</span>integer<span class="Special">)))</span> <span class="Statement">then</span>

     <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>stp<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">1</span> <span class="Statement">then</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid second argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">else</span>
       st<span class="Special">[</span>time_var_index<span class="Special">]</span> <span class="Special">:=</span> stp<span class="Special">[</span><span class="Constant">1</span><span class="Special">][</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>stp<span class="Special">)</span> <span class="Statement">=</span> <span class="Constant">2</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>stp<span class="Special">[</span><span class="Constant">2</span><span class="Special">])</span> <span class="Statement">&gt;</span> <span class="Statement">nops</span><span class="Special">([</span><span class="Statement">entries</span><span class="Special">(</span>var_order_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)])</span><span class="Constant">-1</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid second argument, not enough variables defined for the operant&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>stp<span class="Special">[</span><span class="Constant">2</span><span class="Special">])</span> <span class="Statement">do</span>
           st<span class="Special">[</span>var_order_table<span class="Special">[</span>ii<span class="Constant">+1</span><span class="Special">]]</span> <span class="Special">:=</span> stp<span class="Special">[</span><span class="Constant">2</span><span class="Special">][</span>ii<span class="Special">]</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>stp<span class="Special">)</span> <span class="Statement">&gt;</span> <span class="Constant">2</span> <span class="Statement">then</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid second argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span>

  <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span>stp<span class="Special">,</span>list<span class="Special">(</span>integer<span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>stp<span class="Special">)</span> <span class="Statement">&gt;</span> <span class="Statement">nops</span><span class="Special">([</span><span class="Statement">entries</span><span class="Special">(</span>var_order_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)])</span><span class="Constant">-1</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid second argument, not enough variables defined for the operant&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">else</span>
        <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>stp<span class="Special">)</span> <span class="Statement">do</span>
           st<span class="Special">[</span>var_order_table<span class="Special">[</span>ii<span class="Constant">+1</span><span class="Special">]]</span> <span class="Special">:=</span> stp<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">do</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
  <span class="Statement">else</span>
    <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid second argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  <span class="Statement">return</span> st<span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">####################################################################</span>
<span class="Comment"># Shifts the FD for the given shifting table</span>
<span class="Comment">#  EXAMPLE:</span>
<span class="Comment">#</span>
<span class="Comment">#     INPUT: f(i,j)+g(x(i))+u(y(j+2))+z(k), table([i=2,j=3,k=2])</span>
<span class="Comment">#</span>
<span class="Comment">#     OUTPUT:f(i + 2, j + 3) + g(x(i + 2)) + u(y(j + 5)) + z(k + 2)</span>
<span class="Comment">#</span>
<span class="Comment">####################################################################</span>

SHFD <span class="Special">:=</span> Shift_FD<span class="Special">;</span>

Shift_FD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span> st<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span><span class="Special">{</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

    check_FD<span class="Special">()</span><span class="Special">;</span>
    <span class="Statement">if</span> check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">return</span> Shift_FD_L<span class="Special">(</span>EXPR<span class="Special">,</span>st<span class="Special">,</span>ignore_gf<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">else</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

Shift_FD_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span> st<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">)</span>

     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">,</span>grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">,</span>pgfr<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}))</span> <span class="Statement">then</span>
       <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span>shift_arg<span class="Special">([</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)]</span><span class="Special">,</span>st<span class="Special">))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
         <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Shift_FD_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>st<span class="Special">,</span>ignore_gf<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>ignore_gf<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>
              <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Shift_FD_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>st<span class="Special">,</span>ignore_gf<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">then</span>
                 <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span>shift_arg<span class="Special">([</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)]</span><span class="Special">,</span>st<span class="Special">))</span><span class="Special">;</span>
              <span class="Statement">else</span>
                 <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Shift_FD_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>st<span class="Special">,</span>ignore_gf<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">else</span>

           pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>

           <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
                  <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span>shift_arg<span class="Special">([</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)]</span><span class="Special">,</span>st<span class="Special">))</span><span class="Special">;</span>
           <span class="Statement">else</span>
                  <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>Shift_FD_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>st<span class="Special">,</span>ignore_gf<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">###########################################</span>
<span class="Comment"># shifts the argument according to st table</span>
<span class="Comment">#  [i,j+2,k] -&gt; [i-2,j+1,k+2] </span>
<span class="Comment">#  (for st: table([i=-2,j=-1,k=2]);</span>
<span class="Comment">###########################################</span>

shift_arg <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>gfargs<span class="Special">::</span>list<span class="Special">,</span>st<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>

      <span class="Statement">local</span> ii<span class="Special">,</span>var<span class="Special">;</span>
      <span class="Statement">local</span> intarg<span class="Special">;</span>
      <span class="Statement">local</span> newvarseq<span class="Special">;</span>
      var<span class="Special">:=</span>gfargs<span class="Special">;</span>

      newvarseq<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>
      <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>var<span class="Special">)</span> <span class="Statement">do</span>
          <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Statement">=</span><span class="Constant">`+`</span> <span class="Statement">then</span>

             <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
                  intarg<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
             <span class="Statement">else</span>
                  intarg<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
             <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

          <span class="Statement">elif</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>var<span class="Special">[</span>ii<span class="Special">])</span><span class="Statement">=</span><span class="Constant">`symbol`</span> <span class="Statement">then</span>
                intarg<span class="Special">:=</span>var<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
          <span class="Statement">else</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error!&quot;</span><span class="Special">)</span><span class="Special">;</span> <span class="Comment">#for debugging</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
          <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>st<span class="Special">[</span>intarg<span class="Special">])</span> <span class="Statement">then</span>
             newvarseq<span class="Special">:=</span> newvarseq <span class="Special">,</span> var<span class="Special">[</span>ii<span class="Special">]</span>+st<span class="Special">[</span>intarg<span class="Special">]</span><span class="Special">;</span>
          <span class="Statement">else</span>
             <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Cannot shift this argument: %a\n&quot;</span><span class="Special">,</span>gfargs<span class="Special">)</span><span class="Special">;</span>
             <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Shift table is provided for the following arguments: %a\n&quot;</span><span class="Special">,</span><span class="Special">[</span><span class="Statement">indices</span><span class="Special">(</span>st<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)])</span><span class="Special">;</span>
             <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid shift table&quot;</span><span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

      <span class="Statement">return</span> newvarseq<span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">######################################</span>
<span class="Comment"># Finds the stencil molecule structure</span>
<span class="Comment"># ####################################</span>

Find_Molecule_Structure<span class="Special">:=</span>FMS<span class="Special">;</span>

FMS <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>show_results<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">true</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>is_periodic<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>
    <span class="Statement">local</span> ii<span class="Special">;</span>
    <span class="Statement">global</span> mol_struct<span class="Special">;</span>
    check_FD<span class="Special">()</span><span class="Special">;</span>

    <span class="Statement">if</span> check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span> <span class="Statement">then</span>
       reset_mol<span class="Special">()</span><span class="Special">;</span>
       <span class="Statement">if</span> <span class="Special">(</span>show_results<span class="Special">)</span> <span class="Statement">then</span>
          FMS_L<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
          Show_Mol<span class="Special">()</span><span class="Special">;</span>
       <span class="Statement">else</span>
          FMS_L<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">return</span> mol_struct<span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">else</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

FMS_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>igf<span class="Special">::</span>boolean<span class="Special">,</span>is_periodic<span class="Special">::</span>boolean<span class="Special">)</span>

     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">,</span>grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> stepsize_table<span class="Special">,</span> mol_struct<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to find molecule structure&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
        <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>FMS_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>igf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
           add_to_mol<span class="Special">(</span>EXPR<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>igf<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>FMS_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>igf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_periodic<span class="Special">)</span> <span class="Statement">then</span>
              add_to_mol<span class="Special">(</span>EXPR<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>FMS_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>igf<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
              <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">else</span>
           <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_periodic<span class="Special">)</span> <span class="Statement">then</span>
              add_to_mol<span class="Special">(</span>EXPR<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>FMS_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>igf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
              <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

add_to_mol <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>is_periodic<span class="Special">::</span>boolean<span class="Special">)</span>
    <span class="Statement">global</span> mol_struct<span class="Special">;</span>
    <span class="Statement">local</span> pgfr<span class="Special">,</span>nums<span class="Special">;</span>
    <span class="Statement">local</span> vars<span class="Special">,</span>ii<span class="Special">;</span>
    <span class="Statement">global</span> shape_table<span class="Special">;</span>
    <span class="Statement">local</span> invt<span class="Special">;</span>
    pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
    nums<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)]</span><span class="Special">;</span>
    vars<span class="Special">:=</span>pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
    invt<span class="Special">:=</span><span class="Constant">true</span><span class="Special">;</span>

    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>nums<span class="Special">)</span> <span class="Statement">do</span>
       nums<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">:=</span>nums<span class="Special">[</span>ii<span class="Special">]</span> - vars<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
       <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">type</span><span class="Special">(</span>nums<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
          <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>nums<span class="Special">[</span>ii<span class="Special">]</span>-shape_table<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
            nums<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">:=</span>nums<span class="Special">[</span>ii<span class="Special">]</span>-shape_table<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]]</span><span class="Constant">+1</span><span class="Special">;</span>
            invt<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
          <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>nums<span class="Special">[</span>ii<span class="Special">]</span>+shape_table<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
            nums<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">:=</span>nums<span class="Special">[</span>ii<span class="Special">]</span>+shape_table<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]]</span><span class="Constant">-1</span><span class="Special">;</span>
            invt<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
          <span class="Statement">if</span> invt <span class="Statement">then</span>
            <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Unable to find mol struct for: %a\n&quot;</span><span class="Special">,</span>nums<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;add_to_mol failed&quot;</span><span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
       <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>mol_struct<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]][</span>nums<span class="Special">[</span>ii<span class="Special">]])</span> <span class="Statement">then</span>
         mol_struct<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]][</span>nums<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">:=</span> mol_struct<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]][</span>nums<span class="Special">[</span>ii<span class="Special">]]</span><span class="Constant">+1</span><span class="Special">;</span>
       <span class="Statement">else</span>
         mol_struct<span class="Special">[</span>vars<span class="Special">[</span>ii<span class="Special">]][</span>nums<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Constant">1</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

reset_mol <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

    <span class="Statement">global</span> mol_struct<span class="Special">,</span>variable_set<span class="Special">,</span>index_table<span class="Special">;</span>
    <span class="Statement">local</span> ii<span class="Special">;</span>
    mol_struct<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
<span class="Comment">#    for ii from 1 to nops(variable_set) do</span>
<span class="Comment">#         mol_struct[index_table[variable_set[ii]]] := table([]);</span>
<span class="Comment">#    end do;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">############################################</span>
<span class="Comment"># &quot;finds&quot; grid functions from a discrete FDA</span>
<span class="Comment">############################################</span>

Find_Grid_Functions<span class="Special">:=</span>FGF<span class="Special">;</span>

FGF <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>show_results<span class="Special">:=</span><span class="Constant">true</span><span class="Special">,</span>is_periodic<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

    <span class="Statement">global</span> grid_func_table<span class="Special">;</span>
    check_FD<span class="Special">()</span><span class="Special">;</span>

    grid_func_table<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

    <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">true</span><span class="Special">,</span>is_periodic<span class="Special">))</span> <span class="Statement">then</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    FGF_L<span class="Special">(</span>EXPR<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">if</span> show_results <span class="Statement">then</span>
       <span class="Statement">return</span> <span class="Special">{</span><span class="Statement">indices</span><span class="Special">(</span>grid_func_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span><span class="Special">;</span>
    <span class="Statement">else</span>
       <span class="Statement">return</span> grid_func_table<span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

FGF_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>is_p<span class="Special">::</span>boolean<span class="Special">)</span>

     <span class="Statement">global</span> grid_func_table<span class="Special">;</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to find grid functions, an invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
           <span class="Statement">return</span> alltrue<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>FGF_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>is_p<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Comment">##AAK</span>
     pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_p<span class="Special">)</span><span class="Special">;</span>

     <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>grid_func_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)])</span> <span class="Statement">then</span>
              <span class="Statement">if</span> grid_func_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)]</span> <span class="Statement">&lt;&gt;</span> pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span> <span class="Statement">then</span>
                  <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid expression, a grid function is indexed inconsistently&quot;</span><span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
        <span class="Statement">else</span>
           grid_func_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)]</span> <span class="Special">:=</span> pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
           <span class="Statement">return</span> alltrue<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>FGF_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>is_p<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">##############################################</span>
<span class="Comment">#  Generates a periodic version of an stencil</span>
<span class="Comment">##############################################</span>

check_GF <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>
   <span class="Statement">global</span> grid_functions<span class="Special">;</span>
   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">assigned</span><span class="Special">(</span>grid_functions<span class="Special">))</span> <span class="Statement">then</span>
     <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;grid_functions not defined&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

A_FD_Even <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>fn<span class="Special">::</span>set<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>
   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;forward&quot;</span> <span class="Statement">then</span>
       <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;backward&quot;</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Scheme not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   A_FD_Even_L<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>fn<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

A_FD_Even_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>fn<span class="Special">::</span>set<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

     <span class="Statement">global</span> grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to parse the expression, an invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>index_table<span class="Special">[</span>var<span class="Special">]))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> fn <span class="Statement">then</span>
          <span class="Statement">return</span> make_fda_even<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>A_FD_Even_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>fn<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions <span class="Statement">then</span>
        pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
          <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> fn <span class="Statement">then</span>
            <span class="Statement">return</span> make_fda_even<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">else</span>
            <span class="Statement">return</span> EXPR<span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid grid function expression detected&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>A_FD_Even_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>fn<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


FD_Even <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>
   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;forward&quot;</span> <span class="Statement">then</span>
       <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;backward&quot;</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Scheme not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   FD_Even_L<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

FD_Even_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

     <span class="Statement">global</span> grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to parse the expression, an invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>index_table<span class="Special">[</span>var<span class="Special">]))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
          <span class="Statement">return</span> make_fda_even<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>FD_Even_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions <span class="Statement">then</span>
        pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
            <span class="Statement">return</span> make_fda_even<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid grid function expression detected&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>FD_Even_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

A_FD_Odd <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>fn<span class="Special">::</span>set<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>
   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;forward&quot;</span> <span class="Statement">then</span>
       <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;backward&quot;</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Scheme not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   A_FD_Odd_L<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>fn<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

A_FD_Odd_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>fn<span class="Special">::</span>set<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

     <span class="Statement">global</span> grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to parse the expression, an invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>index_table<span class="Special">[</span>var<span class="Special">]))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> fn <span class="Statement">then</span>
          <span class="Statement">return</span> make_fda_odd<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>A_FD_Odd_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>fn<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions <span class="Statement">then</span>
        pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
          <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> fn <span class="Statement">then</span>
            <span class="Statement">return</span> make_fda_odd<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">else</span>
            <span class="Statement">return</span> EXPR<span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span>
        <span class="Statement">else</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid grid function expression detected&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>A_FD_Odd_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>fn<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


FD_Odd <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>
   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;forward&quot;</span> <span class="Statement">then</span>
       <span class="Statement">if</span> ss<span class="Statement">&lt;&gt;</span><span class="Constant">&quot;backward&quot;</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Scheme not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   FD_Odd_L<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

FD_Odd_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>var<span class="Special">::</span>symbol<span class="Special">,</span>shift<span class="Special">::</span>integer<span class="Special">,</span>ss<span class="Special">::</span>string<span class="Special">)</span>

     <span class="Statement">global</span> grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to parse the expression, an invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>index_table<span class="Special">[</span>var<span class="Special">]))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
          <span class="Statement">return</span> make_fda_odd<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>FD_Odd_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions <span class="Statement">then</span>
        pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
            <span class="Statement">return</span> make_fda_odd<span class="Special">(</span>EXPR<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid grid function expression detected&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>FD_Odd_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

make_fda_odd <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>func<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span>

   <span class="Statement">global</span> index_table<span class="Special">;</span>
   <span class="Statement">local</span> margs<span class="Special">,</span> fname<span class="Special">,</span> pgfr<span class="Special">,</span> indxs<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">,</span> newargs<span class="Special">,</span> fn<span class="Special">,</span>oldargs<span class="Special">;</span>
   <span class="Statement">local</span> flipped<span class="Special">;</span>

   flipped <span class="Special">:=</span> <span class="Constant">false</span><span class="Special">;</span>
   margs<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>func<span class="Special">)]</span><span class="Special">;</span>
   oldargs<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span>func<span class="Special">)</span><span class="Special">;</span>
   fname<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>func<span class="Special">)</span><span class="Special">;</span>
   pgfr <span class="Special">:=</span> proper_grid_func<span class="Special">(</span>func<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
   indxs <span class="Special">:=</span> pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>indxs<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">then</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, please report this!&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">do</span>
     <span class="Statement">if</span> indxs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">=</span> index_table<span class="Special">[</span>var<span class="Special">]</span> <span class="Statement">then</span>
        fn <span class="Special">:=</span> <span class="Statement">eval</span><span class="Special">(</span>margs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span><span class="Special">{</span>indxs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">0</span><span class="Special">})</span><span class="Special">;</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">type</span><span class="Special">(</span>fn<span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, please report this!&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        fn <span class="Special">:=</span> fn - shift<span class="Special">;</span>
        <span class="Statement">if</span> <span class="Special">(</span> ss <span class="Statement">=</span> <span class="Constant">&quot;forward&quot;</span> <span class="Special">)</span> <span class="Statement">then</span>
          fn <span class="Special">:=</span> <span class="Statement">abs</span><span class="Special">(</span>fn<span class="Special">)</span> + shift<span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">if</span> <span class="Special">(</span> ss <span class="Statement">=</span> <span class="Constant">&quot;backward&quot;</span> <span class="Special">)</span> <span class="Statement">then</span>
          fn <span class="Special">:=</span> -<span class="Statement">abs</span><span class="Special">(</span>fn<span class="Special">)</span> + shift<span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        margs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">:=</span> indxs<span class="Special">[</span>ii<span class="Special">]</span> + fn<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>


   newargs<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">do</span>
      newargs<span class="Special">:=</span>newargs <span class="Special">,</span> margs<span class="Special">[</span>ii<span class="Special">]</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">do</span>
     <span class="Statement">if</span> <span class="Special">(</span> newargs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">&lt;&gt;</span> oldargs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">)</span> <span class="Statement">then</span>
        flipped <span class="Special">:=</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">if</span> flipped <span class="Statement">then</span>
    <span class="Statement">return</span> -fname<span class="Special">(</span>newargs<span class="Special">)</span>
   <span class="Statement">else</span>
    <span class="Statement">return</span> fname<span class="Special">(</span>newargs<span class="Special">)</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>




make_fda_even <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>func<span class="Special">,</span>var<span class="Special">,</span>shift<span class="Special">,</span>ss<span class="Special">)</span>

   <span class="Statement">global</span> index_table<span class="Special">;</span>
   <span class="Statement">local</span> margs<span class="Special">,</span> fname<span class="Special">,</span> pgfr<span class="Special">,</span> indxs<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">,</span> newargs<span class="Special">,</span> fn<span class="Special">;</span>

   margs<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>func<span class="Special">)]</span><span class="Special">;</span>
   fname<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>func<span class="Special">)</span><span class="Special">;</span>
   pgfr <span class="Special">:=</span> proper_grid_func<span class="Special">(</span>func<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
   indxs <span class="Special">:=</span> pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>indxs<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">then</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, please report this!&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">do</span>
     <span class="Statement">if</span> indxs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">=</span> index_table<span class="Special">[</span>var<span class="Special">]</span> <span class="Statement">then</span>
        fn <span class="Special">:=</span> <span class="Statement">eval</span><span class="Special">(</span>margs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span><span class="Special">{</span>indxs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">0</span><span class="Special">})</span><span class="Special">;</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">type</span><span class="Special">(</span>fn<span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, please report this!&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        fn <span class="Special">:=</span> fn - shift<span class="Special">;</span>
        <span class="Statement">if</span> <span class="Special">(</span> ss <span class="Statement">=</span> <span class="Constant">&quot;forward&quot;</span> <span class="Special">)</span> <span class="Statement">then</span>
          fn <span class="Special">:=</span> <span class="Statement">abs</span><span class="Special">(</span>fn<span class="Special">)</span> + shift<span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">if</span> <span class="Special">(</span> ss <span class="Statement">=</span> <span class="Constant">&quot;backward&quot;</span> <span class="Special">)</span> <span class="Statement">then</span>
          fn <span class="Special">:=</span> -<span class="Statement">abs</span><span class="Special">(</span>fn<span class="Special">)</span> + shift<span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        margs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">:=</span> indxs<span class="Special">[</span>ii<span class="Special">]</span> + fn<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>


   newargs<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">do</span>
      newargs<span class="Special">:=</span>newargs <span class="Special">,</span> margs<span class="Special">[</span>ii<span class="Special">]</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Statement">return</span> fname<span class="Special">(</span>newargs<span class="Special">)</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

FD_Periodic <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>which_indx<span class="Special">::</span>set<span class="Special">(</span>equation<span class="Special">))</span>

    <span class="Statement">local</span> tbl<span class="Special">;</span>
    <span class="Statement">local</span> res<span class="Special">;</span>

    check_FD<span class="Special">()</span><span class="Special">;</span>
    tbl <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>


    <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    tbl <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Statement">convert</span><span class="Special">(</span>which_indx<span class="Special">,</span>list<span class="Special">))</span><span class="Special">;</span>

    res<span class="Special">:=</span> FD_Periodic_L<span class="Special">(</span>EXPR<span class="Special">,</span>tbl<span class="Special">)</span><span class="Special">;</span>

    <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Constant">true</span><span class="Special">))</span> <span class="Statement">then</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, Please report this as a bug&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">return</span> res<span class="Special">;</span>



<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


FD_Periodic_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>which_indx<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>

     <span class="Statement">global</span> grid_functions<span class="Special">;</span>
     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}))</span> <span class="Statement">then</span>
          <span class="Statement">return</span> EXPR<span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to parse the expression, an invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
          <span class="Statement">return</span> make_func_periodic<span class="Special">(</span>EXPR<span class="Special">,</span>which_indx<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>FD_Periodic_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>which_indx<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions <span class="Statement">then</span>
        pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
            <span class="Statement">return</span> make_func_periodic<span class="Special">(</span>EXPR<span class="Special">,</span>which_indx<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid grid function expression detected&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
        <span class="Statement">return</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)(</span><span class="Statement">seq</span><span class="Special">(</span>FD_Periodic_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>which_indx<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


make_func_periodic <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>func<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span> which_indx<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>

   <span class="Statement">local</span> pgfr<span class="Special">;</span>
   <span class="Statement">local</span> margs<span class="Special">,</span> ii<span class="Special">;</span>
   <span class="Statement">local</span> fn<span class="Special">,</span>indxs<span class="Special">;</span>
   <span class="Statement">local</span> fname<span class="Special">;</span>
   <span class="Statement">local</span> newargs<span class="Special">;</span>

   margs<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>func<span class="Special">)]</span><span class="Special">;</span>
   fname<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>func<span class="Special">)</span><span class="Special">;</span>
   pgfr <span class="Special">:=</span> proper_grid_func<span class="Special">(</span>func<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
   indxs <span class="Special">:=</span> pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>indxs<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">then</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, please report this!&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">do</span>
    <span class="Statement">if</span> <span class="Special">(</span><span class="Statement">assigned</span><span class="Special">(</span>which_indx<span class="Special">[</span>indxs<span class="Special">[</span>ii<span class="Special">]]))</span> <span class="Statement">then</span>

     <span class="Statement">if</span> <span class="Special">(</span>which_indx<span class="Special">[</span>indxs<span class="Special">[</span>ii<span class="Special">]]</span><span class="Statement">=</span><span class="Constant">1</span><span class="Special">)</span> <span class="Statement">then</span>
        fn <span class="Special">:=</span> <span class="Statement">eval</span><span class="Special">(</span>margs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span> <span class="Special">{</span>indxs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">1</span><span class="Special">})</span><span class="Special">;</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">type</span><span class="Special">(</span>fn<span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, please report this!&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">if</span> fn <span class="Statement">&lt;=</span> <span class="Constant">0</span>  <span class="Statement">then</span>
           margs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">:=</span> margs<span class="Special">[</span>ii<span class="Special">]</span> + shape_table<span class="Special">[</span>indxs<span class="Special">[</span>ii<span class="Special">]]</span> - <span class="Constant">1</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Special">(</span>which_indx<span class="Special">[</span>indxs<span class="Special">[</span>ii<span class="Special">]]</span><span class="Statement">=</span>shape_table<span class="Special">[</span>indxs<span class="Special">[</span>ii<span class="Special">]])</span> <span class="Statement">then</span>
        fn <span class="Special">:=</span> <span class="Statement">eval</span><span class="Special">(</span>margs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span> <span class="Special">{</span>indxs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">=</span> <span class="Constant">0</span><span class="Special">})</span><span class="Special">;</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">type</span><span class="Special">(</span>fn<span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error, please report this!&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">if</span> fn <span class="Statement">&gt;</span> <span class="Constant">0</span>  <span class="Statement">then</span>
           margs<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">:=</span> margs<span class="Special">[</span>ii<span class="Special">]</span> - shape_table<span class="Special">[</span>indxs<span class="Special">[</span>ii<span class="Special">]]</span> + <span class="Constant">1</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   newargs<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>margs<span class="Special">)</span> <span class="Statement">do</span>
      newargs<span class="Special">:=</span>newargs <span class="Special">,</span> margs<span class="Special">[</span>ii<span class="Special">]</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Statement">return</span> fname<span class="Special">(</span>newargs<span class="Special">)</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">############################################</span>
<span class="Comment"># &quot;finds&quot; the parameters in a discrete FDA</span>
<span class="Comment">############################################</span>

Find_Params<span class="Special">:=</span>FPRM<span class="Special">;</span>

FPRM <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">}</span><span class="Special">,</span>is_periodic<span class="Special">)</span>

    <span class="Statement">global</span> FD_params<span class="Special">,</span>stepsize_table<span class="Special">;</span>
    check_FD<span class="Special">()</span><span class="Special">;</span>

    <span class="Statement">if</span> check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span> <span class="Statement">then</span>
       FD_params<span class="Special">:=</span><span class="Special">{}</span><span class="Special">;</span>
       FPRM_L<span class="Special">(</span>EXPR<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">return</span> FD_params<span class="Special">;</span>
    <span class="Statement">else</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

FPRM_L <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>is_periodic<span class="Special">::</span>boolean<span class="Special">)</span>

     <span class="Statement">global</span> index_table<span class="Special">,</span>variable_set<span class="Special">;</span>
     <span class="Statement">global</span> FD_params<span class="Special">,</span>known_functions<span class="Special">;</span>
     <span class="Statement">local</span> ii<span class="Special">;</span>
     <span class="Statement">local</span> pgfr<span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>EXPR<span class="Special">,</span>numeric<span class="Special">)</span> <span class="Statement">then</span>
          <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Statement">=</span><span class="Constant">`symbol`</span> <span class="Statement">then</span>
        FD_params<span class="Special">:=</span>FD_params <span class="Statement">union</span> <span class="Special">{</span>EXPR<span class="Special">}</span><span class="Special">;</span>
        <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to find parameters, an invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_periodic<span class="Special">)</span><span class="Special">;</span>

     <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
          <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">else</span>
           <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions<span class="Special">)</span> <span class="Statement">then</span>
                FD_params<span class="Special">:=</span> FD_params <span class="Statement">union</span> <span class="Special">{</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)}</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">return</span> alltrue<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>FPRM_L<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#########################################################</span>
<span class="Comment"># Front end for Gen_Code_L</span>
<span class="Comment"># Generates a pointwise evaluator for a given expression</span>
<span class="Comment">#########################################################</span>

GEC<span class="Special">:=</span>Gen_Eval_Code<span class="Special">;</span>

Gen_Eval_Code<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>input<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;c&quot;</span><span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;auto&quot;</span><span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;eval_func&quot;</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

  <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span>  <span class="Statement">then</span>
     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  Gen_Code_L<span class="Special">(</span>EXPR<span class="Special">,</span>input<span class="Special">,</span><span class="Constant">&quot;initializer&quot;</span><span class="Special">,</span>output<span class="Special">,</span>optm<span class="Special">,</span>proc_name<span class="Special">,</span>ignore_gf<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">##################################</span>
<span class="Comment"># Simple fortran code generator to</span>
<span class="Comment"># evaluate [norm] of the residual </span>
<span class="Comment"># for a given PDE expression</span>
<span class="Comment"># front end for Gen_Code_L</span>
<span class="Comment">##################################</span>

GRC<span class="Special">:=</span>Gen_Res_Code<span class="Special">;</span>

Gen_Res_Code<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span><span class="Special">{</span>input<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;c&quot;</span><span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;auto&quot;</span><span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;eval_resid&quot;</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>is_periodic<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

  <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span>  <span class="Statement">then</span>
     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


  Gen_Code_L<span class="Special">(</span>EXPR<span class="Special">,</span>input<span class="Special">,</span><span class="Constant">&quot;residual&quot;</span><span class="Special">,</span>output<span class="Special">,</span>optm<span class="Special">,</span>proc_name<span class="Special">,</span>ignore_gf<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">##############################</span>
<span class="Comment"># Front end to Gen_Code_LL</span>
<span class="Comment"># Handles files</span>
<span class="Comment">##############################</span>

Gen_Code_L<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>input<span class="Special">::</span>string<span class="Special">,</span>gen_form<span class="Special">::</span>string<span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">,</span>igf<span class="Special">::</span>boolean<span class="Special">)</span>
  <span class="Statement">local</span> code_str<span class="Special">,</span>header_str<span class="Special">,</span>call_str<span class="Special">;</span>
  <span class="Statement">local</span> fp<span class="Special">;</span>
  <span class="Statement">local</span> fname<span class="Special">;</span>
  <span class="Statement">local</span> all_codes<span class="Special">;</span>

  all_codes<span class="Special">:=</span>Gen_Code_LL<span class="Special">(</span>EXPR<span class="Special">,</span>input<span class="Special">,</span>optm<span class="Special">,</span>proc_name<span class="Special">,</span>gen_form<span class="Special">,</span>igf<span class="Special">)</span><span class="Special">;</span>
  code_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
  header_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
  call_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">3</span><span class="Special">]</span><span class="Special">;</span>

  <span class="Statement">if</span> output <span class="Statement">=</span> <span class="Constant">&quot;auto&quot;</span> <span class="Statement">then</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;.f&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Fortran Code is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;.h&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>header_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C header is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;_call&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>call_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C call is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

  <span class="Statement">elif</span> output <span class="Statement">=</span> <span class="Constant">&quot;&quot;</span> <span class="Statement">then</span>
     <span class="Statement">printf</span><span class="Special">(</span>header_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span>call_str<span class="Special">)</span><span class="Special">;</span>

  <span class="Statement">elif</span> output <span class="Statement">=</span> <span class="Constant">&quot;return&quot;</span> <span class="Statement">then</span>
      <span class="Statement">return</span> <span class="Special">[</span>header_str<span class="Special">,</span> code_str<span class="Special">,</span> call_str<span class="Special">]</span><span class="Special">;</span>

  <span class="Statement">else</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;.f&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Fortran Code is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;.h&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>header_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C header is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;_call&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>call_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C call is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>


  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">########################################</span>
<span class="Comment"># Front end to Gen_Code_LLL</span>
<span class="Comment"># Handles doing the FD and </span>
<span class="Comment"># passing proper names to code generator</span>
<span class="Comment">########################################</span>

Gen_Code_LL<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>input<span class="Special">::</span>string<span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">,</span>gen_form<span class="Special">::</span>string<span class="Special">,</span>igf<span class="Special">::</span>boolean<span class="Special">)</span>
   <span class="Statement">global</span> shape_table<span class="Special">;</span>
   <span class="Statement">local</span> shape_set<span class="Special">,</span>GFST<span class="Special">,</span>GFS<span class="Special">,</span>stepsize<span class="Special">,</span>boundary_index<span class="Special">,</span> indexes<span class="Special">,</span> FDA_STRUCT<span class="Special">,</span>params<span class="Special">;</span>
   <span class="Statement">local</span> shp_tbl<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">,</span>stencil<span class="Special">;</span>
   <span class="Statement">local</span> res<span class="Special">;</span>
   <span class="Statement">local</span> shape_seq<span class="Special">,</span> boundary_seq<span class="Special">;</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>

   res<span class="Special">:=</span><span class="Statement">'res'</span><span class="Special">;</span>
   <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;c&quot;</span> <span class="Statement">then</span>
      stencil<span class="Special">:=</span>Gen_Sten<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">elif</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span> <span class="Statement">then</span>
      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>igf<span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      stencil<span class="Special">:=</span>EXPR<span class="Special">;</span>
   <span class="Statement">else</span>
     <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;input not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   shp_tbl<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
   GFST <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
   shape_seq<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>
   boundary_seq<span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>

   params<span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span>FPRM<span class="Special">(</span>stencil<span class="Special">,</span>ignore_gf<span class="Statement">=</span>igf<span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">,</span>list<span class="Special">)</span><span class="Special">;</span>

   FDA_STRUCT<span class="Special">:=</span>FMS<span class="Special">(</span>stencil<span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span>igf<span class="Special">)</span><span class="Special">;</span>
   indexes<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">({</span><span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})]</span><span class="Special">;</span>

   <span class="Statement">if</span> time_var_index <span class="Statement">in</span> <span class="Statement">convert</span><span class="Special">(</span>indexes<span class="Special">,</span>set<span class="Special">)</span> <span class="Statement">then</span>
       stencil<span class="Special">:=</span>RTL<span class="Special">(</span>stencil<span class="Special">)</span><span class="Special">;</span>
       FDA_STRUCT<span class="Special">:=</span>FMS<span class="Special">(</span>stencil<span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
       indexes<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">({</span><span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})]</span><span class="Special">;</span>
       params<span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span>FPRM<span class="Special">(</span>stencil<span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">,</span>list<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   GFST<span class="Special">:=</span>FGF<span class="Special">(</span>stencil<span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">;</span>
   GFS <span class="Special">:=</span> <span class="Special">[</span> <span class="Statement">indices</span><span class="Special">(</span>GFST<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)</span> <span class="Special">]</span><span class="Special">;</span>



     <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
          boundary_seq <span class="Special">:=</span> boundary_seq <span class="Special">,</span>  <span class="Special">[</span><span class="Statement">min</span><span class="Special">(</span> <span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)</span> <span class="Special">)</span><span class="Special">,</span> <span class="Statement">max</span><span class="Special">(</span> <span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)</span> <span class="Special">)]</span><span class="Special">;</span>
          shape_seq <span class="Special">:=</span> shape_seq <span class="Special">,</span>  shape_table<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
     shape_set<span class="Special">:=</span><span class="Special">[</span>shape_seq<span class="Special">]</span><span class="Special">;</span>
     boundary_index<span class="Special">:=</span><span class="Special">[</span>boundary_seq<span class="Special">]</span><span class="Special">;</span>

     <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>GFS<span class="Special">)</span> <span class="Statement">do</span>
          shp_tbl<span class="Special">[</span>GFS<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>shape_table<span class="Special">[</span>GFST<span class="Special">[</span>GFS<span class="Special">[</span>ii<span class="Special">]][</span>jj<span class="Special">]]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>GFST<span class="Special">[</span>GFS<span class="Special">[</span>ii<span class="Special">]]))]</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

     GFS <span class="Special">:=</span> <span class="Statement">sort</span><span class="Special">(</span>GFS<span class="Special">)</span><span class="Special">;</span>
     params <span class="Special">:=</span> <span class="Statement">sort</span><span class="Special">(</span>params<span class="Special">)</span><span class="Special">;</span>

     <span class="Statement">return</span> Gen_Code_LLL<span class="Special">(</span>shp_tbl<span class="Special">,</span>shape_set<span class="Special">,</span>GFS<span class="Special">,</span>indexes<span class="Special">,</span>stencil<span class="Special">,</span>boundary_index<span class="Special">,</span>proc_name<span class="Special">,</span>params<span class="Special">,</span>res<span class="Special">,</span>optm<span class="Special">,</span>gen_form<span class="Special">)</span><span class="Special">;</span>



<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">################################################################</span>
<span class="Comment"># Generates a Fortran code and C header</span>
<span class="Comment"># to compute an FD expression pointwise or summed (l2norm etc..)</span>
<span class="Comment">################################################################</span>

Gen_Code_LLL<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>shape<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>shape_set<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>grid_funcs<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>indexes<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>stencil<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>boundary_index<span class="Special">::</span>list<span class="Special">(</span>list<span class="Special">(</span>integer<span class="Special">))</span><span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">,</span>params<span class="Special">::</span>list<span class="Special">,</span>result_name<span class="Special">::</span>symbol<span class="Special">,</span>opt<span class="Special">::</span>boolean<span class="Special">,</span>gen_form<span class="Special">::</span>string<span class="Special">)</span>

 <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">;</span>
 <span class="Statement">local</span> all_stuff<span class="Special">;</span>
 <span class="Statement">local</span> res_pp_FD<span class="Special">;</span>
 <span class="Statement">local</span> stencil2<span class="Special">;</span>
 <span class="Statement">local</span> code_str<span class="Special">,</span>code_str2<span class="Special">;</span>
 <span class="Statement">local</span> code_str3<span class="Special">;</span>
 <span class="Statement">local</span> tss<span class="Special">;</span>

 res_pp_FD<span class="Special">:=</span><span class="Statement">'qb'</span><span class="Special">;</span>

 code_str2<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span><span class="Constant">&quot;void &quot;</span><span class="Special">,</span>proc_name<span class="Special">,</span><span class="Constant">&quot;_(&quot;</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a,&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int *%a,&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a,&quot;</span><span class="Special">,</span>params<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">))</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a);\n&quot;</span><span class="Special">,</span>result_name<span class="Special">))</span><span class="Special">;</span>

 code_str3<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;_(&quot;</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a,&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;&amp;%a,&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;&amp;%a,&quot;</span><span class="Special">,</span>params<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">))</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a);\n&quot;</span><span class="Special">,</span>result_name<span class="Special">))</span><span class="Special">;</span>

  all_stuff<span class="Special">:=</span> <span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">))</span><span class="Special">,</span> <span class="Statement">seq</span><span class="Special">(</span>shape_set<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span> <span class="Special">,</span> <span class="Statement">seq</span><span class="Special">(</span>params<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">))</span> <span class="Special">,</span> result_name<span class="Special">]</span><span class="Special">;</span>

 code_str<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>
 tss<span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span><span class="Constant">&quot;subroutine &quot;</span><span class="Special">,</span> proc_name<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;(&quot;</span><span class="Special">)</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a,&quot;</span><span class="Special">,</span>all_stuff<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>all_stuff<span class="Special">)</span><span class="Constant">-1</span><span class="Special">)</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a)&quot;</span><span class="Special">,</span>all_stuff<span class="Special">[</span><span class="Statement">nops</span><span class="Special">(</span>all_stuff<span class="Special">)])</span> <span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 tss<span class="Special">:=</span><span class="Constant">&quot;implicit none&quot;</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;integer %a&quot;</span><span class="Special">,</span>indexes<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;integer %a&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a&quot;</span><span class="Special">,</span>params<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a(%a&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]][</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
    <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">2</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]])</span> <span class="Statement">do</span>
       tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;,%a&quot;</span><span class="Special">,</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]][</span>jj<span class="Special">]))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;)&quot;</span><span class="Special">))</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>


 <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
   tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a&quot;</span><span class="Special">,</span>result_name<span class="Special">)</span><span class="Special">;</span>
   code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">elif</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;initializer&quot;</span> <span class="Statement">then</span>

    <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">)</span> <span class="Statement">=</span> <span class="Constant">0</span> <span class="Statement">then</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;initializer mode requires shapes to be passed in, probably passing in an expression identical to zero to the routine&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a(%a&quot;</span><span class="Special">,</span>result_name<span class="Special">,</span>shape_set<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
    <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">2</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
       tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;,%a&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>jj<span class="Special">]))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;)&quot;</span><span class="Special">))</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>

 <span class="Statement">else</span>
   <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;gen_form not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


 tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a&quot;</span><span class="Special">,</span>res_pp_FD<span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Comment">#tss:=sprintf(&quot;include 'tvd.inc'&quot;);</span>
 <span class="Comment">#code_str:=cat(code_str,chop_fortran(tss));</span>
 <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = 0.0D0&quot;</span><span class="Special">,</span>result_name<span class="Special">)</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
  tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;do %a=%a, %a, 1&quot;</span><span class="Special">,</span>indexes<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span><span class="Constant">1</span>+<span class="Statement">max</span><span class="Special">(</span>-boundary_index<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span><span class="Constant">0</span><span class="Special">)</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">]</span>-<span class="Statement">max</span><span class="Special">(</span>boundary_index<span class="Special">[</span>ii<span class="Special">][</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">,</span><span class="Constant">0</span><span class="Special">)</span> <span class="Special">)</span><span class="Special">;</span>
  code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
 Digits<span class="Special">:=</span><span class="Constant">16</span><span class="Special">;</span>
 stencil2<span class="Special">:=</span><span class="Statement">evalf</span><span class="Special">(</span>stencil<span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">if</span> opt <span class="Statement">then</span>
 WARNING<span class="Special">(</span><span class="Constant">&quot;Optimization will result in temporary variables txxx, whose declaration is included in tvd.inc file, if not enough, run tvd(n) to generate a new tvd.inc with more of them&quot;</span><span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
 tss<span class="Special">:=</span><span class="Type">CodeGeneration</span><span class="Special">[</span>Fortran<span class="Special">](</span>stencil2<span class="Special">,</span>resultname<span class="Statement">=</span>res_pp_FD<span class="Special">,</span>output<span class="Statement">=</span>string<span class="Special">,</span>limitvariablelength<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span><span class="Statement">optimize</span><span class="Statement">=</span>opt<span class="Special">,</span>defaulttype<span class="Statement">=</span><span class="Statement">float</span><span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>tss<span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
   tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = %a + %a**2&quot;</span><span class="Special">,</span>result_name<span class="Special">,</span>result_name<span class="Special">,</span>res_pp_FD<span class="Special">)</span><span class="Special">;</span>
   code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">elif</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;initializer&quot;</span> <span class="Statement">then</span>
      tss<span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span><span class="Statement">convert</span><span class="Special">(</span>result_name<span class="Special">,</span>string<span class="Special">)</span><span class="Special">,</span><span class="Constant">&quot;(&quot;</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a,&quot;</span><span class="Special">,</span>indexes<span class="Special">[</span>jj<span class="Special">])</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span><span class="Constant">-1</span><span class="Special">)</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a&quot;</span><span class="Special">,</span>indexes<span class="Special">[</span><span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)])</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;)=%a&quot;</span><span class="Special">,</span>res_pp_FD<span class="Special">))</span><span class="Special">;</span>
     code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">else</span>
   <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;gen_from not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span> <span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;end do&quot;</span><span class="Special">)</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
 <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = sqrt(%a/(%a&quot;</span><span class="Special">,</span>result_name<span class="Special">,</span>result_name<span class="Special">,</span><span class="Constant">1</span><span class="Special">)</span><span class="Special">;</span>
    tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span> <span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;*%a&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span><span class="Special">,</span><span class="Constant">&quot;))&quot;</span><span class="Special">)</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
 tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;END&quot;</span><span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>


 <span class="Statement">return</span> <span class="Special">[</span>code_str<span class="Special">,</span>code_str2<span class="Special">,</span>code_str3<span class="Special">]</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

tvd <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>n<span class="Special">::</span>integer<span class="Special">)</span>
   <span class="Statement">local</span> ii<span class="Special">,</span> fname<span class="Special">,</span>fp<span class="Special">;</span>
   fname<span class="Special">:=</span><span class="Constant">&quot;tvd.inc&quot;</span><span class="Special">;</span>
   fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> n <span class="Statement">do</span>
      <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span><span class="Constant">&quot;       real*8 t%a\n&quot;</span><span class="Special">,</span>ii<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###########################################################################</span>

AGEC<span class="Special">:=</span>A_Gen_Eval_Code<span class="Special">;</span>

A_Gen_Eval_Code<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>PDE<span class="Special">::</span>list<span class="Special">(</span>equation<span class="Special">)</span><span class="Special">,</span><span class="Special">{</span>input<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;c&quot;</span><span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;auto&quot;</span><span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;eval_func&quot;</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>is_periodic<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

  <span class="Statement">local</span> ii<span class="Special">;</span>

  <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span>  <span class="Statement">then</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>PDE<span class="Special">)</span>  <span class="Statement">do</span>
     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span><span class="Statement">rhs</span><span class="Special">(</span>PDE<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  A_Gen_Code_L<span class="Special">(</span>PDE<span class="Special">,</span>input<span class="Special">,</span><span class="Constant">&quot;initializer&quot;</span><span class="Special">,</span>output<span class="Special">,</span>optm<span class="Special">,</span>proc_name<span class="Special">,</span>ignore_gf<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Special">{}</span><span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

AGSC<span class="Special">:=</span>A_Gen_Solve_Code<span class="Special">;</span>

<span class="Comment"># AAK</span>
<span class="Comment"># Fri Mar  7 11:41:48 PST 2014</span>
<span class="Comment"># Is periodic is eventually should move to Spec's LHS same as b=xmin,xmax etc...</span>
A_Gen_Solve_Code<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>PDE<span class="Special">::</span>list<span class="Special">(</span>equation<span class="Special">)</span><span class="Special">,</span>solve_for<span class="Special">::</span>set<span class="Special">(</span><span class="Statement">algebraic</span><span class="Special">)</span><span class="Special">,</span><span class="Special">{</span>input<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;c&quot;</span><span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;auto&quot;</span><span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;eval_func&quot;</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>is_periodic<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

  <span class="Statement">local</span> ii<span class="Special">;</span>

  <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span>  <span class="Statement">then</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>PDE<span class="Special">)</span>  <span class="Statement">do</span>
     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span><span class="Statement">rhs</span><span class="Special">(</span>PDE<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  A_Gen_Code_L<span class="Special">(</span>PDE<span class="Special">,</span>input<span class="Special">,</span><span class="Constant">&quot;initializer&quot;</span><span class="Special">,</span>output<span class="Special">,</span>optm<span class="Special">,</span>proc_name<span class="Special">,</span>ignore_gf<span class="Special">,</span><span class="Constant">true</span><span class="Special">,</span>solve_for<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>



AGRC<span class="Special">:=</span>A_Gen_Res_Code<span class="Special">;</span>

A_Gen_Res_Code<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>PDE<span class="Special">::</span>list<span class="Special">(</span>equation<span class="Special">)</span><span class="Special">,</span><span class="Special">{</span>input<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;c&quot;</span><span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;auto&quot;</span><span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;eval_resid&quot;</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>is_periodic<span class="Special">:=</span><span class="Constant">false</span><span class="Special">})</span>

  <span class="Statement">local</span> ii<span class="Special">;</span>

  <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span>  <span class="Statement">then</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>PDE<span class="Special">)</span>  <span class="Statement">do</span>
     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span><span class="Statement">rhs</span><span class="Special">(</span>PDE<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


  A_Gen_Code_L<span class="Special">(</span>PDE<span class="Special">,</span>input<span class="Special">,</span><span class="Constant">&quot;residual&quot;</span><span class="Special">,</span>output<span class="Special">,</span>optm<span class="Special">,</span>proc_name<span class="Special">,</span>ignore_gf<span class="Special">,</span><span class="Constant">false</span><span class="Special">,</span><span class="Special">{}</span><span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>



A_Gen_Code_L<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>PDE<span class="Special">::</span>list<span class="Special">(</span>equation<span class="Special">)</span><span class="Special">,</span>input<span class="Special">::</span>string<span class="Special">,</span>gen_form<span class="Special">::</span>string<span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">,</span>igf<span class="Special">::</span>boolean<span class="Special">,</span>is_solver<span class="Special">::</span>boolean<span class="Special">,</span>solve_for<span class="Special">::</span>set<span class="Special">(</span><span class="Statement">algebraic</span><span class="Special">)</span><span class="Special">,</span>is_periodic<span class="Special">)</span>
  <span class="Statement">local</span> code_str<span class="Special">,</span>header_str<span class="Special">,</span>call_str<span class="Special">;</span>
  <span class="Statement">local</span> fp<span class="Special">;</span>
  <span class="Statement">local</span> fname<span class="Special">;</span>
  <span class="Statement">local</span> all_codes<span class="Special">;</span>

  all_codes<span class="Special">:=</span>A_Gen_Code_LL<span class="Special">(</span>PDE<span class="Special">,</span>input<span class="Special">,</span>optm<span class="Special">,</span>proc_name<span class="Special">,</span>gen_form<span class="Special">,</span>igf<span class="Special">,</span>is_solver<span class="Special">,</span>solve_for<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
  code_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
  header_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
  call_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">3</span><span class="Special">]</span><span class="Special">;</span>

  <span class="Statement">if</span> output <span class="Statement">=</span> <span class="Constant">&quot;auto&quot;</span> <span class="Statement">then</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;.f&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Fortran Code is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;.h&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>header_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C header is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;_call&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>call_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C call is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

  <span class="Statement">elif</span> output <span class="Statement">=</span> <span class="Constant">&quot;&quot;</span> <span class="Statement">then</span>
     <span class="Statement">printf</span><span class="Special">(</span>header_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span>call_str<span class="Special">)</span><span class="Special">;</span>

  <span class="Statement">elif</span> output <span class="Statement">=</span> <span class="Constant">&quot;return&quot;</span> <span class="Statement">then</span>
      <span class="Statement">return</span> <span class="Special">[</span>header_str<span class="Special">,</span> code_str<span class="Special">,</span> call_str<span class="Special">]</span><span class="Special">;</span>

  <span class="Statement">else</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;.f&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Fortran Code is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;.h&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>header_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C header is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;_call&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>call_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C call is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>


  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

A_Gen_Code_LL<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>ap<span class="Special">::</span>list<span class="Special">(</span>equation<span class="Special">)</span><span class="Special">,</span>input<span class="Special">::</span>string<span class="Special">,</span>optm<span class="Special">::</span>boolean<span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">,</span>gen_form<span class="Special">::</span>string<span class="Special">,</span>igf<span class="Special">::</span>boolean<span class="Special">,</span>is_solver<span class="Special">::</span>boolean<span class="Special">,</span>solve_for<span class="Special">::</span>set<span class="Special">(</span><span class="Statement">algebraic</span><span class="Special">)</span><span class="Special">,</span>is_p<span class="Special">::</span>boolean<span class="Special">)</span>
   <span class="Statement">global</span> shape_table<span class="Special">;</span>
   <span class="Statement">local</span> shape_set<span class="Special">,</span>GFST<span class="Special">,</span>GFS<span class="Special">,</span>stepsize<span class="Special">,</span>boundary_index<span class="Special">,</span> indexes<span class="Special">,</span> FDA_STRUCT<span class="Special">,</span>params<span class="Special">;</span>
   <span class="Statement">local</span> shp_tbl<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">,</span>stencil<span class="Special">,</span>ll<span class="Special">;</span>
   <span class="Statement">local</span> res<span class="Special">;</span>
   <span class="Statement">local</span> shape_seq<span class="Special">,</span> boundary_seq<span class="Special">;</span>
   <span class="Statement">local</span> EXPR<span class="Special">;</span>
   <span class="Statement">local</span> dim<span class="Special">;</span>
   <span class="Statement">global</span> sweep_order_table<span class="Special">;</span>
   <span class="Statement">local</span> ord<span class="Special">;</span>
   <span class="Statement">local</span> all_params<span class="Special">,</span> all_gfs<span class="Special">,</span> all_params_list<span class="Special">,</span> all_gfs_list<span class="Special">;</span>
   <span class="Statement">local</span> fs<span class="Special">,</span>fsn<span class="Special">;</span>
   <span class="Statement">global</span> bfi<span class="Special">,</span>stni<span class="Special">;</span>
   <span class="Statement">local</span> qweunk<span class="Special">,</span>sf<span class="Special">,</span>pde1<span class="Special">,</span>pde2<span class="Special">,</span>pde3<span class="Special">;</span>

   check_FD<span class="Special">()</span><span class="Special">;</span>
   res<span class="Special">:=</span><span class="Statement">'res'</span><span class="Special">;</span>

   all_params<span class="Special">:=</span><span class="Special">{}</span><span class="Special">;</span>
   all_gfs<span class="Special">:=</span><span class="Special">{}</span><span class="Special">;</span>
   fs<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

   shp_tbl<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> ll <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>ap<span class="Special">)</span> <span class="Statement">do</span>
      EXPR <span class="Special">:=</span> <span class="Statement">rhs</span><span class="Special">(</span>ap<span class="Special">[</span>ll<span class="Special">])</span><span class="Special">;</span>
      <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;c&quot;</span> <span class="Statement">then</span>
         stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span>Gen_Sten<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">elif</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span> <span class="Statement">then</span>
         <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>igf<span class="Special">,</span>is_p<span class="Special">))</span> <span class="Statement">then</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
         stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span>EXPR<span class="Special">;</span>
      <span class="Statement">else</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;input not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Comment"># AAK Tue Mar  4 13:40:52 PST 2014</span>
<span class="Comment"># Adding the solver here:</span>

      <span class="Statement">if</span> is_solver <span class="Statement">then</span>
         <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>solve_for<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">1</span> <span class="Statement">then</span>
             <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown is not specified to be solved for&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
         sf <span class="Special">:=</span> solve_for<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
         pde1 <span class="Special">:=</span> <span class="Statement">eval</span><span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span><span class="Special">{</span>sf<span class="Statement">=</span>qweunk<span class="Special">})</span><span class="Special">;</span>
         pde2 <span class="Special">:=</span> Newton_Solver<span class="Special">([</span>pde1<span class="Special">]</span><span class="Special">,</span><span class="Special">[</span>qweunk<span class="Special">])</span><span class="Special">;</span>
         pde3 <span class="Special">:=</span> <span class="Statement">eval</span><span class="Special">(</span>pde2<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span><span class="Special">{</span>qweunk<span class="Statement">=</span>sf<span class="Special">})</span><span class="Special">;</span>
         stencil<span class="Special">[</span>ll<span class="Special">]</span> <span class="Special">:=</span> pde3<span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Comment">#################################################</span>
      GFST<span class="Special">[</span>ll<span class="Special">]</span> <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
      shape_seq<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span><span class="Special">NULL</span><span class="Special">;</span>

      params<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span>FPRM<span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span>igf<span class="Special">,</span>is_p<span class="Special">)</span><span class="Special">,</span>list<span class="Special">)</span><span class="Special">;</span>

      FDA_STRUCT<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span>FMS<span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span>igf<span class="Special">,</span>is_periodic<span class="Statement">=</span>is_p<span class="Special">)</span><span class="Special">;</span>
      indexes<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">({</span><span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})]</span><span class="Special">;</span>

      <span class="Statement">if</span> time_var_index <span class="Statement">in</span> <span class="Statement">convert</span><span class="Special">(</span>indexes<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>set<span class="Special">)</span> <span class="Statement">then</span>
          stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span>RTL<span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>is_periodic<span class="Statement">=</span>is_p<span class="Special">)</span><span class="Special">;</span>
          FDA_STRUCT<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span>FMS<span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span>is_periodic<span class="Statement">=</span>is_p<span class="Special">)</span><span class="Special">;</span>
          indexes<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">({</span><span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})]</span><span class="Special">;</span>
          params<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span>FPRM<span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span>is_p<span class="Special">)</span><span class="Special">,</span>list<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

      GFST<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span>FGF<span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span>is_periodic<span class="Statement">=</span>is_p<span class="Special">)</span><span class="Special">;</span>
      GFS<span class="Special">[</span>ll<span class="Special">]</span> <span class="Special">:=</span> <span class="Special">[</span> <span class="Statement">indices</span><span class="Special">(</span>GFST<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)</span> <span class="Special">]</span><span class="Special">;</span>


        <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">[</span>ll<span class="Special">])</span> <span class="Statement">do</span>
             shape_seq<span class="Special">[</span>ll<span class="Special">]</span> <span class="Special">:=</span> shape_seq<span class="Special">[</span>ll<span class="Special">]</span> <span class="Special">,</span>  shape_table<span class="Special">[</span>indexes<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]]</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
        shape_set<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">:=</span><span class="Special">[</span>shape_seq<span class="Special">[</span>ll<span class="Special">]]</span><span class="Special">;</span>

        <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>GFS<span class="Special">[</span>ll<span class="Special">])</span> <span class="Statement">do</span>
            <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">assigned</span><span class="Special">(</span>shp_tbl<span class="Special">[</span>GFS<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]]))</span> <span class="Statement">then</span>
               shp_tbl<span class="Special">[</span>GFS<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>shape_table<span class="Special">[</span>GFST<span class="Special">[</span>ll<span class="Special">][</span>GFS<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]][</span>jj<span class="Special">]]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>GFST<span class="Special">[</span>ll<span class="Special">][</span>GFS<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]]))]</span><span class="Special">;</span>
            <span class="Statement">else</span>
              <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>shp_tbl<span class="Special">[</span>GFS<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]]</span> <span class="Statement">=</span> <span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>shape_table<span class="Special">[</span>GFST<span class="Special">[</span>ll<span class="Special">][</span>GFS<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]][</span>jj<span class="Special">]]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>GFST<span class="Special">[</span>ll<span class="Special">][</span>GFS<span class="Special">[</span>ll<span class="Special">][</span>ii<span class="Special">]]))]</span> <span class="Special">)</span> <span class="Statement">then</span>
                   <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Inconsistent definition of grid functions&quot;</span><span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
            <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
       all_gfs<span class="Special">:=</span> all_gfs <span class="Statement">union</span> <span class="Statement">convert</span><span class="Special">(</span>GFS<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>set<span class="Special">)</span><span class="Special">;</span>
       all_params<span class="Special">:=</span> all_params <span class="Statement">union</span> <span class="Statement">convert</span><span class="Special">(</span>params<span class="Special">[</span>ll<span class="Special">]</span><span class="Special">,</span>set<span class="Special">)</span><span class="Special">;</span>
       <span class="Comment">#Check compatibility of lhs(ap[ll])  and indexes[ll] </span>
       check_lhs_ap<span class="Special">(</span><span class="Statement">lhs</span><span class="Special">(</span>ap<span class="Special">[</span>ll<span class="Special">]))</span><span class="Special">;</span>

       fs<span class="Special">[</span>ll<span class="Special">]</span> <span class="Special">:=</span>  <span class="Statement">table</span> <span class="Special">(</span>  <span class="Statement">convert</span><span class="Special">(</span> <span class="Statement">lhs</span><span class="Special">(</span>ap<span class="Special">[</span>ll<span class="Special">])</span> <span class="Statement">union</span> <span class="Special">{</span>stni<span class="Statement">=</span>stencil<span class="Special">[</span>ll<span class="Special">]}</span> <span class="Special">,</span> list <span class="Special">)</span>  <span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span> <span class="Comment"># end of ll loop</span>

   <span class="Comment"># Checking the consistency</span>
   <span class="Comment"># AAK: this needs to be modified</span>
   <span class="Comment"># Mon Mar  3 22:19:44 PST 2014</span>

    <span class="Statement">for</span> ll <span class="Statement">from</span> <span class="Constant">2</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>ap<span class="Special">)</span> <span class="Statement">do</span>
        <span class="Statement">if</span> indexes<span class="Special">[</span>ll<span class="Special">]</span> <span class="Statement">&lt;&gt;</span> indexes<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
           <span class="Statement">print</span><span class="Special">(</span><span class="Constant">&quot;Compare:&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">print</span><span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">])</span><span class="Special">;</span>
           <span class="Statement">print</span><span class="Special">(</span><span class="Constant">&quot;and&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">print</span><span class="Special">(</span>stencil<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Inconsistent input&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">if</span> shape_set<span class="Special">[</span>ll<span class="Special">]</span> <span class="Statement">&lt;&gt;</span>  shape_set<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
           <span class="Statement">print</span><span class="Special">(</span><span class="Constant">&quot;Compare:&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">print</span><span class="Special">(</span>stencil<span class="Special">[</span>ll<span class="Special">])</span><span class="Special">;</span>
           <span class="Statement">print</span><span class="Special">(</span><span class="Constant">&quot;and&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">print</span><span class="Special">(</span>stencil<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Inconsistent input&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    dim<span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
    ord<span class="Special">:=</span>find_sweep_order<span class="Special">(</span>sweep_order_table<span class="Special">,</span>indexes<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>

    <span class="Comment"># Checking the consistency</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>all_gfs<span class="Special">)</span> <span class="Statement">do</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">assigned</span><span class="Special">(</span>shp_tbl<span class="Special">[</span>all_gfs<span class="Special">[</span>ii<span class="Special">]]))</span> <span class="Statement">then</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown error! Please report this as a bug!&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

    <span class="Comment"># AAK : this conversion is not unique, must change</span>

    all_params_list <span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span>all_params<span class="Special">,</span>list<span class="Special">)</span><span class="Special">;</span>
    all_params_list <span class="Special">:=</span> <span class="Statement">sort</span><span class="Special">(</span>all_params_list<span class="Special">)</span><span class="Special">;</span>

    all_gfs_list <span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span>all_gfs<span class="Special">,</span>list<span class="Special">)</span><span class="Special">;</span>
    all_gfs_list <span class="Special">:=</span> <span class="Statement">sort</span><span class="Special">(</span>all_gfs_list<span class="Special">)</span><span class="Special">;</span>

    fsn<span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>ap<span class="Special">)</span><span class="Special">;</span>

     <span class="Statement">return</span> A_Gen_Code_LLL<span class="Special">(</span>shp_tbl<span class="Special">,</span>shape_set<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span>all_gfs_list<span class="Special">,</span>indexes<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span>proc_name<span class="Special">,</span>all_params_list<span class="Special">,</span>res<span class="Special">,</span>optm<span class="Special">,</span>gen_form<span class="Special">,</span>dim<span class="Special">,</span>fs<span class="Special">,</span>fsn<span class="Special">,</span>ord<span class="Special">)</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">############</span>
check_lhs_ap <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>s<span class="Special">::</span>set<span class="Special">(</span>equation<span class="Special">))</span>
    <span class="Statement">local</span> ii<span class="Special">;</span>
    <span class="Statement">global</span> bfi<span class="Special">;</span>
    <span class="Statement">global</span> pbf<span class="Special">;</span>
    <span class="Statement">global</span> phys_bdy_table<span class="Special">;</span>
    <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>s<span class="Special">)</span> <span class="Statement">do</span>
        <span class="Statement">if</span> <span class="Statement">lhs</span><span class="Special">(</span>s<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
           check_each_lhs_ap<span class="Special">(</span><span class="Statement">lhs</span><span class="Special">(</span>s<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span><span class="Statement">rhs</span><span class="Special">(</span>s<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
        <span class="Statement">elif</span> <span class="Statement">lhs</span><span class="Special">(</span>s<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">=</span> bfi <span class="Statement">then</span>
           <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span> <span class="Statement">rhs</span><span class="Special">(</span>s<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">indices</span><span class="Special">(</span>phys_bdy_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})</span> <span class="Statement">then</span>
               <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;phys bdy flag not defined&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">elif</span> <span class="Statement">lhs</span><span class="Special">(</span>s<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">=</span> pbf <span class="Statement">then</span>
           <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">rhs</span><span class="Special">(</span>s<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>list<span class="Special">(</span>equation<span class="Special">)))</span> <span class="Statement">then</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">else</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

check_each_lhs_ap <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>l<span class="Special">::</span>symbol<span class="Special">,</span>r<span class="Special">::</span>list<span class="Special">(</span><span class="Statement">algebraic</span><span class="Special">))</span>
      <span class="Statement">global</span> shape_table<span class="Special">;</span>
      <span class="Statement">local</span> ii<span class="Special">;</span>

      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">nops</span><span class="Special">(</span>r<span class="Special">)</span> <span class="Statement">=</span> <span class="Constant">3</span><span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">type</span><span class="Special">(</span>r<span class="Special">[</span><span class="Constant">3</span><span class="Special">]</span><span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Constant">2</span> <span class="Statement">do</span>
      <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>r<span class="Special">[</span>ii<span class="Special">])</span><span class="Statement">=</span><span class="Constant">`+`</span> <span class="Statement">then</span>
           <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>r<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
               <span class="Statement">if</span>  <span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>r<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">&lt;&gt;</span> shape_table<span class="Special">[</span>l<span class="Special">]</span> <span class="Statement">then</span>
                    <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
               <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">2</span><span class="Special">,</span>r<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>integer<span class="Special">)</span> <span class="Statement">then</span>
               <span class="Statement">if</span>  <span class="Statement">op</span><span class="Special">(</span><span class="Constant">1</span><span class="Special">,</span>r<span class="Special">[</span>ii<span class="Special">])</span> <span class="Statement">&lt;&gt;</span> shape_table<span class="Special">[</span>l<span class="Special">]</span> <span class="Statement">then</span>
                    <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
               <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">else</span>
             <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span>r<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>symbol<span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">if</span> shape_table<span class="Special">[</span>l<span class="Special">]</span> <span class="Statement">&lt;&gt;</span> r<span class="Special">[</span>ii<span class="Special">]</span> <span class="Statement">then</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">else</span>
           <span class="Statement">if</span>  <span class="Statement">not</span><span class="Special">(</span><span class="Statement">type</span><span class="Special">(</span>r<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>integer<span class="Special">))</span> <span class="Statement">then</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>
<span class="Comment">############</span>


A_Gen_Code_LLL<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>shape<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>shape_set<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>grid_funcs<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>indexes<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>proc_name<span class="Special">::</span>string<span class="Special">,</span>params<span class="Special">::</span>list<span class="Special">,</span>result_name<span class="Special">::</span>symbol<span class="Special">,</span>opt<span class="Special">::</span>boolean<span class="Special">,</span>gen_form<span class="Special">::</span>string<span class="Special">,</span>dim<span class="Special">::</span>integer<span class="Special">,</span>fs<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>fsn<span class="Special">::</span>integer<span class="Special">,</span>ord<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">))</span>

 <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">;</span>
 <span class="Statement">local</span> all_stuff<span class="Special">;</span>
 <span class="Statement">local</span> res_pp_FD<span class="Special">;</span>
 <span class="Statement">local</span> code_str<span class="Special">,</span>code_str2<span class="Special">;</span>
 <span class="Statement">local</span> code_str3<span class="Special">;</span>
 <span class="Statement">local</span> tss<span class="Special">;</span>

 res_pp_FD<span class="Special">:=</span><span class="Statement">'qb'</span><span class="Special">;</span>

 code_str2<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span><span class="Constant">&quot;void &quot;</span><span class="Special">,</span>proc_name<span class="Special">,</span><span class="Constant">&quot;_(&quot;</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a,&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int *%a,&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a,&quot;</span><span class="Special">,</span>params<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">))</span><span class="Special">,</span> <span class="Constant">&quot;int *phys_bdy,&quot;</span>   <span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a);\n&quot;</span><span class="Special">,</span>result_name<span class="Special">))</span><span class="Special">;</span>

 code_str3<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>proc_name<span class="Special">,</span><span class="Constant">&quot;_(&quot;</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a,&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;&amp;%a,&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;&amp;%a,&quot;</span><span class="Special">,</span>params<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">))</span><span class="Special">,</span><span class="Constant">&quot;phys_bdy,&quot;</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a);\n&quot;</span><span class="Special">,</span>result_name<span class="Special">))</span><span class="Special">;</span>

  all_stuff<span class="Special">:=</span> <span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">))</span><span class="Special">,</span> <span class="Statement">seq</span><span class="Special">(</span>shape_set<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span> <span class="Special">,</span> <span class="Statement">seq</span><span class="Special">(</span>params<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">))</span> <span class="Special">,</span> <span class="Statement">'phys_bdy'</span><span class="Special">,</span> result_name<span class="Special">]</span><span class="Special">;</span>

 code_str<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>
 tss<span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span><span class="Constant">&quot;subroutine &quot;</span><span class="Special">,</span> proc_name<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;(&quot;</span><span class="Special">)</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a,&quot;</span><span class="Special">,</span>all_stuff<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>all_stuff<span class="Special">)</span><span class="Constant">-1</span><span class="Special">)</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a)&quot;</span><span class="Special">,</span>all_stuff<span class="Special">[</span><span class="Statement">nops</span><span class="Special">(</span>all_stuff<span class="Special">)])</span> <span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 tss<span class="Special">:=</span><span class="Constant">&quot;implicit none&quot;</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;integer %a&quot;</span><span class="Special">,</span>indexes<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;integer %a&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a&quot;</span><span class="Special">,</span>params<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">)</span> <span class="Statement">do</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a(%a&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]][</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
    <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">2</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]])</span> <span class="Statement">do</span>
       tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;,%a&quot;</span><span class="Special">,</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]][</span>jj<span class="Special">]))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;)&quot;</span><span class="Special">))</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

  tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;integer phys_bdy(%a)&quot;</span><span class="Special">,</span>dim*<span class="Constant">2</span><span class="Special">)</span><span class="Special">;</span>
  code_str <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>

 <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
   tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a&quot;</span><span class="Special">,</span>result_name<span class="Special">)</span><span class="Special">;</span>
   code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">elif</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;initializer&quot;</span> <span class="Statement">then</span>

    <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">)</span> <span class="Statement">=</span> <span class="Constant">0</span> <span class="Statement">then</span>
       <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Error is here \n&quot;</span><span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;initializer mode requires shapes to be passed in, probably passing in an expression identical to zero to the routine&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a(%a&quot;</span><span class="Special">,</span>result_name<span class="Special">,</span>shape_set<span class="Special">[</span><span class="Constant">1</span><span class="Special">])</span><span class="Special">;</span>
    <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">2</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
       tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;,%a&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>jj<span class="Special">]))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
    tss<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>tss<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;)&quot;</span><span class="Special">))</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>

 <span class="Statement">else</span>
   <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;gen_form not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


 tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;real*8 %a&quot;</span><span class="Special">,</span>res_pp_FD<span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Comment">#tss:=sprintf(&quot;include 'tvd.inc'&quot;);</span>
 <span class="Comment">#code_str:=cat(code_str,chop_fortran(tss));</span>
 <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
    tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = 0.0D0&quot;</span><span class="Special">,</span>result_name<span class="Special">)</span><span class="Special">;</span>
    code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


 tss <span class="Special">:=</span> gen_for_loops<span class="Special">(</span>dim<span class="Special">,</span>fs<span class="Special">,</span>fsn<span class="Special">,</span>ord<span class="Special">,</span>opt<span class="Special">,</span>res_pp_FD<span class="Special">,</span>result_name<span class="Special">,</span>gen_form<span class="Special">,</span>indexes<span class="Special">,</span>shape_set<span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>tss<span class="Special">)</span><span class="Special">;</span>

 tss<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;END&quot;</span><span class="Special">)</span><span class="Special">;</span>
 code_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>code_str<span class="Special">,</span>chop_fortran<span class="Special">(</span>tss<span class="Special">))</span><span class="Special">;</span>


 <span class="Statement">return</span> <span class="Special">[</span>code_str<span class="Special">,</span>code_str2<span class="Special">,</span>code_str3<span class="Special">]</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


gen_for_loops <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>dim<span class="Special">::</span>integer<span class="Special">,</span>fs<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>fsn<span class="Special">::</span>integer<span class="Special">,</span>ord<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>opt<span class="Special">::</span>boolean<span class="Special">,</span>res_pp_FD<span class="Special">::</span>symbol<span class="Special">,</span>result_name<span class="Special">::</span>symbol<span class="Special">,</span>gen_form<span class="Special">::</span>string<span class="Special">,</span>indexes<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>shape_set<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">))</span>

 <span class="Statement">global</span> stni<span class="Special">,</span>bfi<span class="Special">;</span>
 <span class="Statement">global</span> shape_table<span class="Special">,</span>var_order_table<span class="Special">;</span>
 <span class="Statement">global</span> phys_bdy_table<span class="Special">;</span>
 <span class="Statement">global</span> pbf<span class="Special">;</span>
 <span class="Statement">local</span> cd<span class="Special">;</span>
 <span class="Statement">local</span> idx<span class="Special">,</span>fse<span class="Special">;</span>
 <span class="Statement">local</span> nf<span class="Special">,</span>cp<span class="Special">,</span>ii<span class="Special">,</span>jj<span class="Special">;</span>
 <span class="Statement">local</span> stencil2<span class="Special">;</span>

 nf<span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>fs<span class="Special">)</span><span class="Special">;</span>

 cd<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>
 cp<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>

 <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>ord<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> dim <span class="Statement">then</span>
     <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid input&quot;</span><span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> fsn <span class="Statement">do</span>
    fse<span class="Special">:=</span>fs<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>

  <span class="Comment">#&gt;&gt;</span>
    <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>fse<span class="Special">[</span>bfi<span class="Special">])</span> <span class="Statement">then</span>
      cp<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;if (phys_bdy(%a) .eq. 1) then&quot;</span><span class="Special">,</span>  phys_bdy_table<span class="Special">[</span>fse<span class="Special">[</span>bfi<span class="Special">]]</span>      <span class="Special">)</span><span class="Special">;</span>
      cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>chop_fortran<span class="Special">(</span>cp<span class="Special">))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> dim <span class="Statement">do</span>
      idx<span class="Special">:=</span> ord<span class="Special">[</span>jj<span class="Special">]</span><span class="Special">;</span>
      cp<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;do %a=%a, %a, %a&quot;</span><span class="Special">,</span>idx<span class="Special">,</span> fse<span class="Special">[</span>idx<span class="Special">][</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span>fse<span class="Special">[</span>idx<span class="Special">][</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">,</span>fse<span class="Special">[</span>idx<span class="Special">][</span><span class="Constant">3</span><span class="Special">])</span><span class="Special">;</span>
      cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>chop_fortran<span class="Special">(</span>cp<span class="Special">))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

    stencil2<span class="Special">:=</span>fse<span class="Special">[</span>stni<span class="Special">]</span><span class="Special">;</span>
    <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>fse<span class="Special">[</span>pbf<span class="Special">])</span> <span class="Statement">then</span>
          stencil2 <span class="Special">:=</span> FD_Periodic<span class="Special">(</span>stencil2 <span class="Special">,</span> <span class="Statement">convert</span><span class="Special">(</span>fse<span class="Special">[</span>pbf<span class="Special">]</span><span class="Special">,</span>set<span class="Special">)</span> <span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    Digits<span class="Special">:=</span> <span class="Constant">16</span><span class="Special">;</span>
    stencil2<span class="Special">:=</span><span class="Statement">evalf</span><span class="Special">(</span>stencil2<span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">if</span> opt <span class="Statement">then</span>
         WARNING<span class="Special">(</span><span class="Constant">&quot;Optimization will result in temporary variables txxx, whose declaration is included in tvd.inc file, if not enough, run tvd(n) to generate a new tvd.inc with more of them&quot;</span><span class="Special">)</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    cp<span class="Special">:=</span><span class="Type">CodeGeneration</span><span class="Special">[</span>Fortran<span class="Special">](</span>stencil2<span class="Special">,</span>resultname<span class="Statement">=</span>res_pp_FD<span class="Special">,</span>output<span class="Statement">=</span>string<span class="Special">,</span>limitvariablelength<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span><span class="Statement">optimize</span><span class="Statement">=</span>opt<span class="Special">,</span>defaulttype<span class="Statement">=</span><span class="Statement">float</span><span class="Special">)</span><span class="Special">;</span>
    cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>cp<span class="Special">)</span><span class="Special">;</span>

    <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
      cp<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = %a + %a**2&quot;</span><span class="Special">,</span>result_name<span class="Special">,</span>result_name<span class="Special">,</span>res_pp_FD<span class="Special">)</span><span class="Special">;</span>
      cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>chop_fortran<span class="Special">(</span>cp<span class="Special">))</span><span class="Special">;</span>

    <span class="Statement">elif</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;initializer&quot;</span> <span class="Statement">then</span>
      cp<span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span><span class="Statement">convert</span><span class="Special">(</span>result_name<span class="Special">,</span>string<span class="Special">)</span><span class="Special">,</span><span class="Constant">&quot;(&quot;</span><span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a,&quot;</span><span class="Special">,</span>indexes<span class="Special">[</span>jj<span class="Special">])</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span><span class="Constant">-1</span><span class="Special">)</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a&quot;</span><span class="Special">,</span>indexes<span class="Special">[</span><span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)])</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;)=%a&quot;</span><span class="Special">,</span>res_pp_FD<span class="Special">))</span><span class="Special">;</span>
      cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>chop_fortran<span class="Special">(</span>cp<span class="Special">))</span><span class="Special">;</span>
     <span class="Statement">else</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;gen_from not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> dim <span class="Statement">do</span>
      cp<span class="Special">:=</span><span class="Constant">&quot;end do&quot;</span><span class="Special">;</span>
      cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>chop_fortran<span class="Special">(</span>cp<span class="Special">))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

    <span class="Statement">if</span> <span class="Statement">assigned</span><span class="Special">(</span>fse<span class="Special">[</span>bfi<span class="Special">])</span> <span class="Statement">then</span>
       cp<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;endif&quot;</span><span class="Special">)</span><span class="Special">;</span>
       cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>chop_fortran<span class="Special">(</span>cp<span class="Special">))</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">if</span> gen_form <span class="Statement">=</span> <span class="Constant">&quot;residual&quot;</span> <span class="Statement">then</span>
    cp<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = sqrt(%a/(%a&quot;</span><span class="Special">,</span>result_name<span class="Special">,</span>result_name<span class="Special">,</span><span class="Constant">1</span><span class="Special">)</span><span class="Special">;</span>
    cp<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cp<span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span> <span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;*%a&quot;</span><span class="Special">,</span>shape_set<span class="Special">[</span>ii<span class="Special">])</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>shape_set<span class="Special">))</span><span class="Special">,</span><span class="Constant">&quot;))&quot;</span><span class="Special">)</span><span class="Special">;</span>
    cd<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cd<span class="Special">,</span>chop_fortran<span class="Special">(</span>cp<span class="Special">))</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


 <span class="Statement">return</span> cd<span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">###########################################################################</span>

GDC <span class="Special">:=</span> Gen_Dr_Code<span class="Special">;</span>

Gen_Dr_Code<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span>input<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;c&quot;</span><span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">:=</span><span class="Constant">&quot;auto&quot;</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">:=</span><span class="Constant">false</span><span class="Special">,</span>other_headers<span class="Special">::</span>set<span class="Special">(</span>string<span class="Special">)</span><span class="Special">:=</span><span class="Special">{}</span><span class="Special">})</span>

  <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Statement">algebraic</span><span class="Special">)</span> <span class="Statement">then</span>

     <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span>  <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>ignore_gf<span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span>EXPR<span class="Special">,</span>equation<span class="Special">)</span> <span class="Statement">then</span>

     <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span>  <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span> check_validity_d_expr<span class="Special">(</span><span class="Statement">rhs</span><span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">,</span>ignore_gf<span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span> <span class="Special">)</span> <span class="Statement">then</span>
            <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  <span class="Statement">else</span>
     <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;First argument must be type algebraic or equation&quot;</span><span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

  Gen_C_Driver_L<span class="Special">(</span>EXPR<span class="Special">,</span>input<span class="Special">,</span>output<span class="Special">,</span>ignore_gf<span class="Special">,</span>other_headers<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


Gen_C_Driver_L<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">,</span>input<span class="Special">::</span>string<span class="Special">,</span>output<span class="Special">::</span>string<span class="Special">,</span>igf<span class="Special">::</span>boolean<span class="Special">,</span>other_headers<span class="Special">::</span>set<span class="Special">(</span>string<span class="Special">))</span>
  <span class="Statement">local</span> code_str<span class="Special">,</span>makefile_str<span class="Special">,</span>pfile_ex<span class="Special">;</span>
  <span class="Statement">local</span> fp<span class="Special">;</span>
  <span class="Statement">local</span> fname<span class="Special">;</span>
  <span class="Statement">local</span> all_codes<span class="Special">;</span>
  <span class="Statement">local</span> fix_str<span class="Special">;</span>

  all_codes<span class="Special">:=</span>Gen_C_Driver_LL<span class="Special">(</span>EXPR<span class="Special">,</span>input<span class="Special">,</span>igf<span class="Special">,</span>other_headers<span class="Special">)</span><span class="Special">;</span>
  code_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
  makefile_str <span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">;</span>
  pfile_ex<span class="Special">:=</span> all_codes<span class="Special">[</span><span class="Constant">3</span><span class="Special">]</span><span class="Special">;</span>

  fix_str<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>
  fix_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>fix_str<span class="Special">,</span><span class="Constant">&quot;fix:\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
  fix_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>fix_str<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot; sed s/main/&quot;</span><span class="Special">)</span><span class="Special">,</span>output<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;/g &lt; Makefile &gt; Makefile.tmp\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
  fix_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>fix_str<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot; /bin/mv -f Makefile.tmp Makefile\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
  makefile_str<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>makefile_str<span class="Special">,</span>fix_str<span class="Special">)</span><span class="Special">;</span>


  <span class="Statement">if</span> output <span class="Statement">=</span> <span class="Constant">&quot;auto&quot;</span> <span class="Statement">then</span>

     fname<span class="Special">:=</span><span class="Constant">&quot;main.c_&quot;</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C Code is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Constant">&quot;Makefile_&quot;</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>makefile_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Makefile is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Constant">&quot;main.param_&quot;</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>pfile_ex<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Param file is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>


  <span class="Statement">elif</span> output <span class="Statement">=</span> <span class="Constant">&quot;&quot;</span> <span class="Statement">then</span>
     <span class="Statement">printf</span><span class="Special">(</span>header_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span>pfile_ex<span class="Special">)</span><span class="Special">;</span>

  <span class="Statement">elif</span> output <span class="Statement">=</span> <span class="Constant">&quot;return&quot;</span> <span class="Statement">then</span>
      <span class="Statement">return</span> <span class="Special">[</span>makefile_str<span class="Special">,</span> code_str<span class="Special">,</span> pfile_ex<span class="Special">]</span><span class="Special">;</span>

  <span class="Statement">else</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;.c_&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>code_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;C Code is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span><span class="Constant">&quot;Makefile_&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>makefile_str<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Makefile is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>

     fname<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>output<span class="Special">,</span><span class="Constant">&quot;.param_&quot;</span><span class="Special">)</span><span class="Special">;</span>
     fp<span class="Special">:=</span><span class="Statement">fopen</span><span class="Special">(</span>fname<span class="Special">,</span>WRITE<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fprintf</span><span class="Special">(</span>fp<span class="Special">,</span>pfile_ex<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">fclose</span><span class="Special">(</span>fp<span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Param file is written to %s\n&quot;</span><span class="Special">,</span>fname<span class="Special">)</span><span class="Special">;</span>


  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>



Gen_C_Driver_LL<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>Q<span class="Special">,</span>input<span class="Special">::</span>string<span class="Special">,</span>igf<span class="Special">::</span>boolean<span class="Special">,</span>other_headers<span class="Special">::</span>set<span class="Special">(</span>string<span class="Special">))</span>

   <span class="Statement">global</span> shape_table<span class="Special">,</span>variable_set<span class="Special">,</span>index_table_r<span class="Special">;</span>
   <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
   <span class="Statement">global</span> grid_functions<span class="Special">;</span>
   <span class="Statement">local</span> shape_set<span class="Special">,</span>GFST<span class="Special">,</span>GFS<span class="Special">,</span> indexes<span class="Special">,</span> FDA_STRUCT<span class="Special">,</span>params<span class="Special">;</span>
   <span class="Statement">local</span> GFS_S<span class="Special">;</span>
   <span class="Statement">local</span> shp_tbl<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">,</span>stencil<span class="Special">;</span>
   <span class="Statement">local</span> crd<span class="Special">;</span>
   <span class="Statement">local</span> uu<span class="Special">,</span>uus<span class="Special">;</span>
   <span class="Statement">local</span> uus_indexes<span class="Special">;</span>
   <span class="Statement">local</span> is_eq<span class="Special">;</span>
   <span class="Statement">global</span> strict<span class="Special">;</span>
   <span class="Statement">local</span> EXPR<span class="Special">;</span>
   <span class="Statement">local</span> ti<span class="Special">;</span>

   is_eq<span class="Special">:=</span> <span class="Constant">false</span><span class="Special">;</span>
   ti<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
   check_FD<span class="Special">()</span><span class="Special">;</span>

   shape_set<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">type</span><span class="Special">(</span>Q<span class="Special">,</span><span class="Statement">algebraic</span><span class="Special">)</span> <span class="Statement">then</span>
      EXPR<span class="Special">:=</span>Q<span class="Special">;</span>
   <span class="Statement">elif</span> <span class="Statement">type</span><span class="Special">(</span>Q<span class="Special">,</span>equation<span class="Special">)</span> <span class="Statement">then</span>
      EXPR <span class="Special">:=</span> <span class="Statement">rhs</span><span class="Special">(</span>Q<span class="Special">)</span><span class="Special">;</span>
      uu<span class="Special">:=</span> <span class="Statement">lhs</span><span class="Special">(</span>Q<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>proper_cont_grid_func<span class="Special">(</span>uu<span class="Special">))</span> <span class="Statement">then</span>
          <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid LHS&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      is_eq<span class="Special">:=</span><span class="Constant">true</span><span class="Special">;</span>
   <span class="Statement">else</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Gen_C_Driver_LL expects its first argument of type algebraic or equation&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> input<span class="Statement">=</span><span class="Constant">&quot;c&quot;</span> <span class="Statement">then</span>
      stencil<span class="Special">:=</span>Gen_Sten<span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">if</span> <span class="Special">(</span>is_eq<span class="Special">)</span> <span class="Statement">then</span>
          <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>uu<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>
             WARNING<span class="Special">(</span><span class="Constant">&quot;LHS is not defined in grid functions... automatically added to GFS&quot;</span><span class="Special">)</span><span class="Special">;</span>
             grid_functions<span class="Special">:=</span>grid_functions <span class="Statement">union</span> <span class="Special">{</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>uu<span class="Special">)}</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
          uus <span class="Special">:=</span> CtoD<span class="Special">(</span>uu<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">elif</span> input<span class="Statement">=</span><span class="Constant">&quot;d&quot;</span> <span class="Statement">then</span>
      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span>EXPR<span class="Special">,</span>igf<span class="Special">,</span><span class="Constant">false</span><span class="Special">))</span> <span class="Statement">then</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression&quot;</span><span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      stencil<span class="Special">:=</span>EXPR<span class="Special">;</span>
      <span class="Statement">if</span> <span class="Special">(</span>is_eq<span class="Special">)</span> <span class="Statement">then</span> uus <span class="Special">:=</span> uu<span class="Special">;</span> <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">else</span>
     <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;input not supported&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   shp_tbl<span class="Special">:=</span><span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>
   GFST <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

   params<span class="Special">:=</span>FPRM<span class="Special">(</span>stencil<span class="Special">,</span>ignore_gf<span class="Statement">=</span>igf<span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">;</span>

   FDA_STRUCT<span class="Special">:=</span>FMS<span class="Special">(</span>stencil<span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span>igf<span class="Special">)</span><span class="Special">;</span>
   indexes<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">({</span><span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})]</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Special">(</span>is_eq<span class="Special">)</span> <span class="Statement">then</span>
         uus_indexes<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span>uus<span class="Special">)]</span><span class="Special">;</span>

         <span class="Statement">if</span> <span class="Special">(</span><span class="Statement">convert</span><span class="Special">(</span>uus_indexes<span class="Special">,</span>set<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">convert</span><span class="Special">(</span>indexes<span class="Special">,</span>set<span class="Special">)</span> <span class="Special">)</span> <span class="Statement">then</span>
            <span class="Statement">if</span> strict <span class="Statement">then</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;LHS and RHS are not compatible&quot;</span><span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">else</span>
              WARNING<span class="Special">(</span><span class="Constant">&quot;LHS and RHS are not copatible&quot;</span><span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> time_var_index <span class="Statement">in</span> <span class="Statement">convert</span><span class="Special">(</span>indexes<span class="Special">,</span>set<span class="Special">)</span> <span class="Statement">then</span>
       ti<span class="Special">:=</span><span class="Constant">true</span><span class="Special">;</span>
       stencil<span class="Special">:=</span>RTL<span class="Special">(</span>stencil<span class="Special">)</span><span class="Special">;</span>
       FDA_STRUCT<span class="Special">:=</span>FMS<span class="Special">(</span>stencil<span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">)</span><span class="Special">;</span>
       indexes<span class="Special">:=</span><span class="Special">[</span><span class="Statement">op</span><span class="Special">({</span><span class="Statement">indices</span><span class="Special">(</span>FDA_STRUCT<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})]</span><span class="Special">;</span>
       params<span class="Special">:=</span>FPRM<span class="Special">(</span>stencil<span class="Special">,</span>ignore_gf<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   GFST<span class="Special">:=</span>FGF<span class="Special">(</span>stencil<span class="Special">,</span>show_results<span class="Statement">=</span><span class="Constant">false</span><span class="Special">)</span><span class="Special">;</span>
   GFS <span class="Special">:=</span> <span class="Special">[</span> <span class="Statement">indices</span><span class="Special">(</span>GFST<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)</span> <span class="Special">]</span><span class="Special">;</span>
   GFS_S <span class="Special">:=</span> <span class="Statement">convert</span><span class="Special">(</span>GFS<span class="Special">,</span>set<span class="Special">)</span><span class="Special">;</span>

   crd<span class="Special">:=</span> <span class="Special">{</span> <span class="Statement">seq</span><span class="Special">(</span> index_table_r<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">,</span> ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Special">)</span> <span class="Special">}</span><span class="Special">;</span>

   GFS_S <span class="Special">:=</span> GFS_S <span class="Statement">minus</span> crd<span class="Special">;</span>
   GFS<span class="Special">:=</span><span class="Statement">convert</span><span class="Special">(</span>GFS_S<span class="Special">,</span>list<span class="Special">)</span><span class="Special">;</span>

   params<span class="Special">:=</span> params <span class="Statement">minus</span> <span class="Special">{</span> <span class="Statement">seq</span><span class="Special">(</span>stepsize_table<span class="Special">[</span>crd<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>crd<span class="Special">))</span>  <span class="Special">}</span> <span class="Special">;</span>



     <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
           shape_set<span class="Special">[</span>index_table_r<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]]</span> <span class="Special">:=</span>  shape_table<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

     <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>GFS<span class="Special">)</span> <span class="Statement">do</span>
          shp_tbl<span class="Special">[</span>GFS<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Special">[</span><span class="Statement">seq</span><span class="Special">(</span>shape_table<span class="Special">[</span>GFST<span class="Special">[</span>GFS<span class="Special">[</span>ii<span class="Special">]][</span>jj<span class="Special">]]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>GFST<span class="Special">[</span>GFS<span class="Special">[</span>ii<span class="Special">]]))]</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>is_eq<span class="Special">)</span> <span class="Statement">then</span>
          uus<span class="Special">:=</span>gf<span class="Special">(</span><span class="Statement">seq</span><span class="Special">(</span>indexes<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">return</span> Gen_C_Driver_LLL<span class="Special">(</span>shp_tbl<span class="Special">,</span>shape_set<span class="Special">,</span>crd<span class="Special">,</span>GFS<span class="Special">,</span>params<span class="Special">,</span>indexes<span class="Special">,</span>other_headers<span class="Special">,</span>is_eq<span class="Special">,</span>lhs_gf<span class="Statement">=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>uus<span class="Special">)</span><span class="Special">,</span>ti<span class="Special">)</span><span class="Special">;</span>




<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

gen_p_table <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>shape<span class="Special">::</span>set<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>crd<span class="Special">::</span>set<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>params<span class="Special">::</span>set<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>unders<span class="Special">::</span>set<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>other_ints<span class="Special">,</span>other_doubles<span class="Special">)</span>

   <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">;</span>
   <span class="Statement">local</span> pt<span class="Special">;</span>
   pt <span class="Special">:=</span> <span class="Statement">table</span><span class="Special">(</span><span class="Special">[]</span><span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">)</span> <span class="Statement">do</span>
      pt<span class="Special">[</span>params<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Constant">&quot;double&quot;</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape<span class="Special">)</span> <span class="Statement">do</span>
      pt<span class="Special">[</span>shape<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Constant">&quot;int&quot;</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>crd<span class="Special">)</span> <span class="Statement">do</span>
     <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>unders<span class="Special">)</span> <span class="Statement">do</span>
       pt<span class="Special">[</span> <span class="Statement">cat</span><span class="Special">(</span>crd<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>_<span class="Special">,</span>unders<span class="Special">[</span>jj<span class="Special">])</span> <span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;double&quot;</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>other_ints<span class="Special">)</span> <span class="Statement">do</span>
       pt<span class="Special">[</span>other_ints<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Constant">&quot;int&quot;</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>other_dobles<span class="Special">)</span> <span class="Statement">do</span>
       pt<span class="Special">[</span>other_doubles<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">:=</span> <span class="Constant">&quot;double&quot;</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">return</span> pt<span class="Special">;</span>


<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

Gen_C_Driver_LLL<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>shape<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>shape_set<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>crd<span class="Special">::</span>set<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>grid_funcs<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>params<span class="Special">::</span>set<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>indexes<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span>other_headers<span class="Special">::</span>set<span class="Special">(</span>string<span class="Special">)</span><span class="Special">,</span>is_eq<span class="Special">::</span>boolean<span class="Special">,</span><span class="Special">{</span>lhs_gf<span class="Special">::</span>symbol<span class="Special">:=</span>gf<span class="Special">}</span><span class="Special">,</span>ti<span class="Special">::</span>boolean<span class="Special">)</span>

   <span class="Statement">global</span> variable_set<span class="Special">;</span>
   <span class="Statement">global</span> stepsize_table<span class="Special">;</span>
   <span class="Statement">global</span> time_var_name<span class="Special">;</span>
   <span class="Statement">local</span> shape_set_a<span class="Special">;</span>
   <span class="Statement">local</span> cs<span class="Special">,</span>ii<span class="Special">,</span>jj<span class="Special">;</span>
   <span class="Statement">local</span> bb<span class="Special">;</span>
   <span class="Statement">local</span> rt<span class="Special">;</span>
   <span class="Statement">local</span> dim<span class="Special">;</span>
   <span class="Statement">local</span> p_table<span class="Special">;</span>
   <span class="Statement">local</span> unders<span class="Special">;</span>
   <span class="Statement">local</span> other_ints<span class="Special">;</span>
   <span class="Statement">local</span> other_doubles<span class="Special">;</span>
   <span class="Statement">local</span> rps<span class="Special">;</span>
   dim <span class="Special">:=</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span><span class="Special">;</span>
   rt<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;\n&quot;</span><span class="Special">)</span><span class="Special">;</span>



   unders<span class="Special">:=</span><span class="Special">{</span><span class="Statement">'</span><span class="Statement">max</span><span class="Statement">'</span><span class="Special">,</span><span class="Statement">'</span><span class="Statement">min</span><span class="Statement">'</span><span class="Special">}</span><span class="Special">;</span>
   shape_set_a<span class="Special">:=</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>shape_set<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span><span class="Special">;</span>


   cs<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;#include &lt;stdlib.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;math.h&gt;\n#include &lt;bbhutil.h&gt;\n#include &lt;sdf_read.h&gt;\n&quot;</span><span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>other_headers<span class="Special">)</span> <span class="Statement">do</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;#include &lt;&quot;</span><span class="Special">)</span><span class="Special">,</span>other_headers<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;.h&gt;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Shapes: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape_set_a<span class="Special">)</span> <span class="Statement">do</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int %a;\n&quot;</span><span class="Special">,</span>shape_set_a<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int shape[%a];\n&quot;</span><span class="Special">,</span>dim<span class="Special">))</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int dim;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int level;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Coordinates: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>crd<span class="Special">)</span> <span class="Statement">do</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a;\n&quot;</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

  cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Grid Functions: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">)</span> <span class="Statement">do</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a;\n&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Special">(</span>is_eq<span class="Special">)</span> <span class="Statement">then</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double *%a;\n&quot;</span><span class="Special">,</span>lhs_gf<span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Parameters: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>params<span class="Special">)</span> <span class="Statement">do</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double %a;\n&quot;</span><span class="Special">,</span>params<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">if</span> ti <span class="Statement">then</span>
      <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>stepsize_table<span class="Special">[</span>time_var_name<span class="Special">]</span> <span class="Statement">in</span> params<span class="Special">)</span> <span class="Statement">then</span>
         cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double %a;\n&quot;</span><span class="Special">,</span>stepsize_table<span class="Special">[</span>time_var_name<span class="Special">]))</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Coordinate Parameters: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>crd<span class="Special">)</span> <span class="Statement">do</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double %a_max;\n&quot;</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double %a_min;\n&quot;</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double %a;\n&quot;</span><span class="Special">,</span>stepsize_table<span class="Special">[</span>crd<span class="Special">[</span>ii<span class="Special">]]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double bbox[%a];\n&quot;</span><span class="Special">,</span>dim*<span class="Constant">2</span><span class="Special">))</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int phys_bdy[%a];\n&quot;</span><span class="Special">,</span>dim*<span class="Constant">2</span><span class="Special">))</span><span class="Special">;</span>
   other_ints<span class="Special">:=</span><span class="Special">{</span>level<span class="Special">}</span><span class="Special">;</span>
   other_doubles<span class="Special">:=</span><span class="Special">{}</span><span class="Special">;</span>
   <span class="Statement">if</span> ti <span class="Statement">then</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Time Evolution Parameters: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int steps;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
      other_ints<span class="Special">:=</span> other_ints <span class="Statement">union</span> <span class="Special">{</span>steps<span class="Special">}</span><span class="Special">;</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int output_freq;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
      other_ints<span class="Special">:=</span>other_ints <span class="Statement">union</span> <span class="Special">{</span>output_freq<span class="Special">}</span><span class="Special">;</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double lambda;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
      other_doubles <span class="Special">:=</span> other_doubles <span class="Statement">union</span> <span class="Special">{</span>lambda<span class="Special">}</span><span class="Special">;</span>
      cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;double time;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   p_table <span class="Special">:=</span> gen_p_table<span class="Special">(</span>shape_set_a<span class="Special">,</span>crd<span class="Special">,</span>params <span class="Statement">minus</span> <span class="Special">{</span>stepsize_table<span class="Special">[</span>time_var_name<span class="Special">]}</span><span class="Special">,</span>unders<span class="Special">,</span>other_ints<span class="Special">,</span>other_doubles<span class="Special">)</span><span class="Special">;</span>
   rps <span class="Special">:=</span> gen_read_param<span class="Special">(</span>p_table<span class="Special">)</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>rt<span class="Special">,</span>cs<span class="Special">,</span>rps<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;int main(int argc, char **argv) {\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;char pfile[64];&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;strcpy(pfile,argv[1]);&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Comment"># Temporary</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Initialization of Coordinate: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;dim =&quot;</span><span class="Special">,</span>dim<span class="Special">,</span><span class="Constant">&quot;;&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span>rps<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape_set_a<span class="Special">)</span> <span class="Statement">do</span>
<span class="Comment">#  Nx=Nx0*(int)pow(2.0,(double)level)+1;</span>

     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = %a*(int)pow(2.0,(double)level)+1;\n&quot;</span><span class="Special">,</span>shape_set_a<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>shape_set_a<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;steps = steps*(int)pow(2.0,(double)level);\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

<span class="Comment">#   if ti then</span>
<span class="Comment">#     cs:=cat(cs,&quot;steps = 128;&quot;,rt); </span>
<span class="Comment">#     cs:=cat(cs,&quot;lambda = 0.1;&quot;,rt);</span>
<span class="Comment">#   end if;</span>

<span class="Comment">#   for ii from 1 to nops(shape_set_a) do</span>
<span class="Comment">#      cs:=cat(cs,sprintf(&quot;%a = %a;\n&quot;,shape_set_a[ii],129));</span>
<span class="Comment">#   end do;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;/* Allocating Memory to Grid Functions: */&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>crd<span class="Special">)</span> <span class="Statement">do</span>
        cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = vec_alloc(%a);\n&quot;</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>shape_set<span class="Special">[</span>crd<span class="Special">[</span>ii<span class="Special">]]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>grid_funcs<span class="Special">)</span> <span class="Statement">do</span>

     bb<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a&quot;</span><span class="Special">,</span><span class="Constant">1</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]])</span> <span class="Statement">do</span>
        bb<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>bb<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;*%a&quot;</span><span class="Special">,</span>shape<span class="Special">[</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]][</span>jj<span class="Special">]))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

        cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = vec_alloc(&quot;</span><span class="Special">,</span>grid_funcs<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
        cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span>bb<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;);\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Special">(</span>is_eq<span class="Special">)</span> <span class="Statement">then</span>
     bb<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a&quot;</span><span class="Special">,</span><span class="Constant">1</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>shape_set_a<span class="Special">)</span> <span class="Statement">do</span>
        bb<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>bb<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;*%a&quot;</span><span class="Special">,</span>shape_set_a<span class="Special">[</span>jj<span class="Special">]))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

        cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = vec_alloc(&quot;</span><span class="Special">,</span>lhs_gf<span class="Special">))</span><span class="Special">;</span>
        cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span>bb<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;);\n&quot;</span><span class="Special">))</span><span class="Special">;</span>

   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>crd<span class="Special">)</span> <span class="Statement">do</span>
<span class="Comment">#     cs:=cat(cs,sprintf(&quot;%a_max = %a;\n&quot;,crd[ii],1));</span>
<span class="Comment">#     cs:=cat(cs,sprintf(&quot;%a_min = %a;\n&quot;,crd[ii],-1));</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;%a = (%a_max-%a_min)/(%a-1);\n&quot;</span><span class="Special">,</span>stepsize_table<span class="Special">[</span>crd<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>shape_set<span class="Special">[</span>crd<span class="Special">[</span>ii<span class="Special">]]))</span><span class="Special">;</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;dvumsh(%a,%a,%a_min,%a_max);\n&quot;</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>shape_set<span class="Special">[</span>crd<span class="Special">[</span>ii<span class="Special">]]</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>crd<span class="Special">[</span>ii<span class="Special">]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">if</span> ti <span class="Statement">then</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;ht = lambda*sqrt( &quot;</span><span class="Special">)</span><span class="Special">;</span>
     bb<span class="Special">:=</span><span class="Constant">&quot;0.0&quot;</span><span class="Special">;</span>
     <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
       bb<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>bb<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;+ %a*%a&quot;</span><span class="Special">,</span>stepsize_table<span class="Special">[</span>index_table_r<span class="Special">[</span>indexes<span class="Special">[</span>jj<span class="Special">]]]</span><span class="Special">,</span>stepsize_table<span class="Special">[</span>index_table_r<span class="Special">[</span>indexes<span class="Special">[</span>jj<span class="Special">]]]))</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span>bb<span class="Special">)</span><span class="Special">;</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;);&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
     cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;shape[%a]=%a;\n&quot;</span><span class="Special">,</span>ii<span class="Constant">-1</span><span class="Special">,</span>shape_set<span class="Special">[</span>index_table_r<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]]</span> <span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>indexes<span class="Special">)</span> <span class="Statement">do</span>
         cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;bbox[%a]=%a_min;\n&quot;</span><span class="Special">,</span><span class="Constant">2</span>*ii<span class="Constant">-2</span><span class="Special">,</span>index_table_r<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]))</span><span class="Special">;</span>
         cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;bbox[%a]=%a_max;\n&quot;</span><span class="Special">,</span><span class="Constant">2</span>*ii<span class="Constant">-1</span><span class="Special">,</span>index_table_r<span class="Special">[</span>indexes<span class="Special">[</span>ii<span class="Special">]]))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Comment"># End of Temporary </span>


   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;time=0.0;&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;int i;&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">if</span> ti <span class="Statement">then</span>
       cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;for (i=0; i&lt;steps; i++) {\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
       cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Constant">&quot;}&quot;</span><span class="Special">,</span>rt<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   cs<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs<span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;}\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">return</span> <span class="Special">[</span>cs<span class="Special">,</span>gen_makefile<span class="Special">(</span>other_headers<span class="Special">)</span><span class="Special">,</span>rps<span class="Special">[</span><span class="Constant">3</span><span class="Special">]]</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

lti<span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>a<span class="Special">::</span>string<span class="Special">)</span>
  <span class="Statement">if</span> a <span class="Statement">=</span> <span class="Constant">&quot;int&quot;</span> <span class="Statement">then</span>
     <span class="Statement">return</span> <span class="Constant">&quot;long&quot;</span>
  <span class="Statement">else</span>
    <span class="Statement">return</span> a<span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

gen_read_param <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>params<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>
  <span class="Statement">local</span> ii<span class="Special">,</span>cc<span class="Special">;</span>
  <span class="Statement">local</span> cs<span class="Special">,</span>cs1<span class="Special">,</span>cs2<span class="Special">,</span>rc<span class="Special">,</span>pnames<span class="Special">;</span>
  <span class="Statement">local</span> pfe<span class="Special">;</span>
  pfe<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>
  cs1 <span class="Special">:=</span> <span class="Constant">&quot;&quot;</span><span class="Special">;</span>
  rc<span class="Special">:=</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
  pnames<span class="Special">:=</span><span class="Special">[</span><span class="Statement">indices</span><span class="Special">(</span>params<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)]</span><span class="Special">;</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>pnames<span class="Special">)</span> <span class="Statement">do</span>
      cs1 <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>cs1<span class="Special">,</span> <span class="Constant">&quot;get_param(p_file,\&quot;&quot;,pnames[ii], &quot;</span>\<span class="Constant">&quot;,\&quot;&quot;,lti(params[pnames[ii]]),&quot;</span>\<span class="Constant">&quot;,1,&quot;</span><span class="Special">,</span>pnames<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span><span class="Constant">&quot;);&quot;</span><span class="Special">,</span>rc<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  cs1<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs1<span class="Special">,</span><span class="Constant">&quot;}&quot;</span><span class="Special">,</span>rc<span class="Special">)</span><span class="Special">;</span>

  cs2<span class="Special">:=</span><span class="Constant">&quot;void read_params(char *p_file&quot;</span><span class="Special">;</span>
  cs2<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>cs2<span class="Special">,</span><span class="Statement">seq</span><span class="Special">(</span> <span class="Statement">cat</span><span class="Special">(</span> <span class="Constant">&quot;,&quot;</span><span class="Special">,</span> params<span class="Special">[</span>pnames<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Special">,</span>  <span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot; *%a&quot;</span><span class="Special">,</span>pnames<span class="Special">[</span>ii<span class="Special">])</span> <span class="Special">)</span><span class="Special">,</span> ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>pnames<span class="Special">)</span>    <span class="Special">)</span> <span class="Special">,</span> <span class="Constant">&quot;)&quot;</span><span class="Special">,</span>rc<span class="Special">,</span><span class="Constant">&quot;{&quot;</span><span class="Special">,</span>rc <span class="Special">)</span> <span class="Special">;</span>

  cs <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>cs2<span class="Special">,</span>cs1<span class="Special">)</span><span class="Special">;</span>

  cc <span class="Special">:=</span> <span class="Constant">&quot;read_params(pfile&quot;</span><span class="Special">;</span>
  cc <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>cc <span class="Special">,</span>  <span class="Statement">seq</span><span class="Special">(</span>  <span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;,&amp;%a&quot;</span><span class="Special">,</span>pnames<span class="Special">[</span>ii<span class="Special">])</span>   <span class="Special">,</span> ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>pnames<span class="Special">)</span>   <span class="Special">)</span>     <span class="Special">)</span><span class="Special">;</span>
  cc <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>cc<span class="Special">,</span><span class="Constant">&quot;);&quot;</span><span class="Special">,</span>rc<span class="Special">)</span><span class="Special">;</span>

  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>pnames<span class="Special">)</span> <span class="Statement">do</span>
    pfe<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>pfe<span class="Special">,</span> pnames<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span> <span class="Constant">&quot;:=&quot;</span> <span class="Special">,</span> <span class="Constant">&quot;?&quot;</span> <span class="Special">,</span> rc<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

  <span class="Statement">return</span> <span class="Special">[</span>cc<span class="Special">,</span> cs<span class="Special">,</span> pfe<span class="Special">]</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>



gen_makefile <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>other_headers<span class="Special">::</span>set<span class="Special">(</span>string<span class="Special">))</span>

   <span class="Statement">local</span> s<span class="Special">;</span>
   <span class="Statement">local</span> obj<span class="Special">,</span>ii<span class="Special">;</span>
   <span class="Statement">local</span> ms<span class="Special">;</span>

   ms<span class="Special">:=</span><span class="Constant">&quot;&quot;</span><span class="Special">;</span>

   s<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;.IGNORE:&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;SHELL = /bin/sh&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">3</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;LIBS = -lm -lbbhutil -lvutil -lifcore &quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">4</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;LDFLAGS = -O3 -L/usr/loca/lib -L.&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">5</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;CC = icc&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">6</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;CFLAGS = -O3&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">7</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;CPPFLAGS = -I. -I/usr/local/include&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">8</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;CC_COMP = $(CC) -c $(CFLAGS) $(CPPFLAGS)&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">9</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;CC_LOAD = $(CC) $(LDFLAGS)&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">10</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;F77 = ifort&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">11</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;F77FLAGS = -O3 -w -w90 -w95 -cm -Vaxlib&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">12</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;F77_COMP = $(F77) -c $(F77FLAGS)&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">13</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;F77_LOAD = $(F77) $(F77FLAGS) $(F77_LDFLAGS) $(LDFLAGS)&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">14</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;EXECUTABLE = main&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">15</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;all: $(EXECUTABLE)&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">16</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;.f.o:&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">17</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;  $(F77_COMP) $*.f&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">18</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;.c.o:&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">19</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;  $(CC_COMP) -c $*.c&quot;</span><span class="Special">;</span>

   obj<span class="Special">:=</span><span class="Constant">&quot;main.o&quot;</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>other_headers<span class="Special">)</span> <span class="Statement">do</span>
     obj<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>obj<span class="Special">,</span><span class="Constant">&quot; &quot;</span><span class="Special">,</span>other_headers<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span><span class="Constant">&quot;.o&quot;</span><span class="Special">,</span><span class="Constant">&quot; &quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">20</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span><span class="Constant">&quot;OBJECTS = &quot;</span><span class="Special">,</span>obj<span class="Special">)</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">21</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;main: $(OBJECTS)&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">22</span><span class="Special">]</span><span class="Special">:=</span> <span class="Constant">&quot;   $(CC_LOAD) $(OBJECTS) $(LIBS) -o main&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">23</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;clean:&quot;</span><span class="Special">;</span>
   s<span class="Special">[</span><span class="Constant">24</span><span class="Special">]</span> <span class="Special">:=</span> <span class="Constant">&quot;  /bin/rm -rf $(EXECUTABLE) $(OBJECTS)&quot;</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Constant">24</span> <span class="Statement">do</span>
       ms<span class="Special">:=</span><span class="Statement">cat</span><span class="Special">(</span>ms<span class="Special">,</span>s<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Statement">return</span> ms<span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">###########################################################################</span>
<span class="Comment"># exception handling procs:</span>
<span class="Comment">###########################################################################</span>

check_FD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

   <span class="Statement">global</span> FD_on<span class="Special">,</span> grid_functions<span class="Special">;</span>
   <span class="Statement">if</span> FD_on <span class="Statement">&lt;&gt;</span> <span class="Constant">1</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;FD not initialized, call Make_FD&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">assigned</span><span class="Special">(</span>grid_functions<span class="Special">))</span> <span class="Statement">then</span>
     WARNING<span class="Special">(</span><span class="Constant">&quot;grid_functions is not assigned&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###########################################################</span>
<span class="Comment"># checks if the expression is a valid continuous expression</span>
<span class="Comment">###########################################################</span>

check_validity_c_expr <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

    <span class="Statement">if</span> <span class="Type">PDEtools</span><span class="Special">[</span>difforder<span class="Special">](</span>EXPR<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Constant">0</span> <span class="Statement">then</span>
       <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Differential expression is not a valid continuous expression\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

    <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>variable_set<span class="Special">))</span> <span class="Statement">then</span>

        <span class="Statement">if</span> <span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})</span> <span class="Statement">then</span>
           <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid continuous expression, detected an index variable in:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

        <span class="Statement">if</span> <span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>grid_functions<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">if</span> strict <span class="Statement">then</span>
              <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;a grid function detected with invalid argument:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;WARNING: a grid function detected with invalid argument:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

        <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>

    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)})</span> <span class="Statement">then</span>

        <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid continuous expression, detected an index in:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>

     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> EXPR <span class="Statement">in</span> variable_set <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
         <span class="Statement">if</span> strict <span class="Statement">then</span>
            <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;A function is named same as variable in %a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
          <span class="Statement">else</span>
            <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;WARNING: A function is named same as variable in %a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
            <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>

        <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>check_validity_c_expr<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>

     <span class="Statement">else</span>

        <span class="Statement">if</span> proper_cont_grid_func<span class="Special">(</span>EXPR<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
        <span class="Statement">else</span>

           <span class="Statement">if</span> strict <span class="Statement">then</span>
              <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;A grid function detected with improper arguments:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Warning, a grid function detected with improper argument, treating as non-grid func:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
              <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>check_validity_c_expr<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">))</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">###########################################################</span>
<span class="Comment"># checks if the expression is a valid discrete expression</span>
<span class="Comment">###########################################################</span>

check_validity_d_expr <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>ignore_gf<span class="Special">::</span>boolean<span class="Special">,</span>is_periodic<span class="Special">::</span>boolean<span class="Special">)</span>

   <span class="Statement">global</span> index_table<span class="Special">,</span> variable_set<span class="Special">,</span>grid_functions<span class="Special">;</span>
   <span class="Statement">local</span> pgfr<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>ignore_gf<span class="Special">)</span> <span class="Statement">then</span>
     check_GF<span class="Special">()</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span><span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}))</span> <span class="Statement">then</span>
        <span class="Statement">if</span> <span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>variable_set<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression, a variable detected with improper indexing:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
        <span class="Statement">elif</span> <span class="Statement">depends</span><span class="Special">(</span>EXPR<span class="Special">,</span>grid_functions<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">if</span> strict <span class="Statement">then</span>
             <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expressoin, a grid function detected with improper indexing:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
             <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
           <span class="Statement">else</span>
             <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;WARNING: a grid function detected with improper indexing, treating as non-grid func:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
             <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">else</span>
            <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> variable_set <span class="Statement">then</span>
       pgfr<span class="Special">:=</span>proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>return_index<span class="Statement">=</span><span class="Constant">true</span><span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_periodic<span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span> <span class="Statement">then</span>
         <span class="Statement">if</span> pgfr<span class="Special">[</span><span class="Constant">2</span><span class="Special">]</span> <span class="Statement">&lt;&gt;</span> <span class="Special">[</span>index_table<span class="Special">[</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)]]</span> <span class="Statement">then</span>
             <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression, detected a variable that is indexed different than index_table:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
             <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Or a function that is named same as the variables:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
             <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
         <span class="Statement">else</span>
            <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
        <span class="Statement">else</span>
           <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid discrete expression, detected a variable with improper indexing, or a function named same as variables:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
           <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
        <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>


     <span class="Statement">if</span> EXPR <span class="Statement">in</span> <span class="Special">{</span><span class="Statement">entries</span><span class="Special">(</span>index_table<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)}</span> <span class="Statement">then</span>
        <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid dicrete expression, detectd a non-grid function with discrete argument,%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> known_functions <span class="Statement">then</span>
        <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

     <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>ignore_gf<span class="Special">)</span> <span class="Statement">then</span>
           <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions<span class="Special">)</span> <span class="Statement">then</span>
              <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
           <span class="Statement">else</span>
              <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_periodic<span class="Special">)</span> <span class="Statement">then</span>
                 <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
              <span class="Statement">else</span>
                 <span class="Statement">if</span> strict <span class="Statement">then</span>
                   <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Invalid grid function detected: %a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
                   <span class="Statement">return</span> <span class="Constant">false</span><span class="Special">;</span>
                 <span class="Statement">else</span>
                    <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;***WARNING: Improper grid function detected, treating as non-grid func:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
                  <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
                 <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
              <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
           <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">else</span>
         <span class="Statement">if</span> proper_grid_func<span class="Special">(</span>EXPR<span class="Special">,</span>is_gf_periodic<span class="Statement">=</span>is_periodic<span class="Special">)</span> <span class="Statement">then</span>
            <span class="Statement">return</span> <span class="Constant">true</span><span class="Special">;</span>
         <span class="Statement">else</span>
            <span class="Statement">return</span> all_true<span class="Special">([</span><span class="Statement">seq</span><span class="Special">(</span>check_validity_d_expr<span class="Special">(</span><span class="Statement">op</span><span class="Special">(</span>ii<span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">,</span>ignore_gf<span class="Special">,</span>is_periodic<span class="Special">)</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>EXPR<span class="Special">))])</span><span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
     <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">############################################</span>

check_grid_func_arg<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

    <span class="Statement">if</span> <span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span> <span class="Statement">in</span> grid_functions  <span class="Statement">then</span>
      <span class="Statement">if</span> strict <span class="Statement">then</span>
           <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;a grid function is detected with invalid arguments in:&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">else</span>
           <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;WARNING:a grid function is detected with invalid arguments, treated as non-grid func:%a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
    <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">#############################################</span>

check_validity_func<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">,</span>variable_set<span class="Special">::</span>set<span class="Special">)</span>

      <span class="Statement">local</span> func<span class="Special">,</span> vars<span class="Special">;</span>

      func<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
      vars<span class="Special">:=</span><span class="Statement">op</span><span class="Special">(</span>EXPR<span class="Special">)</span><span class="Special">;</span>

      <span class="Statement">if</span> func <span class="Statement">in</span> variable_set <span class="Statement">then</span>
          <span class="Statement">if</span> strict <span class="Statement">then</span>
              <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;a function is named same as variables&quot;</span><span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">else</span>
              <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;WARNING: a function is named same as variables, treating as non-grid function %a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
          <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

      <span class="Statement">if</span> <span class="Statement">not</span> <span class="Special">(</span> <span class="Special">{</span>vars<span class="Special">}</span> <span class="Statement">subset</span> variable_set <span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Variable expected to be subset of %a, which is not: %a\n&quot;</span><span class="Special">,</span><span class="Special">{</span>vars<span class="Special">}</span><span class="Special">,</span>variable_set<span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown Error!&quot;</span><span class="Special">)</span><span class="Special">;</span> <span class="Comment"># This is for debugging  </span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

      <span class="Statement">if</span> <span class="Statement">not</span> <span class="Special">(</span> func<span class="Special">(</span>vars<span class="Special">)</span> <span class="Statement">=</span> EXPR <span class="Special">)</span> <span class="Statement">then</span>
         <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;In Gen_Expr_L: f(vars) = %a, EXPR= %a\n&quot;</span><span class="Special">,</span>func<span class="Special">(</span>vars<span class="Special">)</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
         <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unknown Error!&quot;</span><span class="Special">)</span><span class="Special">;</span> <span class="Comment"># This is for debugging </span>
      <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">############################################</span>

check_validity_op<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>EXPR<span class="Special">::</span><span class="Statement">algebraic</span><span class="Special">)</span>

       <span class="Statement">if</span> <span class="Statement">not</span> <span class="Special">(</span><span class="Type">PDEtools</span><span class="Special">[</span>difforder<span class="Special">](</span><span class="Statement">op</span><span class="Special">(</span><span class="Constant">0</span><span class="Special">,</span>EXPR<span class="Special">))</span><span class="Statement">=</span><span class="Constant">0</span> <span class="Special">)</span> <span class="Statement">then</span>
             <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Differential operator is not transformed to diff in: %a\n&quot;</span><span class="Special">,</span>EXPR<span class="Special">)</span><span class="Special">;</span>
             <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Unable to compute FDA&quot;</span><span class="Special">)</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">############################################</span>

check_validity_grid_func_arg<span class="Special">:=</span><span class="Statement">proc</span><span class="Special">(</span>v<span class="Special">::</span>list<span class="Special">,</span>discretized<span class="Special">::</span>boolean<span class="Special">)</span>

   <span class="Statement">global</span> variable_set<span class="Special">;</span>
   <span class="Statement">local</span> sq<span class="Special">,</span>ii<span class="Special">;</span>

   sq<span class="Special">:=</span><span class="Statement">seq</span><span class="Special">(</span>v<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">(</span>v<span class="Special">))</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">({</span>sq<span class="Special">}</span> <span class="Statement">subset</span> variable_set<span class="Special">)</span> <span class="Statement">then</span>
        <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;A grid function is defined for variables: %a, while independet variables are: %a\n&quot;</span><span class="Special">,</span><span class="Special">{</span>sq<span class="Special">}</span><span class="Special">,</span>variable_set<span class="Special">)</span><span class="Special">;</span>
        <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid Argument&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">not</span><span class="Special">(</span>discretized<span class="Special">)</span> <span class="Statement">then</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;***WARNING****: Discrete is called for a grid function, without discretization flag enabled!\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
     <span class="Statement">printf</span><span class="Special">(</span><span class="Constant">&quot;Probably the function is defined as grid function while not requested to be discretized\n&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">##############################################################################</span>
<span class="Comment"># Other utilities</span>
<span class="Comment">##############################################################################</span>

<span class="Comment">#----------------------</span>
<span class="Comment"># Newton Solver</span>
<span class="Comment">#----------------------</span>

Apply_NS <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>NS<span class="Special">::</span>list<span class="Special">(</span><span class="Statement">algebraic</span><span class="Special">)</span> <span class="Special">,</span>  x<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">)</span><span class="Special">,</span> vals<span class="Special">::</span>list<span class="Special">(</span>numeric<span class="Special">)</span> <span class="Special">)</span>

   <span class="Statement">local</span> ii<span class="Special">,</span>N<span class="Special">;</span>
   <span class="Statement">local</span> eq<span class="Special">;</span>
   <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>NS<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>x<span class="Special">)</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid arguments, x and F do not match&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">else</span>
     N<span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>x<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   eq<span class="Special">:=</span><span class="Special">{</span>  <span class="Statement">seq</span><span class="Special">(</span>x<span class="Special">[</span>ii<span class="Special">]</span><span class="Statement">=</span>vals<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)</span>  <span class="Special">}</span><span class="Special">;</span>
   <span class="Statement">return</span> <span class="Special">[</span> <span class="Statement">seq</span><span class="Special">(</span>   <span class="Statement">eval</span><span class="Special">(</span>NS<span class="Special">[</span>ii<span class="Special">]</span> <span class="Special">,</span> eq<span class="Special">)</span>       <span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)</span> <span class="Special">]</span> <span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

Newton_Solver <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>F<span class="Special">::</span>list<span class="Special">(</span><span class="Statement">algebraic</span><span class="Special">)</span><span class="Special">,</span> x<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">))</span>

 <span class="Statement">local</span> IJac<span class="Special">,</span>ii<span class="Special">,</span>jj<span class="Special">;</span>
 <span class="Statement">local</span> ix<span class="Special">,</span>N<span class="Special">;</span>
 ix <span class="Special">:=</span> <span class="Special">NULL</span><span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>F<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>x<span class="Special">)</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid arguments, x and F do not match&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">else</span>
     N<span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>x<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

 IJac<span class="Special">:=</span><span class="Type">linalg</span><span class="Special">[</span>inverse<span class="Special">](</span>Find_Jacobian<span class="Special">(</span>F<span class="Special">,</span>x<span class="Special">))</span><span class="Special">;</span>

 <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> N <span class="Statement">do</span>
     ix <span class="Special">:=</span> ix<span class="Special">,</span> x<span class="Special">[</span>ii<span class="Special">]</span> - <span class="Statement">sum</span><span class="Special">(</span>IJac<span class="Special">[</span>ii<span class="Special">,</span>jj<span class="Special">]</span>*F<span class="Special">[</span>jj<span class="Special">]</span><span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)</span><span class="Special">;</span>
 <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

 <span class="Statement">return</span> <span class="Special">[</span>ix<span class="Special">]</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

Find_Jacobian <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>F<span class="Special">::</span>list<span class="Special">(</span><span class="Statement">algebraic</span><span class="Special">)</span><span class="Special">,</span> x<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">))</span>

   <span class="Statement">local</span> ii<span class="Special">,</span>jj<span class="Special">;</span>
   <span class="Statement">local</span> JK<span class="Special">;</span>
   <span class="Statement">local</span> N<span class="Special">;</span>
   <span class="Statement">local</span> JKM<span class="Special">;</span>

   <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>F<span class="Special">)</span> <span class="Statement">&lt;&gt;</span> <span class="Statement">nops</span><span class="Special">(</span>x<span class="Special">)</span> <span class="Statement">then</span>
      <span class="Statement">error</span><span class="Special">(</span><span class="Constant">&quot;Invalid arguments, x and F do not match&quot;</span><span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">else</span>
     N<span class="Special">:=</span><span class="Statement">nops</span><span class="Special">(</span>x<span class="Special">)</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>

   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> N <span class="Statement">do</span>
      <span class="Statement">for</span> jj <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> N <span class="Statement">do</span>
           JK<span class="Special">[</span>ii<span class="Special">,</span>jj<span class="Special">]</span> <span class="Special">:=</span> <span class="Statement">diff</span><span class="Special">(</span>F<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">,</span>x<span class="Special">[</span>jj<span class="Special">])</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  JKM <span class="Special">:=</span> <span class="Type">linalg</span><span class="Special">[</span><span class="Statement">matrix</span><span class="Special">](</span> <span class="Special">[</span>  <span class="Statement">seq</span><span class="Special">(</span>   <span class="Special">[</span>    <span class="Statement">seq</span><span class="Special">(</span> JK<span class="Special">[</span>ii<span class="Special">,</span>jj<span class="Special">]</span>   <span class="Special">,</span>jj<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)</span>     <span class="Special">]</span>    <span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span>N<span class="Special">)</span>      <span class="Special">])</span><span class="Special">;</span>
  <span class="Statement">return</span> JKM<span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">###########################################################</span>
<span class="Comment"># Returns true only if the list of the boolean is all true</span>
<span class="Comment">###########################################################</span>

all_true <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>a<span class="Special">::</span>list<span class="Special">(</span>boolean<span class="Special">))</span>
   <span class="Statement">local</span> r<span class="Special">;</span>
   <span class="Statement">local</span> ii<span class="Special">;</span>
   <span class="Statement">if</span> <span class="Statement">nops</span><span class="Special">(</span>a<span class="Special">)</span> <span class="Statement">&gt;=</span> <span class="Constant">1</span> <span class="Statement">then</span>
     r<span class="Special">:=</span>a<span class="Special">[</span><span class="Constant">1</span><span class="Special">]</span><span class="Special">;</span>
   <span class="Statement">else</span>
     r<span class="Special">:=</span><span class="Constant">false</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
   <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">2</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>a<span class="Special">)</span> <span class="Statement">do</span>
     r<span class="Special">:=</span> r <span class="Statement">and</span> a<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
   <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
   <span class="Statement">return</span> r<span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">################################</span>
<span class="Comment"># Sorts idx according to s</span>
<span class="Comment">################################</span>
find_sweep_order <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>s<span class="Special">::</span><span class="Statement">table</span><span class="Special">,</span>idx<span class="Special">::</span>list<span class="Special">(</span>symbol<span class="Special">))</span>

      <span class="Statement">local</span> swp<span class="Special">;</span>
      <span class="Statement">local</span> rsx<span class="Special">;</span>
      <span class="Statement">local</span> ts<span class="Special">;</span>
      <span class="Statement">local</span> ii<span class="Special">,</span>mm<span class="Special">;</span>
      rsx<span class="Special">:=</span>idx<span class="Special">;</span>
      swp<span class="Special">:=</span><span class="Constant">1</span><span class="Special">;</span>

      <span class="Statement">for</span> mm <span class="Statement">while</span> <span class="Special">(</span>swp <span class="Statement">=</span> <span class="Constant">1</span><span class="Special">)</span> <span class="Statement">do</span>
       swp<span class="Special">:=</span><span class="Constant">0</span><span class="Special">;</span>
       <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> <span class="Statement">nops</span><span class="Special">(</span>rsx<span class="Special">)</span><span class="Constant">-1</span> <span class="Statement">do</span>
         <span class="Statement">if</span> s<span class="Special">[</span>rsx<span class="Special">[</span>ii<span class="Special">]]</span> <span class="Statement">&gt;</span> s<span class="Special">[</span>rsx<span class="Special">[</span>ii<span class="Constant">+1</span><span class="Special">]]</span> <span class="Statement">then</span>
            swp <span class="Special">:=</span> <span class="Constant">1</span><span class="Special">;</span>
            ts<span class="Special">:=</span>rsx<span class="Special">[</span>ii<span class="Constant">+1</span><span class="Special">]</span><span class="Special">;</span>
            rsx<span class="Special">[</span>ii<span class="Constant">+1</span><span class="Special">]</span> <span class="Special">:=</span> rsx<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">;</span>
            rsx<span class="Special">[</span>ii<span class="Special">]</span><span class="Special">:=</span>ts<span class="Special">;</span>
         <span class="Statement">end</span> <span class="Statement">if</span><span class="Special">;</span>
       <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
      <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>

      <span class="Statement">return</span> rsx<span class="Special">;</span>
<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">########################################</span>
<span class="Comment"># displays a table as a set of equations</span>
<span class="Comment"># ######################################</span>

show_table <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">(</span>t<span class="Special">::</span><span class="Statement">table</span><span class="Special">)</span>

    <span class="Statement">local</span> ii<span class="Special">;</span>
    <span class="Statement">return</span> <span class="Special">{</span><span class="Statement">seq</span><span class="Special">(</span> <span class="Special">[</span><span class="Statement">indices</span><span class="Special">(</span>t<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)][</span>ii<span class="Special">]</span><span class="Statement">=</span><span class="Special">[</span><span class="Statement">entries</span><span class="Special">(</span>t<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)][</span>ii<span class="Special">]</span><span class="Special">,</span>ii<span class="Statement">=</span><span class="Constant">1</span><span class="Statement">..</span><span class="Statement">nops</span><span class="Special">([</span><span class="Statement">indices</span><span class="Special">(</span>t<span class="Special">,</span><span class="Statement">'nolist'</span><span class="Special">)]))</span> <span class="Special">}</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

<span class="Comment">############################</span>
<span class="Comment"># Fortran standard 72 limitation</span>
<span class="Comment">############################</span>

chop_fortran<span class="Special">:=</span> <span class="Statement">proc</span> <span class="Special">(</span>s<span class="Special">::</span>string<span class="Special">)</span>

  <span class="Statement">local</span> strlng<span class="Special">;</span>
  <span class="Statement">local</span> ii<span class="Special">;</span>
  <span class="Statement">local</span> bl<span class="Special">,</span>totline<span class="Special">,</span>nls<span class="Special">,</span>tmp_str<span class="Special">;</span>

  bl<span class="Special">:=</span><span class="Constant">&quot;     &amp;&quot;</span><span class="Special">;</span>
  strlng <span class="Special">:=</span> <span class="Statement">length</span><span class="Special">(</span>s<span class="Special">)</span><span class="Special">;</span>
  totline<span class="Special">:=</span><span class="Statement">iquo</span><span class="Special">(</span>strlng<span class="Constant">-1</span><span class="Special">,</span><span class="Constant">66</span><span class="Special">)</span><span class="Special">;</span>
  nls<span class="Special">:=</span>strlng-totline*<span class="Constant">66</span><span class="Special">;</span>
  tmp_str<span class="Special">:=</span><span class="Constant">&quot;      &quot;</span><span class="Special">;</span>
  <span class="Statement">for</span> ii <span class="Statement">from</span> <span class="Constant">1</span> <span class="Statement">to</span> totline <span class="Statement">do</span>
    tmp_str <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>tmp_str<span class="Special">,</span>s<span class="Special">[</span><span class="Constant">1</span>+<span class="Special">(</span>ii<span class="Constant">-1</span><span class="Special">)</span>*<span class="Constant">66</span><span class="Statement">..</span><span class="Constant">66</span>+<span class="Special">(</span>ii<span class="Constant">-1</span><span class="Special">)</span>*<span class="Constant">66</span><span class="Special">]</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;\n&quot;</span><span class="Special">)</span><span class="Special">,</span>bl<span class="Special">)</span><span class="Special">;</span>
  <span class="Statement">end</span> <span class="Statement">do</span><span class="Special">;</span>
  tmp_str <span class="Special">:=</span> <span class="Statement">cat</span><span class="Special">(</span>tmp_str<span class="Special">,</span>s<span class="Special">[</span>totline*<span class="Constant">66+1</span><span class="Statement">..</span>totline*<span class="Constant">66+1</span>+nls<span class="Special">]</span><span class="Special">,</span><span class="Statement">sprintf</span><span class="Special">(</span><span class="Constant">&quot;\n&quot;</span><span class="Special">))</span><span class="Special">;</span>
  <span class="Statement">return</span> tmp_str<span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


<span class="Comment">##########################</span>
<span class="Comment"># Convenient procs:</span>
<span class="Comment">##########################</span>

SIT<span class="Special">:=</span>Show_Index_Table<span class="Special">;</span>

Show_Index_Table <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

   <span class="Statement">global</span> index_table<span class="Special">;</span>
   <span class="Statement">return</span> show_table<span class="Special">(</span>index_table<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

ST<span class="Special">:=</span>Show_Stens<span class="Special">;</span>

Show_Stens <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

    <span class="Statement">global</span> all_stencils<span class="Special">;</span>
    show_table<span class="Special">(</span>all_stencils<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

SFD<span class="Special">:=</span>Show_FD<span class="Special">;</span>

Show_FD <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

 <span class="Statement">global</span> FD_results<span class="Special">;</span>
 show_table<span class="Special">(</span>FD_results<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

SFDS<span class="Special">:=</span>Show_FDS<span class="Special">;</span>

Show_FDS <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

 <span class="Statement">global</span> FD_symbolics<span class="Special">;</span>
 show_table<span class="Special">(</span>FD_symbolics<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>


SFDT<span class="Special">:=</span>Show_FD_Table<span class="Special">;</span>

Show_FD_Table <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

  <span class="Statement">global</span> FD_table<span class="Special">;</span>
  show_table<span class="Special">(</span>FD_table<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>

SM <span class="Special">:=</span> Show_Mol<span class="Special">;</span>

Show_Mol <span class="Special">:=</span> <span class="Statement">proc</span><span class="Special">()</span>

   <span class="Statement">global</span> mol_struct<span class="Special">;</span>
   show_table<span class="Special">(</span>mol_struct<span class="Special">)</span><span class="Special">;</span>

<span class="Statement">end</span> <span class="Statement">proc</span><span class="Special">;</span>
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
